"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.workerLambdaHandler = void 0;
const mongodb_1 = require("./mongodb");
const aws_sdk_1 = require("aws-sdk");
// Handler
const workerLambdaHandler = async (event, context) => {
    var _a, _b;
    console.log('## ENVIRONMENT VARIABLES: ' + serialize(process.env));
    console.log('## EVENT: ' + serialize(event));
    //Fetch Configuration
    const configDB = new mongodb_1.KPASpectrumConfigurationDB();
    let configs = await configDB.getConfiguration();
    const sqsInstance = new aws_sdk_1.SQS({
        accessKeyId: process.env.AWS_ACCESS_KEY,
        secretAccessKey: process.env.AWS_SECRET_KEY,
        region: process.env.AWS_REGION
    });
    for (var config of configs) {
        if (!config.active) {
            continue;
        }
        console.log(`Execute Spectrum Customer: ${config.kpaSite} ${config.companyCode} Start`);
        if (config.isSyncUser) {
            const sqsUserPayload = {
                DelaySeconds: 0,
                MessageBody: `User Integration - ${config.kpaSite}`,
                QueueUrl: (_a = process.env.AWS_SQS_SPECTRUM_USER_URL) !== null && _a !== void 0 ? _a : '',
                MessageAttributes: {
                    'serverUrl': {
                        StringValue: config.serverUrl,
                        DataType: 'String'
                    },
                    'companyCode': {
                        StringValue: config.companyCode,
                        DataType: 'String'
                    },
                    'authorizationId': {
                        StringValue: config.authorizationId,
                        DataType: 'String'
                    },
                    'isEditUser': {
                        StringValue: config.isEditUser ? '1' : '0',
                        DataType: 'String'
                    },
                    'kpaSite': {
                        StringValue: config.kpaSite,
                        DataType: 'String'
                    },
                    'kpaToken': {
                        StringValue: config.kpaToken,
                        DataType: 'String'
                    },
                    'defaultRole': {
                        StringValue: config.defaultRole,
                        DataType: 'String'
                    },
                    'welcomeEmail': {
                        StringValue: config.isWelcomeEmail ? '1' : '0',
                        DataType: 'String'
                    },
                    'resetPassword': {
                        StringValue: config.isForceResetPassword ? '1' : '0',
                        DataType: 'String'
                    }
                },
            };
            const userPromise = await new Promise((resolve, reject) => {
                sqsInstance.sendMessage(sqsUserPayload, (err, data) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
            console.log(userPromise);
        }
        if (config.isSyncProject) {
            const sqsProjectPayload = {
                DelaySeconds: 0,
                MessageBody: `Project Integration - ${config.kpaSite}`,
                QueueUrl: (_b = process.env.AWS_SQS_SPECTRUM_PROJECT_URL) !== null && _b !== void 0 ? _b : '',
                MessageAttributes: {
                    'serverUrl': {
                        StringValue: config.serverUrl,
                        DataType: 'String'
                    },
                    'companyCode': {
                        StringValue: config.companyCode,
                        DataType: 'String'
                    },
                    'authorizationId': {
                        StringValue: config.authorizationId,
                        DataType: 'String'
                    },
                    'isEditProject': {
                        StringValue: config.isEditProject ? '1' : '0',
                        DataType: 'String'
                    },
                    'kpaSite': {
                        StringValue: config.kpaSite,
                        DataType: 'String'
                    },
                    'kpaToken': {
                        StringValue: config.kpaToken,
                        DataType: 'String'
                    }
                },
            };
            const projectPromise = await new Promise((resolve, reject) => {
                sqsInstance.sendMessage(sqsProjectPayload, (err, data) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
            console.log(projectPromise);
        }
        console.log(`Execute Spectrum Customer Done`);
    }
    const response = {
        "statusCode": 200,
        "source": "Spectrum Worker Integration",
        "body": {},
    };
    console.log(`Execute Spectrum Done`);
    return response;
};
exports.workerLambdaHandler = workerLambdaHandler;
var serialize = function (object) {
    return JSON.stringify(object, null, 2);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0td29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3BlY3RydW0taW50ZWdyYXRpb24vZnVuY3Rpb24vc3BlY3RydW0td29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHVDQUF1RDtBQUN2RCxxQ0FBd0M7QUFFeEMsVUFBVTtBQUNILE1BQU0sbUJBQW1CLEdBQWEsS0FBSyxFQUFFLEtBQVUsRUFBRSxPQUFnQixFQUFFLEVBQUU7O0lBQ2hGLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQ2xFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBRTVDLHFCQUFxQjtJQUNyQixNQUFNLFFBQVEsR0FBRyxJQUFJLG9DQUEwQixFQUFFLENBQUM7SUFDbEQsSUFBSSxPQUFPLEdBQUcsTUFBTSxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUVoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLGFBQUcsQ0FBQztRQUN4QixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1FBQ3ZDLGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWM7UUFDM0MsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtLQUNqQyxDQUFDLENBQUM7SUFFSCxLQUFJLElBQUksTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsU0FBUztRQUNiLENBQUM7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixNQUFNLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxXQUFXLFFBQVEsQ0FBQyxDQUFDO1FBRXhGLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lB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LE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFBO0FBQ3hDLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbnRleHQsIEhhbmRsZXIgfSBmcm9tIFwiYXdzLWxhbWJkYVwiO1xuaW1wb3J0IHsgS1BBU3BlY3RydW1Db25maWd1cmF0aW9uREIgfSBmcm9tIFwiLi9tb25nb2RiXCI7XG5pbXBvcnQgeyBBV1NFcnJvciwgU1FTIH0gZnJvbSBcImF3cy1zZGtcIjtcblxuLy8gSGFuZGxlclxuZXhwb3J0IGNvbnN0IHdvcmtlckxhbWJkYUhhbmRsZXIgOiBIYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnksIGNvbnRleHQ6IENvbnRleHQpID0+IHtcbiAgICBjb25zb2xlLmxvZygnIyMgRU5WSVJPTk1FTlQgVkFSSUFCTEVTOiAnICsgc2VyaWFsaXplKHByb2Nlc3MuZW52KSlcbiAgICBjb25zb2xlLmxvZygnIyMgRVZFTlQ6ICcgKyBzZXJpYWxpemUoZXZlbnQpKVxuXG4gICAgLy9GZXRjaCBDb25maWd1cmF0aW9uXG4gICAgY29uc3QgY29uZmlnREIgPSBuZXcgS1BBU3BlY3RydW1Db25maWd1cmF0aW9uREIoKTtcbiAgICBsZXQgY29uZmlncyA9IGF3YWl0IGNvbmZpZ0RCLmdldENvbmZpZ3VyYXRpb24oKTtcblxuICAgIGNvbnN0IHNxc0luc3RhbmNlID0gbmV3IFNRUyh7XG4gICAgICAgIGFjY2Vzc0tleUlkOiBwcm9jZXNzLmVudi5BV1NfQUNDRVNTX0tFWSxcbiAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0tFWSxcbiAgICAgICAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OXG4gICAgfSk7XG5cbiAgICBmb3IodmFyIGNvbmZpZyBvZiBjb25maWdzKSB7XG4gICAgICAgIGlmICghY29uZmlnLmFjdGl2ZSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coYEV4ZWN1dGUgU3BlY3RydW0gQ3VzdG9tZXI6ICR7Y29uZmlnLmtwYVNpdGV9ICR7Y29uZmlnLmNvbXBhbnlDb2RlfSBTdGFydGApO1xuXG4gICAgICAgIGlmIChjb25maWcuaXNTeW5jVXNlcikge1xuICAgICAgICAgICAgY29uc3Qgc3FzVXNlclBheWxvYWQgOiBTUVMuU2VuZE1lc3NhZ2VSZXF1ZXN0PSB7XG4gICAgICAgICAgICAgICAgRGVsYXlTZWNvbmRzOiAwLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VCb2R5OiBgVXNlciBJbnRlZ3JhdGlvbiAtICR7Y29uZmlnLmtwYVNpdGV9YCxcbiAgICAgICAgICAgICAgICBRdWV1ZVVybDogcHJvY2Vzcy5lbnYuQVdTX1NRU19TUEVDVFJVTV9VU0VSX1VSTCA/PyAnJyxcbiAgICAgICAgICAgICAgICBNZXNzYWdlQXR0cmlidXRlczoge1xuICAgICAgICAgICAgICAgICAgICAnc2VydmVyVXJsJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5zZXJ2ZXJVcmwsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2NvbXBhbnlDb2RlJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5jb21wYW55Q29kZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnYXV0aG9yaXphdGlvbklkJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5hdXRob3JpemF0aW9uSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2lzRWRpdFVzZXInOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmlzRWRpdFVzZXIgPyAnMScgOiAnMCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2twYVNpdGUnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmtwYVNpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2twYVRva2VuJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5rcGFUb2tlbixcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnZGVmYXVsdFJvbGUnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmRlZmF1bHRSb2xlLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICd3ZWxjb21lRW1haWwnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmlzV2VsY29tZUVtYWlsID8gJzEnIDogJzAnLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdyZXNldFBhc3N3b3JkJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5pc0ZvcmNlUmVzZXRQYXNzd29yZCA/ICcxJyA6ICcwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgdXNlclByb21pc2UgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgc3FzSW5zdGFuY2Uuc2VuZE1lc3NhZ2Uoc3FzVXNlclBheWxvYWQsIChlcnI6IEFXU0Vycm9yLCBkYXRhOiBTUVMuU2VuZE1lc3NhZ2VSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgY29uc29sZS5sb2codXNlclByb21pc2UpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZmlnLmlzU3luY1Byb2plY3QpIHtcbiAgICAgICAgICAgIGNvbnN0IHNxc1Byb2plY3RQYXlsb2FkIDogU1FTLlNlbmRNZXNzYWdlUmVxdWVzdD0ge1xuICAgICAgICAgICAgICAgIERlbGF5U2Vjb25kczogMCxcbiAgICAgICAgICAgICAgICBNZXNzYWdlQm9keTogYFByb2plY3QgSW50ZWdyYXRpb24gLSAke2NvbmZpZy5rcGFTaXRlfWAsXG4gICAgICAgICAgICAgICAgUXVldWVVcmw6IHByb2Nlc3MuZW52LkFXU19TUVNfU1BFQ1RSVU1fUFJPSkVDVF9VUkwgPz8gJycsXG4gICAgICAgICAgICAgICAgTWVzc2FnZUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgJ3NlcnZlclVybCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuc2VydmVyVXJsLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdjb21wYW55Q29kZSc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuY29tcGFueUNvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2F1dGhvcml6YXRpb25JZCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuYXV0aG9yaXphdGlvbklkLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdpc0VkaXRQcm9qZWN0Jzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5pc0VkaXRQcm9qZWN0ID8gJzEnIDogJzAnLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdrcGFTaXRlJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5rcGFTaXRlLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdrcGFUb2tlbic6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcua3BhVG9rZW4sXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHByb2plY3RQcm9taXNlID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgIHNxc0luc3RhbmNlLnNlbmRNZXNzYWdlKHNxc1Byb2plY3RQYXlsb2FkLCAoZXJyOiBBV1NFcnJvciwgZGF0YTogU1FTLlNlbmRNZXNzYWdlUmVzdWx0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdChlcnIpXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGRhdGEpXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc29sZS5sb2cocHJvamVjdFByb21pc2UpXG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmxvZyhgRXhlY3V0ZSBTcGVjdHJ1bSBDdXN0b21lciBEb25lYCk7XG4gICAgfVxuICBcbiAgICBjb25zdCByZXNwb25zZSA9IHtcbiAgICAgICAgXCJzdGF0dXNDb2RlXCI6IDIwMCxcbiAgICAgICAgXCJzb3VyY2VcIjogXCJTcGVjdHJ1bSBXb3JrZXIgSW50ZWdyYXRpb25cIixcbiAgICAgICAgXCJib2R5XCI6IHt9LFxuICAgIH1cbiAgXG4gICAgY29uc29sZS5sb2coYEV4ZWN1dGUgU3BlY3RydW0gRG9uZWApO1xuICAgIHJldHVybiByZXNwb25zZVxufVxuXG52YXIgc2VyaWFsaXplID0gZnVuY3Rpb24ob2JqZWN0OiBhbnkpIHtcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iamVjdCwgbnVsbCwgMilcbn1cbiJdfQ==