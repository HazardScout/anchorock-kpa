"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.workerLambdaHandler = void 0;
const mongodb_1 = require("./mongodb");
const aws_sdk_1 = require("aws-sdk");
// Handler
const workerLambdaHandler = async (event, context) => {
    var _a, _b;
    console.log('## ENVIRONMENT VARIABLES: ' + serialize(process.env));
    console.log('## EVENT: ' + serialize(event));
    //Fetch Configuration
    const configDB = new mongodb_1.KPASpectrumConfigurationDB();
    let configs = await configDB.getConfiguration();
    const sqsInstance = new aws_sdk_1.SQS({
        accessKeyId: process.env.AWS_ACCESS_KEY,
        secretAccessKey: process.env.AWS_SECRET_KEY,
        region: process.env.AWS_REGION
    });
    for (var config of configs) {
        if (!config.active) {
            continue;
        }
        console.log(`Execute Spectrum Customer: ${config.kpaSite} ${config.companyCodes} Start`);
        if (config.isSyncUser) {
            const sqsUserPayload = {
                DelaySeconds: 0,
                MessageBody: `User Integration - ${config.kpaSite}`,
                QueueUrl: (_a = process.env.AWS_SQS_SPECTRUM_USER_URL) !== null && _a !== void 0 ? _a : '',
                MessageAttributes: {
                    'serverUrl': {
                        StringValue: `${config.spectrumUrl}:${config.spectrumPort}`,
                        DataType: 'String'
                    },
                    'companyCodes': {
                        StringListValues: config.companyCodes,
                        DataType: 'String'
                    },
                    'authorizationId': {
                        StringValue: config.authorizationId,
                        DataType: 'String'
                    },
                    'isEditUser': {
                        StringValue: config.isEditUser ? '1' : '0',
                        DataType: 'String'
                    },
                    'kpaSite': {
                        StringValue: config.kpaSite,
                        DataType: 'String'
                    },
                    'kpaToken': {
                        StringValue: config.kpaToken,
                        DataType: 'String'
                    },
                    'defaultRole': {
                        StringValue: config.defaultRole,
                        DataType: 'String'
                    },
                    'welcomeEmail': {
                        StringValue: config.isWelcomeEmail ? '1' : '0',
                        DataType: 'String'
                    },
                    'resetPassword': {
                        StringValue: config.isForceResetPassword ? '1' : '0',
                        DataType: 'String'
                    }
                },
            };
            const userPromise = await new Promise((resolve, reject) => {
                sqsInstance.sendMessage(sqsUserPayload, (err, data) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
            console.log(userPromise);
        }
        if (config.isSyncProject) {
            const sqsProjectPayload = {
                DelaySeconds: 0,
                MessageBody: `Project Integration - ${config.kpaSite}`,
                QueueUrl: (_b = process.env.AWS_SQS_SPECTRUM_PROJECT_URL) !== null && _b !== void 0 ? _b : '',
                MessageAttributes: {
                    'serverUrl': {
                        StringValue: `${config.spectrumUrl}:${config.spectrumPort}`,
                        DataType: 'String'
                    },
                    'companyCodes': {
                        StringListValues: config.companyCodes,
                        DataType: 'String'
                    },
                    'authorizationId': {
                        StringValue: config.authorizationId,
                        DataType: 'String'
                    },
                    'isEditProject': {
                        StringValue: config.isEditProject ? '1' : '0',
                        DataType: 'String'
                    },
                    'kpaSite': {
                        StringValue: config.kpaSite,
                        DataType: 'String'
                    },
                    'kpaToken': {
                        StringValue: config.kpaToken,
                        DataType: 'String'
                    }
                },
            };
            const projectPromise = await new Promise((resolve, reject) => {
                sqsInstance.sendMessage(sqsProjectPayload, (err, data) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
            console.log(projectPromise);
        }
        console.log(`Execute Spectrum Customer Done`);
    }
    const response = {
        "statusCode": 200,
        "source": "Spectrum Worker Integration",
        "body": {},
    };
    console.log(`Execute Spectrum Done`);
    return response;
};
exports.workerLambdaHandler = workerLambdaHandler;
var serialize = function (object) {
    return JSON.stringify(object, null, 2);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0td29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3BlY3RydW0taW50ZWdyYXRpb24vZnVuY3Rpb24vc3BlY3RydW0td29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHVDQUF1RDtBQUN2RCxxQ0FBd0M7QUFFeEMsVUFBVTtBQUNILE1BQU0sbUJBQW1CLEdBQWEsS0FBSyxFQUFFLEtBQVUsRUFBRSxPQUFnQixFQUFFLEVBQUU7O0lBQ2hGLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQ2xFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBRTVDLHFCQUFxQjtJQUNyQixNQUFNLFFBQVEsR0FBRyxJQUFJLG9DQUEwQixFQUFFLENBQUM7SUFDbEQsSUFBSSxPQUFPLEdBQUcsTUFBTSxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUVoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLGFBQUcsQ0FBQztRQUN4QixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1FBQ3ZDLGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWM7UUFDM0MsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtLQUNqQyxDQUFDLENBQUM7SUFFSCxLQUFJLElBQUksTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsU0FBUztRQUNiLENBQUM7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixNQUFNLENBQUMsT0FBTyxJQUFJLE1BQU0sQ0FBQyxZQUFZLFFBQVEsQ0FBQyxDQUFDO1FBRXpGLElBQUksTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lB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QUE7QUF0SVksUUFBQSxtQkFBbUIsdUJBc0kvQjtBQUVELElBQUksU0FBUyxHQUFHLFVBQVMsTUFBVztJQUNsQyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUN4QyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb250ZXh0LCBIYW5kbGVyIH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEtQQVNwZWN0cnVtQ29uZmlndXJhdGlvbkRCIH0gZnJvbSBcIi4vbW9uZ29kYlwiO1xuaW1wb3J0IHsgQVdTRXJyb3IsIFNRUyB9IGZyb20gXCJhd3Mtc2RrXCI7XG5cbi8vIEhhbmRsZXJcbmV4cG9ydCBjb25zdCB3b3JrZXJMYW1iZGFIYW5kbGVyIDogSGFuZGxlciA9IGFzeW5jIChldmVudDogYW55LCBjb250ZXh0OiBDb250ZXh0KSA9PiB7XG4gICAgY29uc29sZS5sb2coJyMjIEVOVklST05NRU5UIFZBUklBQkxFUzogJyArIHNlcmlhbGl6ZShwcm9jZXNzLmVudikpXG4gICAgY29uc29sZS5sb2coJyMjIEVWRU5UOiAnICsgc2VyaWFsaXplKGV2ZW50KSlcblxuICAgIC8vRmV0Y2ggQ29uZmlndXJhdGlvblxuICAgIGNvbnN0IGNvbmZpZ0RCID0gbmV3IEtQQVNwZWN0cnVtQ29uZmlndXJhdGlvbkRCKCk7XG4gICAgbGV0IGNvbmZpZ3MgPSBhd2FpdCBjb25maWdEQi5nZXRDb25maWd1cmF0aW9uKCk7XG5cbiAgICBjb25zdCBzcXNJbnN0YW5jZSA9IG5ldyBTUVMoe1xuICAgICAgICBhY2Nlc3NLZXlJZDogcHJvY2Vzcy5lbnYuQVdTX0FDQ0VTU19LRVksXG4gICAgICAgIHNlY3JldEFjY2Vzc0tleTogcHJvY2Vzcy5lbnYuQVdTX1NFQ1JFVF9LRVksXG4gICAgICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQVdTX1JFR0lPTlxuICAgIH0pO1xuXG4gICAgZm9yKHZhciBjb25maWcgb2YgY29uZmlncykge1xuICAgICAgICBpZiAoIWNvbmZpZy5hY3RpdmUpIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKGBFeGVjdXRlIFNwZWN0cnVtIEN1c3RvbWVyOiAke2NvbmZpZy5rcGFTaXRlfSAke2NvbmZpZy5jb21wYW55Q29kZXN9IFN0YXJ0YCk7XG5cbiAgICAgICAgaWYgKGNvbmZpZy5pc1N5bmNVc2VyKSB7XG4gICAgICAgICAgICBjb25zdCBzcXNVc2VyUGF5bG9hZCA6IFNRUy5TZW5kTWVzc2FnZVJlcXVlc3Q9IHtcbiAgICAgICAgICAgICAgICBEZWxheVNlY29uZHM6IDAsXG4gICAgICAgICAgICAgICAgTWVzc2FnZUJvZHk6IGBVc2VyIEludGVncmF0aW9uIC0gJHtjb25maWcua3BhU2l0ZX1gLFxuICAgICAgICAgICAgICAgIFF1ZXVlVXJsOiBwcm9jZXNzLmVudi5BV1NfU1FTX1NQRUNUUlVNX1VTRVJfVVJMID8/ICcnLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgICAgICdzZXJ2ZXJVcmwnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogYCR7Y29uZmlnLnNwZWN0cnVtVXJsfToke2NvbmZpZy5zcGVjdHJ1bVBvcnR9YCxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnY29tcGFueUNvZGVzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nTGlzdFZhbHVlczogY29uZmlnLmNvbXBhbnlDb2RlcyxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnYXV0aG9yaXphdGlvbklkJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5hdXRob3JpemF0aW9uSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2lzRWRpdFVzZXInOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmlzRWRpdFVzZXIgPyAnMScgOiAnMCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2twYVNpdGUnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmtwYVNpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2twYVRva2VuJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5rcGFUb2tlbixcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnZGVmYXVsdFJvbGUnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmRlZmF1bHRSb2xlLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICd3ZWxjb21lRW1haWwnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmlzV2VsY29tZUVtYWlsID8gJzEnIDogJzAnLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdyZXNldFBhc3N3b3JkJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5pc0ZvcmNlUmVzZXRQYXNzd29yZCA/ICcxJyA6ICcwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgdXNlclByb21pc2UgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgc3FzSW5zdGFuY2Uuc2VuZE1lc3NhZ2Uoc3FzVXNlclBheWxvYWQsIChlcnI6IEFXU0Vycm9yLCBkYXRhOiBTUVMuU2VuZE1lc3NhZ2VSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgY29uc29sZS5sb2codXNlclByb21pc2UpXG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY29uZmlnLmlzU3luY1Byb2plY3QpIHtcbiAgICAgICAgICAgIGNvbnN0IHNxc1Byb2plY3RQYXlsb2FkIDogU1FTLlNlbmRNZXNzYWdlUmVxdWVzdD0ge1xuICAgICAgICAgICAgICAgIERlbGF5U2Vjb25kczogMCxcbiAgICAgICAgICAgICAgICBNZXNzYWdlQm9keTogYFByb2plY3QgSW50ZWdyYXRpb24gLSAke2NvbmZpZy5rcGFTaXRlfWAsXG4gICAgICAgICAgICAgICAgUXVldWVVcmw6IHByb2Nlc3MuZW52LkFXU19TUVNfU1BFQ1RSVU1fUFJPSkVDVF9VUkwgPz8gJycsXG4gICAgICAgICAgICAgICAgTWVzc2FnZUF0dHJpYnV0ZXM6IHtcbiAgICAgICAgICAgICAgICAgICAgJ3NlcnZlclVybCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBgJHtjb25maWcuc3BlY3RydW1Vcmx9OiR7Y29uZmlnLnNwZWN0cnVtUG9ydH1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdjb21wYW55Q29kZXMnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdMaXN0VmFsdWVzOiBjb25maWcuY29tcGFueUNvZGVzLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdhdXRob3JpemF0aW9uSWQnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmF1dGhvcml6YXRpb25JZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnaXNFZGl0UHJvamVjdCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuaXNFZGl0UHJvamVjdCA/ICcxJyA6ICcwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAna3BhU2l0ZSc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcua3BhU2l0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAna3BhVG9rZW4nOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmtwYVRva2VuLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBwcm9qZWN0UHJvbWlzZSA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBzcXNJbnN0YW5jZS5zZW5kTWVzc2FnZShzcXNQcm9qZWN0UGF5bG9hZCwgKGVycjogQVdTRXJyb3IsIGRhdGE6IFNRUy5TZW5kTWVzc2FnZVJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHByb2plY3RQcm9taXNlKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc29sZS5sb2coYEV4ZWN1dGUgU3BlY3RydW0gQ3VzdG9tZXIgRG9uZWApO1xuICAgIH1cbiAgXG4gICAgY29uc3QgcmVzcG9uc2UgPSB7XG4gICAgICAgIFwic3RhdHVzQ29kZVwiOiAyMDAsXG4gICAgICAgIFwic291cmNlXCI6IFwiU3BlY3RydW0gV29ya2VyIEludGVncmF0aW9uXCIsXG4gICAgICAgIFwiYm9keVwiOiB7fSxcbiAgICB9XG4gIFxuICAgIGNvbnNvbGUubG9nKGBFeGVjdXRlIFNwZWN0cnVtIERvbmVgKTtcbiAgICByZXR1cm4gcmVzcG9uc2Vcbn1cblxudmFyIHNlcmlhbGl6ZSA9IGZ1bmN0aW9uKG9iamVjdDogYW55KSB7XG4gIHJldHVybiBKU09OLnN0cmluZ2lmeShvYmplY3QsIG51bGwsIDIpXG59XG4iXX0=