"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumUserJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const model_1 = require("../../../base-integration/src/model");
const api_2 = require("../api");
const util_1 = require("util");
class SpectrumUserJob {
    constructor(config) {
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.name = 'Spectrum User Job - ' + this.kpaSite;
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCodes = JSON.parse(config["companyCodes"]["stringValue"]);
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditUser = config["isEditUser"]["stringValue"] == '1';
        this.defaultRole = config["defaultRole"]["stringValue"];
        this.welcomeEmail = config["welcomeEmail"]["stringValue"] === '1';
        this.resetPassword = config["resetPassword"]["stringValue"] === '1';
    }
    async execute(status) {
        (0, util_1.debuglog)('log:spectrum:user')("Execute SpectrumUserJob Start");
        //Fetch KPA Users
        let kpaUserAPI = new api_1.KPAUserAPI(this.kpaToken);
        let kpaExistUsers = await kpaUserAPI.getAllUser();
        status.totalExistingRecord = kpaExistUsers.length;
        (0, util_1.debuglog)('log:spectrum:user')(JSON.stringify(kpaExistUsers, null, 2));
        let kpaUsers = [];
        for (var companyCode of this.companyCodes) {
            //Fetch Spectrum Users
            let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, companyCode);
            // Get Active Users
            let users = await spectrumAPI.getUsers('A');
            // Get Inactive Users
            let inactiveUsers = await spectrumAPI.getUsers('I');
            // Append all users
            users = users.concat(inactiveUsers);
            status.totalSourceRecord = users.length;
            //Loop Spectrum Users
            for (let user of users) {
                var kpaUser = null;
                for (let i = 0; i < kpaExistUsers.length; i++) {
                    const kpaExistUser = kpaExistUsers[i];
                    const employeeCode = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                    if (kpaExistUser.employeeNumber === employeeCode) {
                        kpaUser = kpaExistUser;
                        kpaExistUsers.splice(i, 1);
                        break;
                    }
                }
                //Build KPA user Data and Check existing
                if (kpaUser == null) {
                    kpaUser = new model_1.KPAUserModel();
                    if (user.employeeStatus !== 'A') {
                        status.skippedRecord++;
                        continue;
                    }
                }
                else {
                    if (!this.isEditUser) {
                        status.skippedRecord++;
                        continue;
                    }
                    if (user.employeeStatus !== 'A') {
                        status.inactivatedRecord++;
                    }
                }
                //Create Users
                kpaUser.employeeNumber = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                kpaUser.firstName = user.firstName;
                kpaUser.lastName = user.lastName;
                kpaUser.username = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                kpaUser.email = '';
                kpaUser.initialPassword = `KPAFlex2024!!`;
                kpaUser.role = this.defaultRole;
                kpaUser.title = user.title;
                kpaUser.welcomeEmail = this.welcomeEmail;
                kpaUser.resetPassword = this.resetPassword;
                if (user.employeeStatus !== 'A' && kpaUser.terminationDate == null) {
                    kpaUser.terminationDate = new Date().toDateString();
                    (0, util_1.debuglog)('log:spectrum:user')(`Need to Check ${kpaUser.terminationDate}`);
                }
                //Add User To List
                kpaUsers.push(kpaUser);
                status.upsertRecord++;
            }
        }
        //Send Data
        (0, util_1.debuglog)('log:spectrum:user')(String(kpaUsers.length));
        const success = await kpaUserAPI.saveUser(this.kpaSite, kpaUsers, this.isEditUser);
        if (!success) {
            throw new Error('Failed to save Users:' + this.config.kpaSite);
        }
        (0, util_1.debuglog)('log:spectrum:user')("Execute SpectrumUserJob Done");
    }
}
exports.SpectrumUserJob = SpectrumUserJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tdXNlci1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tdXNlci1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQStEO0FBRS9ELCtEQUFtRTtBQUNuRSxnQ0FBcUM7QUFDckMsK0JBQWdDO0FBRWhDLE1BQWEsZUFBZTtJQWF4QixZQUFZLE1BQVc7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLElBQUksR0FBRyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQztRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENB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UUFDWCxJQUFBLGVBQVEsRUFBQyxtQkFBbUIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQTtRQUN0RCxNQUFNLE9BQU8sR0FBRyxNQUFNLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1FBQ2xGLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuRSxDQUFDO1FBQ0QsSUFBQSxlQUFRLEVBQUMsbUJBQW1CLENBQUMsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7Q0FFSjtBQWpIRCwwQ0FpSEMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBLUEFVc2VyQVBJIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2FwaVwiO1xuaW1wb3J0IHsgSUpvYiwgSm9iU3RhdHVzIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2pvYlwiO1xuaW1wb3J0IHsgS1BBVXNlck1vZGVsIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL21vZGVsXCI7XG5pbXBvcnQgeyBTcGVjdHJ1bUFQSSB9IGZyb20gXCIuLi9hcGlcIjtcbmltcG9ydCB7IGRlYnVnbG9nIH0gZnJvbSAndXRpbCc7XG5cbmV4cG9ydCBjbGFzcyBTcGVjdHJ1bVVzZXJKb2IgaW1wbGVtZW50cyBJSm9iIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAga3BhU2l0ZTogc3RyaW5nO1xuICAgIGtwYVRva2VuOiBzdHJpbmc7XG4gICAgc2VydmVyVXJsOiBzdHJpbmc7XG4gICAgY29tcGFueUNvZGVzOiBzdHJpbmdbXTtcbiAgICBhdXRob3JpemF0aW9uSWQ6IHN0cmluZztcbiAgICBpc0VkaXRVc2VyOiBib29sZWFuO1xuICAgIGNvbmZpZzogYW55O1xuICAgIGRlZmF1bHRSb2xlOiBzdHJpbmc7XG4gICAgd2VsY29tZUVtYWlsOiBib29sZWFuO1xuICAgIHJlc2V0UGFzc3dvcmQ6IGJvb2xlYW47XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IGFueSkge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmtwYVNpdGUgPSBjb25maWdbXCJrcGFTaXRlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMubmFtZSA9ICdTcGVjdHJ1bSBVc2VyIEpvYiAtICcgKyB0aGlzLmtwYVNpdGU7XG4gICAgICAgIHRoaXMua3BhVG9rZW4gPSBjb25maWdbXCJrcGFUb2tlblwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLnNlcnZlclVybCA9IGNvbmZpZ1tcInNlcnZlclVybFwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmNvbXBhbnlDb2RlcyA9IEpTT04ucGFyc2UoY29uZmlnW1wiY29tcGFueUNvZGVzXCJdW1wic3RyaW5nVmFsdWVcIl0pO1xuICAgICAgICB0aGlzLmF1dGhvcml6YXRpb25JZCA9IGNvbmZpZ1tcImF1dGhvcml6YXRpb25JZFwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmlzRWRpdFVzZXIgPSBjb25maWdbXCJpc0VkaXRVc2VyXCJdW1wic3RyaW5nVmFsdWVcIl0gPT0gJzEnO1xuICAgICAgICB0aGlzLmRlZmF1bHRSb2xlID0gY29uZmlnW1wiZGVmYXVsdFJvbGVcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy53ZWxjb21lRW1haWwgPSBjb25maWdbXCJ3ZWxjb21lRW1haWxcIl1bXCJzdHJpbmdWYWx1ZVwiXSA9PT0gJzEnO1xuICAgICAgICB0aGlzLnJlc2V0UGFzc3dvcmQgPSBjb25maWdbXCJyZXNldFBhc3N3b3JkXCJdW1wic3RyaW5nVmFsdWVcIl0gPT09ICcxJztcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlKHN0YXR1czogSm9iU3RhdHVzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGRlYnVnbG9nKCdsb2c6c3BlY3RydW06dXNlcicpKFwiRXhlY3V0ZSBTcGVjdHJ1bVVzZXJKb2IgU3RhcnRcIik7XG4gICAgICAgIC8vRmV0Y2ggS1BBIFVzZXJzXG4gICAgICAgIGxldCBrcGFVc2VyQVBJID0gbmV3IEtQQVVzZXJBUEkodGhpcy5rcGFUb2tlbik7XG4gICAgICAgIGxldCBrcGFFeGlzdFVzZXJzID0gYXdhaXQga3BhVXNlckFQSS5nZXRBbGxVc2VyKCk7XG4gICAgICAgIHN0YXR1cy50b3RhbEV4aXN0aW5nUmVjb3JkID0ga3BhRXhpc3RVc2Vycy5sZW5ndGg7XG4gICAgICAgIGRlYnVnbG9nKCdsb2c6c3BlY3RydW06dXNlcicpKEpTT04uc3RyaW5naWZ5KGtwYUV4aXN0VXNlcnMsIG51bGwsIDIpKTtcblxuICAgICAgICBsZXQga3BhVXNlcnMgOiBLUEFVc2VyTW9kZWxbXSA9IFtdO1xuICAgICAgICBmb3IgKHZhciBjb21wYW55Q29kZSBvZiB0aGlzLmNvbXBhbnlDb2Rlcykge1xuICAgICAgICAgICAgLy9GZXRjaCBTcGVjdHJ1bSBVc2Vyc1xuICAgICAgICAgICAgbGV0IHNwZWN0cnVtQVBJID0gbmV3IFNwZWN0cnVtQVBJKHRoaXMuc2VydmVyVXJsLCB0aGlzLmF1dGhvcml6YXRpb25JZCwgY29tcGFueUNvZGUpO1xuICAgICAgICAgICAgLy8gR2V0IEFjdGl2ZSBVc2Vyc1xuICAgICAgICAgICAgbGV0IHVzZXJzID0gYXdhaXQgc3BlY3RydW1BUEkuZ2V0VXNlcnMoJ0EnKTtcbiAgICAgICAgICAgIC8vIEdldCBJbmFjdGl2ZSBVc2Vyc1xuICAgICAgICAgICAgbGV0IGluYWN0aXZlVXNlcnMgPSBhd2FpdCBzcGVjdHJ1bUFQSS5nZXRVc2VycygnSScpO1xuXG4gICAgICAgICAgICAvLyBBcHBlbmQgYWxsIHVzZXJzXG4gICAgICAgICAgICB1c2VycyA9IHVzZXJzLmNvbmNhdChpbmFjdGl2ZVVzZXJzKTtcblxuICAgICAgICAgICAgc3RhdHVzLnRvdGFsU291cmNlUmVjb3JkID0gdXNlcnMubGVuZ3RoXG5cbiAgICAgICAgICAgIC8vTG9vcCBTcGVjdHJ1bSBVc2Vyc1xuICAgICAgICAgICAgZm9yKGxldCB1c2VyIG9mIHVzZXJzKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtwYVVzZXIgOiBLUEFVc2VyTW9kZWwgfCBudWxsID0gbnVsbDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtwYUV4aXN0VXNlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga3BhRXhpc3RVc2VyID0ga3BhRXhpc3RVc2Vyc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW1wbG95ZWVDb2RlID0gYCR7Y29tcGFueUNvZGUudHJpbSgpfS0ke3VzZXIuZW1wbG95ZWVDb2RlLnRyaW0oKX1gO1xuICAgICAgICAgICAgICAgICAgICBpZiAoa3BhRXhpc3RVc2VyLmVtcGxveWVlTnVtYmVyID09PSBlbXBsb3llZUNvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVVzZXIgPSBrcGFFeGlzdFVzZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICBrcGFFeGlzdFVzZXJzLnNwbGljZShpLDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0J1aWxkIEtQQSB1c2VyIERhdGEgYW5kIENoZWNrIGV4aXN0aW5nXG4gICAgICAgICAgICAgICAgaWYgKGtwYVVzZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyID0gbmV3IEtQQVVzZXJNb2RlbCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5lbXBsb3llZVN0YXR1cyAhPT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkaXRVc2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICh1c2VyLmVtcGxveWVlU3RhdHVzICE9PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cy5pbmFjdGl2YXRlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0NyZWF0ZSBVc2Vyc1xuICAgICAgICAgICAgICAgIGtwYVVzZXIuZW1wbG95ZWVOdW1iZXIgPSBgJHtjb21wYW55Q29kZS50cmltKCl9LSR7dXNlci5lbXBsb3llZUNvZGUudHJpbSgpfWA7XG4gICAgICAgICAgICAgICAga3BhVXNlci5maXJzdE5hbWUgPSB1c2VyLmZpcnN0TmFtZVxuICAgICAgICAgICAgICAgIGtwYVVzZXIubGFzdE5hbWUgPSB1c2VyLmxhc3ROYW1lO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIudXNlcm5hbWUgPSBgJHtjb21wYW55Q29kZS50cmltKCl9LSR7dXNlci5lbXBsb3llZUNvZGUudHJpbSgpfWA7XG4gICAgICAgICAgICAgICAga3BhVXNlci5lbWFpbCA9ICcnO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIuaW5pdGlhbFBhc3N3b3JkID0gYEtQQUZsZXgyMDI0ISFgO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIucm9sZSA9IHRoaXMuZGVmYXVsdFJvbGU7XG4gICAgICAgICAgICAgICAga3BhVXNlci50aXRsZSA9IHVzZXIudGl0bGVcbiAgICAgICAgICAgICAgICBrcGFVc2VyLndlbGNvbWVFbWFpbCA9IHRoaXMud2VsY29tZUVtYWlsXG4gICAgICAgICAgICAgICAga3BhVXNlci5yZXNldFBhc3N3b3JkID0gdGhpcy5yZXNldFBhc3N3b3JkXG5cbiAgICAgICAgICAgICAgICBpZiAodXNlci5lbXBsb3llZVN0YXR1cyAhPT0gJ0EnICYmIGtwYVVzZXIudGVybWluYXRpb25EYXRlID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAga3BhVXNlci50ZXJtaW5hdGlvbkRhdGUgPSBuZXcgRGF0ZSgpLnRvRGF0ZVN0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICBkZWJ1Z2xvZygnbG9nOnNwZWN0cnVtOnVzZXInKShgTmVlZCB0byBDaGVjayAke2twYVVzZXIudGVybWluYXRpb25EYXRlfWApXG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy9BZGQgVXNlciBUbyBMaXN0XG4gICAgICAgICAgICAgICAga3BhVXNlcnMucHVzaChrcGFVc2VyKTtcbiAgICAgICAgICAgICAgICBzdGF0dXMudXBzZXJ0UmVjb3JkKys7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvL1NlbmQgRGF0YVxuICAgICAgICBkZWJ1Z2xvZygnbG9nOnNwZWN0cnVtOnVzZXInKShTdHJpbmcoa3BhVXNlcnMubGVuZ3RoKSlcbiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGtwYVVzZXJBUEkuc2F2ZVVzZXIodGhpcy5rcGFTaXRlLCBrcGFVc2VycywgdGhpcy5pc0VkaXRVc2VyKVxuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHNhdmUgVXNlcnM6JyArIHRoaXMuY29uZmlnLmtwYVNpdGUpO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdsb2c6c3BlY3RydW06dXNlcicpKFwiRXhlY3V0ZSBTcGVjdHJ1bVVzZXJKb2IgRG9uZVwiKTtcbiAgICB9XG5cbn1cbiJdfQ==