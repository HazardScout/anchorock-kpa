"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumUserJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const model_1 = require("../../../base-integration/src/model");
const api_2 = require("../api");
const util_1 = require("util");
class SpectrumUserJob {
    constructor(config) {
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.name = 'Spectrum User Job - ' + this.kpaSite;
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCodes = JSON.parse(config["companyCodes"]["stringValue"]);
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditUser = config["isEditUser"]["stringValue"] == '1';
        this.defaultRole = config["defaultRole"]["stringValue"];
        this.welcomeEmail = config["welcomeEmail"]["stringValue"] === '1';
        this.resetPassword = config["resetPassword"]["stringValue"] === '1';
    }
    async execute(status) {
        (0, util_1.debuglog)('log:spectrum:user')("Execute SpectrumUserJob Start");
        //Fetch KPA Users
        let kpaUserAPI = new api_1.KPAUserAPI(this.kpaToken);
        let kpaExistUsers = await kpaUserAPI.getAllUser();
        status.totalExistingRecord = kpaExistUsers.length;
        (0, util_1.debuglog)('log:spectrum:user')(JSON.stringify(kpaExistUsers, null, 2));
        let kpaUsers = [];
        for (var companyCode of this.companyCodes) {
            //Fetch Spectrum Users
            let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, companyCode);
            let users = await spectrumAPI.getUsers();
            status.totalSourceRecord = users.length;
            //Loop Spectrum Users
            for (let user of users) {
                let isExistingKpaUser = false;
                var kpaUser = null;
                for (let i = 0; i < kpaExistUsers.length; i++) {
                    const kpaExistUser = kpaExistUsers[i];
                    const employeeCode = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                    if (kpaExistUser.employeeNumber === employeeCode) {
                        kpaUser = kpaExistUser;
                        kpaExistUsers.splice(i, 1);
                        isExistingKpaUser = true;
                        break;
                    }
                }
                //Build KPA user Data and Check existing
                if (kpaUser == null) {
                    kpaUser = new model_1.KPAUserModel();
                    if (user.employeeStatus !== 'A') {
                        status.skippedRecord++;
                        continue;
                    }
                }
                else {
                    if (!this.isEditUser) {
                        status.skippedRecord++;
                        continue;
                    }
                    if (user.employeeStatus !== 'A') {
                        status.inactivatedRecord++;
                    }
                }
                //Create Users
                kpaUser.employeeNumber = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                kpaUser.firstName = user.firstName;
                kpaUser.lastName = user.lastName;
                kpaUser.username = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                kpaUser.email = '';
                kpaUser.initialPassword = `KPAFlex2024!!`;
                kpaUser.role = isExistingKpaUser ? '' : this.defaultRole;
                kpaUser.title = user.title;
                kpaUser.welcomeEmail = this.welcomeEmail;
                kpaUser.resetPassword = this.resetPassword;
                if (user.employeeStatus !== 'A' && kpaUser.terminationDate == null) {
                    kpaUser.terminationDate = new Date().toDateString();
                    (0, util_1.debuglog)('log:spectrum:user')(`Need to Check ${kpaUser.terminationDate}`);
                }
                //Add User To List
                kpaUsers.push(kpaUser);
                status.upsertRecord++;
            }
        }
        //Send Data
        (0, util_1.debuglog)('log:spectrum:user')(String(kpaUsers.length));
        const success = await kpaUserAPI.saveUser(this.kpaSite, kpaUsers, this.isEditUser);
        if (!success) {
            throw new Error('Failed to save Users:' + this.config.kpaSite);
        }
        (0, util_1.debuglog)('log:spectrum:user')("Execute SpectrumUserJob Done");
    }
}
exports.SpectrumUserJob = SpectrumUserJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tdXNlci1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tdXNlci1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQStEO0FBRS9ELCtEQUFtRTtBQUNuRSxnQ0FBcUM7QUFDckMsK0JBQWdDO0FBRWhDLE1BQWEsZUFBZTtJQWF4QixZQUFZLE1BQVc7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLElBQUksR0FBRyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQztRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENB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LE1BQU0sQ0FBQyxDQUFDLENBQUE7UUFDdEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxVQUFVLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQTtRQUNsRixJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDWCxNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUNELElBQUEsZUFBUSxFQUFDLG1CQUFtQixDQUFDLENBQUMsOEJBQThCLENBQUMsQ0FBQztJQUNsRSxDQUFDO0NBRUo7QUE1R0QsMENBNEdDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgS1BBVXNlckFQSSB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9hcGlcIjtcbmltcG9ydCB7IElKb2IsIEpvYlN0YXR1cyB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9qb2JcIjtcbmltcG9ydCB7IEtQQVVzZXJNb2RlbCB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9tb2RlbFwiO1xuaW1wb3J0IHsgU3BlY3RydW1BUEkgfSBmcm9tIFwiLi4vYXBpXCI7XG5pbXBvcnQgeyBkZWJ1Z2xvZyB9IGZyb20gJ3V0aWwnO1xuXG5leHBvcnQgY2xhc3MgU3BlY3RydW1Vc2VySm9iIGltcGxlbWVudHMgSUpvYiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGtwYVNpdGU6IHN0cmluZztcbiAgICBrcGFUb2tlbjogc3RyaW5nO1xuICAgIHNlcnZlclVybDogc3RyaW5nO1xuICAgIGNvbXBhbnlDb2Rlczogc3RyaW5nW107XG4gICAgYXV0aG9yaXphdGlvbklkOiBzdHJpbmc7XG4gICAgaXNFZGl0VXNlcjogYm9vbGVhbjtcbiAgICBjb25maWc6IGFueTtcbiAgICBkZWZhdWx0Um9sZTogc3RyaW5nO1xuICAgIHdlbGNvbWVFbWFpbDogYm9vbGVhbjtcbiAgICByZXNldFBhc3N3b3JkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBhbnkpIHtcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgdGhpcy5rcGFTaXRlID0gY29uZmlnW1wia3BhU2l0ZVwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLm5hbWUgPSAnU3BlY3RydW0gVXNlciBKb2IgLSAnICsgdGhpcy5rcGFTaXRlO1xuICAgICAgICB0aGlzLmtwYVRva2VuID0gY29uZmlnW1wia3BhVG9rZW5cIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5zZXJ2ZXJVcmwgPSBjb25maWdbXCJzZXJ2ZXJVcmxcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5jb21wYW55Q29kZXMgPSBKU09OLnBhcnNlKGNvbmZpZ1tcImNvbXBhbnlDb2Rlc1wiXVtcInN0cmluZ1ZhbHVlXCJdKTtcbiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uSWQgPSBjb25maWdbXCJhdXRob3JpemF0aW9uSWRcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5pc0VkaXRVc2VyID0gY29uZmlnW1wiaXNFZGl0VXNlclwiXVtcInN0cmluZ1ZhbHVlXCJdID09ICcxJztcbiAgICAgICAgdGhpcy5kZWZhdWx0Um9sZSA9IGNvbmZpZ1tcImRlZmF1bHRSb2xlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMud2VsY29tZUVtYWlsID0gY29uZmlnW1wid2VsY29tZUVtYWlsXCJdW1wic3RyaW5nVmFsdWVcIl0gPT09ICcxJztcbiAgICAgICAgdGhpcy5yZXNldFBhc3N3b3JkID0gY29uZmlnW1wicmVzZXRQYXNzd29yZFwiXVtcInN0cmluZ1ZhbHVlXCJdID09PSAnMSc7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZShzdGF0dXM6IEpvYlN0YXR1cyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBkZWJ1Z2xvZygnbG9nOnNwZWN0cnVtOnVzZXInKShcIkV4ZWN1dGUgU3BlY3RydW1Vc2VySm9iIFN0YXJ0XCIpO1xuICAgICAgICAvL0ZldGNoIEtQQSBVc2Vyc1xuICAgICAgICBsZXQga3BhVXNlckFQSSA9IG5ldyBLUEFVc2VyQVBJKHRoaXMua3BhVG9rZW4pO1xuICAgICAgICBsZXQga3BhRXhpc3RVc2VycyA9IGF3YWl0IGtwYVVzZXJBUEkuZ2V0QWxsVXNlcigpO1xuICAgICAgICBzdGF0dXMudG90YWxFeGlzdGluZ1JlY29yZCA9IGtwYUV4aXN0VXNlcnMubGVuZ3RoO1xuICAgICAgICBkZWJ1Z2xvZygnbG9nOnNwZWN0cnVtOnVzZXInKShKU09OLnN0cmluZ2lmeShrcGFFeGlzdFVzZXJzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgbGV0IGtwYVVzZXJzIDogS1BBVXNlck1vZGVsW10gPSBbXTtcbiAgICAgICAgZm9yICh2YXIgY29tcGFueUNvZGUgb2YgdGhpcy5jb21wYW55Q29kZXMpIHtcbiAgICAgICAgICAgIC8vRmV0Y2ggU3BlY3RydW0gVXNlcnNcbiAgICAgICAgICAgIGxldCBzcGVjdHJ1bUFQSSA9IG5ldyBTcGVjdHJ1bUFQSSh0aGlzLnNlcnZlclVybCwgdGhpcy5hdXRob3JpemF0aW9uSWQsIGNvbXBhbnlDb2RlKTtcbiAgICAgICAgICAgIGxldCB1c2VycyA9IGF3YWl0IHNwZWN0cnVtQVBJLmdldFVzZXJzKCk7XG4gICAgICAgICAgICBzdGF0dXMudG90YWxTb3VyY2VSZWNvcmQgPSB1c2Vycy5sZW5ndGhcblxuICAgICAgICAgICAgLy9Mb29wIFNwZWN0cnVtIFVzZXJzXG4gICAgICAgICAgICBmb3IgKGxldCB1c2VyIG9mIHVzZXJzKSB7XG4gICAgICAgICAgICAgICAgbGV0IGlzRXhpc3RpbmdLcGFVc2VyID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgdmFyIGtwYVVzZXIgOiBLUEFVc2VyTW9kZWwgfCBudWxsID0gbnVsbDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtwYUV4aXN0VXNlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga3BhRXhpc3RVc2VyID0ga3BhRXhpc3RVc2Vyc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW1wbG95ZWVDb2RlID0gYCR7Y29tcGFueUNvZGUudHJpbSgpfS0ke3VzZXIuZW1wbG95ZWVDb2RlLnRyaW0oKX1gO1xuICAgICAgICAgICAgICAgICAgICBpZiAoa3BhRXhpc3RVc2VyLmVtcGxveWVlTnVtYmVyID09PSBlbXBsb3llZUNvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVVzZXIgPSBrcGFFeGlzdFVzZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICBrcGFFeGlzdFVzZXJzLnNwbGljZShpLCAxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlzRXhpc3RpbmdLcGFVc2VyID0gdHJ1ZVxuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0J1aWxkIEtQQSB1c2VyIERhdGEgYW5kIENoZWNrIGV4aXN0aW5nXG4gICAgICAgICAgICAgICAgaWYgKGtwYVVzZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyID0gbmV3IEtQQVVzZXJNb2RlbCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5lbXBsb3llZVN0YXR1cyAhPT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkaXRVc2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICh1c2VyLmVtcGxveWVlU3RhdHVzICE9PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cy5pbmFjdGl2YXRlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0NyZWF0ZSBVc2Vyc1xuICAgICAgICAgICAgICAgIGtwYVVzZXIuZW1wbG95ZWVOdW1iZXIgPSBgJHtjb21wYW55Q29kZS50cmltKCl9LSR7dXNlci5lbXBsb3llZUNvZGUudHJpbSgpfWA7XG4gICAgICAgICAgICAgICAga3BhVXNlci5maXJzdE5hbWUgPSB1c2VyLmZpcnN0TmFtZVxuICAgICAgICAgICAgICAgIGtwYVVzZXIubGFzdE5hbWUgPSB1c2VyLmxhc3ROYW1lO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIudXNlcm5hbWUgPSBgJHtjb21wYW55Q29kZS50cmltKCl9LSR7dXNlci5lbXBsb3llZUNvZGUudHJpbSgpfWA7XG4gICAgICAgICAgICAgICAga3BhVXNlci5lbWFpbCA9ICcnO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIuaW5pdGlhbFBhc3N3b3JkID0gYEtQQUZsZXgyMDI0ISFgO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIucm9sZSA9IGlzRXhpc3RpbmdLcGFVc2VyID8gJycgOiB0aGlzLmRlZmF1bHRSb2xlO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIudGl0bGUgPSB1c2VyLnRpdGxlXG4gICAgICAgICAgICAgICAga3BhVXNlci53ZWxjb21lRW1haWwgPSB0aGlzLndlbGNvbWVFbWFpbFxuICAgICAgICAgICAgICAgIGtwYVVzZXIucmVzZXRQYXNzd29yZCA9IHRoaXMucmVzZXRQYXNzd29yZFxuXG4gICAgICAgICAgICAgICAgaWYgKHVzZXIuZW1wbG95ZWVTdGF0dXMgIT09ICdBJyAmJiBrcGFVc2VyLnRlcm1pbmF0aW9uRGF0ZSA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXIudGVybWluYXRpb25EYXRlID0gbmV3IERhdGUoKS50b0RhdGVTdHJpbmcoKTtcbiAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coJ2xvZzpzcGVjdHJ1bTp1c2VyJykoYE5lZWQgdG8gQ2hlY2sgJHtrcGFVc2VyLnRlcm1pbmF0aW9uRGF0ZX1gKVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vQWRkIFVzZXIgVG8gTGlzdFxuICAgICAgICAgICAgICAgIGtwYVVzZXJzLnB1c2goa3BhVXNlcik7XG4gICAgICAgICAgICAgICAgc3RhdHVzLnVwc2VydFJlY29yZCsrO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy9TZW5kIERhdGFcbiAgICAgICAgZGVidWdsb2coJ2xvZzpzcGVjdHJ1bTp1c2VyJykoU3RyaW5nKGtwYVVzZXJzLmxlbmd0aCkpXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBrcGFVc2VyQVBJLnNhdmVVc2VyKHRoaXMua3BhU2l0ZSwga3BhVXNlcnMsIHRoaXMuaXNFZGl0VXNlcilcbiAgICAgICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBzYXZlIFVzZXJzOicgKyB0aGlzLmNvbmZpZy5rcGFTaXRlKTtcbiAgICAgICAgfVxuICAgICAgICBkZWJ1Z2xvZygnbG9nOnNwZWN0cnVtOnVzZXInKShcIkV4ZWN1dGUgU3BlY3RydW1Vc2VySm9iIERvbmVcIik7XG4gICAgfVxuXG59XG4iXX0=