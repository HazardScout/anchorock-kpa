"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumUserJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const model_1 = require("../../../base-integration/src/model");
const api_2 = require("../api");
class SpectrumUserJob {
    constructor(config) {
        this.name = 'Spectrum User Job';
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCodes = JSON.parse(config["companyCodes"]["stringValue"]);
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditUser = config["isEditUser"]["stringValue"] == '1';
        this.defaultRole = config["defaultRole"]["stringValue"];
        this.welcomeEmail = config["welcomeEmail"]["stringValue"] === '1';
        this.resetPassword = config["resetPassword"]["stringValue"] === '1';
    }
    async execute(status) {
        console.log("Execute SpectrumUserJob Start");
        try {
            //Fetch KPA Users
            let kpaUserAPI = new api_1.KPAUserAPI(this.kpaToken);
            let kpaExistUsers = await kpaUserAPI.getAllUser();
            status.totalExistingRecord = kpaExistUsers.length;
            console.log(kpaExistUsers);
            let kpaUsers = [];
            for (var companyCode of this.companyCodes) {
                //Fetch Spectrum Users
                let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, companyCode);
                let users = await spectrumAPI.getUsers();
                status.totalSourceRecord = users.length;
                //Loop Spectrum Users
                for (let user of users) {
                    var kpaUser = null;
                    for (let i = 0; i < kpaExistUsers.length; i++) {
                        const kpaExistUser = kpaExistUsers[i];
                        const employeeCode = `${companyCode.trim}-${user.employeeCode.trim}`;
                        if (kpaExistUser.employeeNumber === employeeCode) {
                            kpaUser = kpaExistUser;
                            kpaExistUsers.splice(i, 1);
                            break;
                        }
                    }
                    //Build KPA user Data and Check existing
                    if (kpaUser == null) {
                        kpaUser = new model_1.KPAUserModel();
                        if (user.employeeStatus !== 'A') {
                            // console.log(`Skip User because of Termination Date ${user.employeeId} ${user.terminationDate}`)
                            status.skippedRecord++;
                            continue;
                        }
                    }
                    else {
                        if (!this.isEditUser) {
                            // console.log(`Skip User because of Cannot Allow to edit ${user.employeeId}`)
                            status.skippedRecord++;
                            continue;
                        }
                        if (user.employeeStatus !== 'A') {
                            status.inactivatedRecord++;
                        }
                    }
                    //Create Users 
                    kpaUser.employeeNumber = `${companyCode.trim}-${user.employeeCode.trim}`;
                    kpaUser.firstName = user.firstName;
                    kpaUser.lastName = user.lastName;
                    kpaUser.username = kpaUser.employeeNumber;
                    kpaUser.email = '';
                    kpaUser.initialPassword = `KPAFlex2024!!`;
                    kpaUser.role = this.defaultRole;
                    kpaUser.title = user.title;
                    kpaUser.welcomeEmail = this.welcomeEmail;
                    kpaUser.resetPassword = this.resetPassword;
                    if (user.employeeStatus !== 'A' && kpaUser.terminationDate == null) {
                        kpaUser.terminationDate = new Date().toDateString();
                        console.log(`Need to Check ${kpaUser.terminationDate}`);
                    }
                    //Add User To List
                    kpaUsers.push(kpaUser);
                    status.upsertRecord++;
                }
            }
            //Send Data
            console.log(kpaUsers.length);
            const success = await kpaUserAPI.saveUser(this.kpaSite, kpaUsers, this.isEditUser);
            if (!success) {
                console.log('Failed to save Users');
            }
        }
        catch (e) {
            console.log(`Worker Stop with Error : ${e}`);
        }
        console.log("Execute SpectrumUserJob Done");
    }
}
exports.SpectrumUserJob = SpectrumUserJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tdXNlci1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tdXNlci1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQStEO0FBRS9ELCtEQUFtRTtBQUNuRSxnQ0FBcUM7QUFFckMsTUFBYSxlQUFlO0lBYXhCLFlBQVksTUFBVztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLG1CQUFtQixDQUFDO1FBQ2hDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQztRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUMsS0FBSyxHQUFHLENBQUM7UUFDbEUsSUFBSSxDQUFD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LDRCQUE0QixDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ2hELENBQUM7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDaEQsQ0FBQztDQUVKO0FBaEhELDBDQWdIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtQQVVzZXJBUEkgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvYXBpXCI7XG5pbXBvcnQgeyBJSm9iLCBKb2JTdGF0dXMgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvam9iXCI7XG5pbXBvcnQgeyBLUEFVc2VyTW9kZWwgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvbW9kZWxcIjtcbmltcG9ydCB7IFNwZWN0cnVtQVBJIH0gZnJvbSBcIi4uL2FwaVwiO1xuXG5leHBvcnQgY2xhc3MgU3BlY3RydW1Vc2VySm9iIGltcGxlbWVudHMgSUpvYiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGtwYVNpdGU6IHN0cmluZztcbiAgICBrcGFUb2tlbjogc3RyaW5nO1xuICAgIHNlcnZlclVybDogc3RyaW5nO1xuICAgIGNvbXBhbnlDb2Rlczogc3RyaW5nW107XG4gICAgYXV0aG9yaXphdGlvbklkOiBzdHJpbmc7XG4gICAgaXNFZGl0VXNlcjogYm9vbGVhbjtcbiAgICBjb25maWc6IGFueTtcbiAgICBkZWZhdWx0Um9sZTogc3RyaW5nO1xuICAgIHdlbGNvbWVFbWFpbDogYm9vbGVhbjtcbiAgICByZXNldFBhc3N3b3JkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBhbnkpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gJ1NwZWN0cnVtIFVzZXIgSm9iJztcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgdGhpcy5rcGFTaXRlID0gY29uZmlnW1wia3BhU2l0ZVwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmtwYVRva2VuID0gY29uZmlnW1wia3BhVG9rZW5cIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5zZXJ2ZXJVcmwgPSBjb25maWdbXCJzZXJ2ZXJVcmxcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5jb21wYW55Q29kZXMgPSBKU09OLnBhcnNlKGNvbmZpZ1tcImNvbXBhbnlDb2Rlc1wiXVtcInN0cmluZ1ZhbHVlXCJdKTtcbiAgICAgICAgdGhpcy5hdXRob3JpemF0aW9uSWQgPSBjb25maWdbXCJhdXRob3JpemF0aW9uSWRcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5pc0VkaXRVc2VyID0gY29uZmlnW1wiaXNFZGl0VXNlclwiXVtcInN0cmluZ1ZhbHVlXCJdID09ICcxJztcbiAgICAgICAgdGhpcy5kZWZhdWx0Um9sZSA9IGNvbmZpZ1tcImRlZmF1bHRSb2xlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMud2VsY29tZUVtYWlsID0gY29uZmlnW1wid2VsY29tZUVtYWlsXCJdW1wic3RyaW5nVmFsdWVcIl0gPT09ICcxJztcbiAgICAgICAgdGhpcy5yZXNldFBhc3N3b3JkID0gY29uZmlnW1wicmVzZXRQYXNzd29yZFwiXVtcInN0cmluZ1ZhbHVlXCJdID09PSAnMSc7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZShzdGF0dXM6IEpvYlN0YXR1cyk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zb2xlLmxvZyhcIkV4ZWN1dGUgU3BlY3RydW1Vc2VySm9iIFN0YXJ0XCIpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy9GZXRjaCBLUEEgVXNlcnNcbiAgICAgICAgICAgIGxldCBrcGFVc2VyQVBJID0gbmV3IEtQQVVzZXJBUEkodGhpcy5rcGFUb2tlbik7XG4gICAgICAgICAgICBsZXQga3BhRXhpc3RVc2VycyA9IGF3YWl0IGtwYVVzZXJBUEkuZ2V0QWxsVXNlcigpO1xuICAgICAgICAgICAgc3RhdHVzLnRvdGFsRXhpc3RpbmdSZWNvcmQgPSBrcGFFeGlzdFVzZXJzLmxlbmd0aDtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGtwYUV4aXN0VXNlcnMpXG5cbiAgICAgICAgICAgIGxldCBrcGFVc2VycyA6IEtQQVVzZXJNb2RlbFtdID0gW107XG4gICAgICAgICAgICBmb3IgKHZhciBjb21wYW55Q29kZSBvZiB0aGlzLmNvbXBhbnlDb2Rlcykge1xuICAgICAgICAgICAgICAgIC8vRmV0Y2ggU3BlY3RydW0gVXNlcnNcbiAgICAgICAgICAgICAgICBsZXQgc3BlY3RydW1BUEkgPSBuZXcgU3BlY3RydW1BUEkodGhpcy5zZXJ2ZXJVcmwsIHRoaXMuYXV0aG9yaXphdGlvbklkLCBjb21wYW55Q29kZSk7XG4gICAgICAgICAgICAgICAgbGV0IHVzZXJzID0gYXdhaXQgc3BlY3RydW1BUEkuZ2V0VXNlcnMoKTtcbiAgICAgICAgICAgICAgICBzdGF0dXMudG90YWxTb3VyY2VSZWNvcmQgPSB1c2Vycy5sZW5ndGhcblxuICAgICAgICAgICAgICAgIC8vTG9vcCBTcGVjdHJ1bSBVc2Vyc1xuICAgICAgICAgICAgICAgIGZvcihsZXQgdXNlciBvZiB1c2Vycykge1xuICAgICAgICAgICAgICAgICAgICB2YXIga3BhVXNlciA6IEtQQVVzZXJNb2RlbCB8IG51bGwgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtwYUV4aXN0VXNlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtwYUV4aXN0VXNlciA9IGtwYUV4aXN0VXNlcnNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlbXBsb3llZUNvZGUgPSBgJHtjb21wYW55Q29kZS50cmltfS0ke3VzZXIuZW1wbG95ZWVDb2RlLnRyaW19YDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrcGFFeGlzdFVzZXIuZW1wbG95ZWVOdW1iZXIgPT09IGVtcGxveWVlQ29kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtwYVVzZXIgPSBrcGFFeGlzdFVzZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga3BhRXhpc3RVc2Vycy5zcGxpY2UoaSwxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vQnVpbGQgS1BBIHVzZXIgRGF0YSBhbmQgQ2hlY2sgZXhpc3RpbmdcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtwYVVzZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhVXNlciA9IG5ldyBLUEFVc2VyTW9kZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1c2VyLmVtcGxveWVlU3RhdHVzICE9PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgU2tpcCBVc2VyIGJlY2F1c2Ugb2YgVGVybWluYXRpb24gRGF0ZSAke3VzZXIuZW1wbG95ZWVJZH0gJHt1c2VyLnRlcm1pbmF0aW9uRGF0ZX1gKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cy5za2lwcGVkUmVjb3JkKytcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkaXRVc2VyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNraXAgVXNlciBiZWNhdXNlIG9mIENhbm5vdCBBbGxvdyB0byBlZGl0ICR7dXNlci5lbXBsb3llZUlkfWApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnNraXBwZWRSZWNvcmQrK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5lbXBsb3llZVN0YXR1cyAhPT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLmluYWN0aXZhdGVkUmVjb3JkKytcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vQ3JlYXRlIFVzZXJzIFxuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyLmVtcGxveWVlTnVtYmVyID0gYCR7Y29tcGFueUNvZGUudHJpbX0tJHt1c2VyLmVtcGxveWVlQ29kZS50cmltfWA7XG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXIuZmlyc3ROYW1lID0gdXNlci5maXJzdE5hbWVcbiAgICAgICAgICAgICAgICAgICAga3BhVXNlci5sYXN0TmFtZSA9IHVzZXIubGFzdE5hbWU7XG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXIudXNlcm5hbWUgPSBrcGFVc2VyLmVtcGxveWVlTnVtYmVyO1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyLmVtYWlsID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXIuaW5pdGlhbFBhc3N3b3JkID0gYEtQQUZsZXgyMDI0ISFgO1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyLnJvbGUgPSB0aGlzLmRlZmF1bHRSb2xlO1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyLnRpdGxlID0gdXNlci50aXRsZVxuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyLndlbGNvbWVFbWFpbCA9IHRoaXMud2VsY29tZUVtYWlsXG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXIucmVzZXRQYXNzd29yZCA9IHRoaXMucmVzZXRQYXNzd29yZFxuXG4gICAgICAgICAgICAgICAgICAgIGlmICh1c2VyLmVtcGxveWVlU3RhdHVzICE9PSAnQScgJiYga3BhVXNlci50ZXJtaW5hdGlvbkRhdGUgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhVXNlci50ZXJtaW5hdGlvbkRhdGUgPSBuZXcgRGF0ZSgpLnRvRGF0ZVN0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coYE5lZWQgdG8gQ2hlY2sgJHtrcGFVc2VyLnRlcm1pbmF0aW9uRGF0ZX1gKVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgLy9BZGQgVXNlciBUbyBMaXN0XG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXJzLnB1c2goa3BhVXNlcik7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1cy51cHNlcnRSZWNvcmQrKztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vU2VuZCBEYXRhXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhrcGFVc2Vycy5sZW5ndGgpXG4gICAgICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQga3BhVXNlckFQSS5zYXZlVXNlcih0aGlzLmtwYVNpdGUsIGtwYVVzZXJzLCB0aGlzLmlzRWRpdFVzZXIpXG4gICAgICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIHNhdmUgVXNlcnMnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBXb3JrZXIgU3RvcCB3aXRoIEVycm9yIDogJHtlfWApXG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJFeGVjdXRlIFNwZWN0cnVtVXNlckpvYiBEb25lXCIpO1xuICAgIH1cblxufSJdfQ==