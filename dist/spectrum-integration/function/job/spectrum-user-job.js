"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumUserJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const model_1 = require("../../../base-integration/src/model");
const api_2 = require("../api");
class SpectrumUserJob {
    constructor(config) {
        this.name = 'Spectrum User Job';
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCode = config["companyCode"]["stringValue"];
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditUser = config["isEditUser"]["stringValue"] == '1';
        this.defaultRole = config["defaultRole"]["stringValue"];
        this.welcomeEmail = config["welcomeEmail"]["stringValue"] === '1';
        this.resetPassword = config["resetPassword"]["stringValue"] === '1';
    }
    async execute(status) {
        console.log("Execute SpectrumUserJob Start");
        try {
            //Fetch KPA Users
            let kpaUserAPI = new api_1.KPAUserAPI(this.kpaToken);
            let kpaExistUsers = await kpaUserAPI.getAllUser();
            status.totalExistingRecord = kpaExistUsers.length;
            console.log(kpaExistUsers);
            //Fetch Spectrum Users
            let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, this.companyCode);
            let users = await spectrumAPI.getUsers();
            status.totalSourceRecord = users.length;
            //Loop Spectrum Users
            let kpaUsers = [];
            for (let user of users) {
                var kpaUser = null;
                for (let i = 0; i < kpaExistUsers.length; i++) {
                    const kpaExistUser = kpaExistUsers[i];
                    if (kpaExistUser.employeeNumber === user.employeeCode) {
                        kpaUser = kpaExistUser;
                        kpaExistUsers.splice(i, 1);
                        break;
                    }
                }
                //Build KPA user Data and Check existing
                if (kpaUser == null) {
                    kpaUser = new model_1.KPAUserModel();
                    if (user.employeeStatus !== 'A') {
                        // console.log(`Skip User because of Termination Date ${user.employeeId} ${user.terminationDate}`)
                        status.skippedRecord++;
                        continue;
                    }
                }
                else {
                    if (!this.isEditUser) {
                        // console.log(`Skip User because of Cannot Allow to edit ${user.employeeId}`)
                        status.skippedRecord++;
                        continue;
                    }
                    if (user.employeeStatus !== 'A') {
                        status.inactivatedRecord++;
                    }
                }
                //Create Users 
                kpaUser.employeeNumber = user.employeeCode;
                kpaUser.firstName = user.firstName;
                kpaUser.lastName = user.lastName;
                kpaUser.username = user.employeeCode;
                kpaUser.email = '';
                kpaUser.initialPassword = `KPAFlex2024!!`;
                kpaUser.role = this.defaultRole;
                kpaUser.title = user.title;
                kpaUser.welcomeEmail = this.welcomeEmail;
                kpaUser.resetPassword = this.resetPassword;
                if (user.employeeStatus !== 'A' && kpaUser.terminationDate == null) {
                    kpaUser.terminationDate = new Date().toDateString();
                    console.log(`Need to Check ${kpaUser.terminationDate}`);
                }
                //Add User To List
                kpaUsers.push(kpaUser);
                status.upsertRecord++;
            }
            //Send Data
            console.log(kpaUsers.length);
            const success = await kpaUserAPI.saveUser(this.kpaSite, kpaUsers, this.isEditUser);
            if (!success) {
                console.log('Failed to save Users');
            }
        }
        catch (e) {
            console.log(`Worker Stop with Error : ${e}`);
        }
        console.log("Execute SpectrumUserJob Done");
    }
}
exports.SpectrumUserJob = SpectrumUserJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tdXNlci1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tdXNlci1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQStEO0FBRS9ELCtEQUFtRTtBQUNuRSxnQ0FBcUM7QUFFckMsTUFBYSxlQUFlO0lBYXhCLFlBQVksTUFBVztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLG1CQUFtQixDQUFDO1FBQ2hDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDO1FBQzdELElBQUksQ0FBQyxXQUFXLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEdBQUcsQ0FBQztRQUNsRSxJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxlQUFl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T0FBTyxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFBO2dCQUN4QyxPQUFPLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUE7Z0JBRTFDLElBQUksSUFBSSxDQUFDLGNBQWMsS0FBSyxHQUFHLElBQUksT0FBTyxDQUFDLGVBQWUsSUFBSSxJQUFJLEVBQUUsQ0FBQztvQkFDakUsT0FBTyxDQUFDLGVBQWUsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFlBQVksRUFBRSxDQUFDO29CQUNwRCxPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixPQUFPLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQTtnQkFDM0QsQ0FBQztnQkFFRCxrQkFBa0I7Z0JBQ2xCLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZCLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMxQixDQUFDO1lBRUQsV0FBVztZQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFBO1lBQzVCLE1BQU0sT0FBTyxHQUFHLE1BQU0sVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7WUFDbEYsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQTtZQUN2QyxDQUFDO1FBQ0wsQ0FBQztRQUFDLE9BQU0sQ0FBQyxFQUFFLENBQUM7WUFDUixPQUFPLENBQUMsR0FBRyxDQUFDLDRCQUE0QixDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ2hELENBQUM7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDaEQsQ0FBQztDQUVKO0FBN0dELDBDQTZHQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtQQVVzZXJBUEkgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvYXBpXCI7XG5pbXBvcnQgeyBJSm9iLCBKb2JTdGF0dXMgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvam9iXCI7XG5pbXBvcnQgeyBLUEFVc2VyTW9kZWwgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvbW9kZWxcIjtcbmltcG9ydCB7IFNwZWN0cnVtQVBJIH0gZnJvbSBcIi4uL2FwaVwiO1xuXG5leHBvcnQgY2xhc3MgU3BlY3RydW1Vc2VySm9iIGltcGxlbWVudHMgSUpvYiB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGtwYVNpdGU6IHN0cmluZztcbiAgICBrcGFUb2tlbjogc3RyaW5nO1xuICAgIHNlcnZlclVybDogc3RyaW5nO1xuICAgIGNvbXBhbnlDb2RlOiBzdHJpbmc7XG4gICAgYXV0aG9yaXphdGlvbklkOiBzdHJpbmc7XG4gICAgaXNFZGl0VXNlcjogYm9vbGVhbjtcbiAgICBjb25maWc6IGFueTtcbiAgICBkZWZhdWx0Um9sZTogc3RyaW5nO1xuICAgIHdlbGNvbWVFbWFpbDogYm9vbGVhbjtcbiAgICByZXNldFBhc3N3b3JkOiBib29sZWFuO1xuXG4gICAgY29uc3RydWN0b3IoY29uZmlnOiBhbnkpIHtcbiAgICAgICAgdGhpcy5uYW1lID0gJ1NwZWN0cnVtIFVzZXIgSm9iJztcbiAgICAgICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbiAgICAgICAgdGhpcy5rcGFTaXRlID0gY29uZmlnW1wia3BhU2l0ZVwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmtwYVRva2VuID0gY29uZmlnW1wia3BhVG9rZW5cIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5zZXJ2ZXJVcmwgPSBjb25maWdbXCJzZXJ2ZXJVcmxcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5jb21wYW55Q29kZSA9IGNvbmZpZ1tcImNvbXBhbnlDb2RlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbklkID0gY29uZmlnW1wiYXV0aG9yaXphdGlvbklkXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMuaXNFZGl0VXNlciA9IGNvbmZpZ1tcImlzRWRpdFVzZXJcIl1bXCJzdHJpbmdWYWx1ZVwiXSA9PSAnMSc7XG4gICAgICAgIHRoaXMuZGVmYXVsdFJvbGUgPSBjb25maWdbXCJkZWZhdWx0Um9sZVwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLndlbGNvbWVFbWFpbCA9IGNvbmZpZ1tcIndlbGNvbWVFbWFpbFwiXVtcInN0cmluZ1ZhbHVlXCJdID09PSAnMSc7XG4gICAgICAgIHRoaXMucmVzZXRQYXNzd29yZCA9IGNvbmZpZ1tcInJlc2V0UGFzc3dvcmRcIl1bXCJzdHJpbmdWYWx1ZVwiXSA9PT0gJzEnO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGUoc3RhdHVzOiBKb2JTdGF0dXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJFeGVjdXRlIFNwZWN0cnVtVXNlckpvYiBTdGFydFwiKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vRmV0Y2ggS1BBIFVzZXJzXG4gICAgICAgICAgICBsZXQga3BhVXNlckFQSSA9IG5ldyBLUEFVc2VyQVBJKHRoaXMua3BhVG9rZW4pO1xuICAgICAgICAgICAgbGV0IGtwYUV4aXN0VXNlcnMgPSBhd2FpdCBrcGFVc2VyQVBJLmdldEFsbFVzZXIoKTtcbiAgICAgICAgICAgIHN0YXR1cy50b3RhbEV4aXN0aW5nUmVjb3JkID0ga3BhRXhpc3RVc2Vycy5sZW5ndGg7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhrcGFFeGlzdFVzZXJzKVxuXG4gICAgICAgICAgICAvL0ZldGNoIFNwZWN0cnVtIFVzZXJzXG4gICAgICAgICAgICBsZXQgc3BlY3RydW1BUEkgPSBuZXcgU3BlY3RydW1BUEkodGhpcy5zZXJ2ZXJVcmwsIHRoaXMuYXV0aG9yaXphdGlvbklkLCB0aGlzLmNvbXBhbnlDb2RlKTtcbiAgICAgICAgICAgIGxldCB1c2VycyA9IGF3YWl0IHNwZWN0cnVtQVBJLmdldFVzZXJzKCk7XG4gICAgICAgICAgICBzdGF0dXMudG90YWxTb3VyY2VSZWNvcmQgPSB1c2Vycy5sZW5ndGhcblxuICAgICAgICAgICAgLy9Mb29wIFNwZWN0cnVtIFVzZXJzXG4gICAgICAgICAgICBsZXQga3BhVXNlcnMgOiBLUEFVc2VyTW9kZWxbXSA9IFtdO1xuICAgICAgICAgICAgZm9yKGxldCB1c2VyIG9mIHVzZXJzKSB7XG4gICAgICAgICAgICAgICAgdmFyIGtwYVVzZXIgOiBLUEFVc2VyTW9kZWwgfCBudWxsID0gbnVsbDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtwYUV4aXN0VXNlcnMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga3BhRXhpc3RVc2VyID0ga3BhRXhpc3RVc2Vyc1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtwYUV4aXN0VXNlci5lbXBsb3llZU51bWJlciA9PT0gdXNlci5lbXBsb3llZUNvZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVVzZXIgPSBrcGFFeGlzdFVzZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICBrcGFFeGlzdFVzZXJzLnNwbGljZShpLDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0J1aWxkIEtQQSB1c2VyIERhdGEgYW5kIENoZWNrIGV4aXN0aW5nXG4gICAgICAgICAgICAgICAgaWYgKGtwYVVzZXIgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyID0gbmV3IEtQQVVzZXJNb2RlbCgpO1xuICAgICAgICAgICAgICAgICAgICBpZiAodXNlci5lbXBsb3llZVN0YXR1cyAhPT0gJ0EnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgU2tpcCBVc2VyIGJlY2F1c2Ugb2YgVGVybWluYXRpb24gRGF0ZSAke3VzZXIuZW1wbG95ZWVJZH0gJHt1c2VyLnRlcm1pbmF0aW9uRGF0ZX1gKVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnNraXBwZWRSZWNvcmQrK1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNFZGl0VXNlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNraXAgVXNlciBiZWNhdXNlIG9mIENhbm5vdCBBbGxvdyB0byBlZGl0ICR7dXNlci5lbXBsb3llZUlkfWApXG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGlmICh1c2VyLmVtcGxveWVlU3RhdHVzICE9PSAnQScpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cy5pbmFjdGl2YXRlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0NyZWF0ZSBVc2VycyBcbiAgICAgICAgICAgICAgICBrcGFVc2VyLmVtcGxveWVlTnVtYmVyID0gdXNlci5lbXBsb3llZUNvZGU7XG4gICAgICAgICAgICAgICAga3BhVXNlci5maXJzdE5hbWUgPSB1c2VyLmZpcnN0TmFtZVxuICAgICAgICAgICAgICAgIGtwYVVzZXIubGFzdE5hbWUgPSB1c2VyLmxhc3ROYW1lO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIudXNlcm5hbWUgPSB1c2VyLmVtcGxveWVlQ29kZTtcbiAgICAgICAgICAgICAgICBrcGFVc2VyLmVtYWlsID0gJyc7XG4gICAgICAgICAgICAgICAga3BhVXNlci5pbml0aWFsUGFzc3dvcmQgPSBgS1BBRmxleDIwMjQhIWA7XG4gICAgICAgICAgICAgICAga3BhVXNlci5yb2xlID0gdGhpcy5kZWZhdWx0Um9sZTtcbiAgICAgICAgICAgICAgICBrcGFVc2VyLnRpdGxlID0gdXNlci50aXRsZVxuICAgICAgICAgICAgICAgIGtwYVVzZXIud2VsY29tZUVtYWlsID0gdGhpcy53ZWxjb21lRW1haWxcbiAgICAgICAgICAgICAgICBrcGFVc2VyLnJlc2V0UGFzc3dvcmQgPSB0aGlzLnJlc2V0UGFzc3dvcmRcblxuICAgICAgICAgICAgICAgIGlmICh1c2VyLmVtcGxveWVlU3RhdHVzICE9PSAnQScgJiYga3BhVXNlci50ZXJtaW5hdGlvbkRhdGUgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICBrcGFVc2VyLnRlcm1pbmF0aW9uRGF0ZSA9IG5ldyBEYXRlKCkudG9EYXRlU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBOZWVkIHRvIENoZWNrICR7a3BhVXNlci50ZXJtaW5hdGlvbkRhdGV9YClcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0FkZCBVc2VyIFRvIExpc3RcbiAgICAgICAgICAgICAgICBrcGFVc2Vycy5wdXNoKGtwYVVzZXIpO1xuICAgICAgICAgICAgICAgIHN0YXR1cy51cHNlcnRSZWNvcmQrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy9TZW5kIERhdGFcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGtwYVVzZXJzLmxlbmd0aClcbiAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBrcGFVc2VyQVBJLnNhdmVVc2VyKHRoaXMua3BhU2l0ZSwga3BhVXNlcnMsIHRoaXMuaXNFZGl0VXNlcilcbiAgICAgICAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gc2F2ZSBVc2VycycpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coYFdvcmtlciBTdG9wIHdpdGggRXJyb3IgOiAke2V9YClcbiAgICAgICAgfVxuICAgICAgICBjb25zb2xlLmxvZyhcIkV4ZWN1dGUgU3BlY3RydW1Vc2VySm9iIERvbmVcIik7XG4gICAgfVxuXG59Il19