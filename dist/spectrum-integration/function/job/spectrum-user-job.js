"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumUserJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const model_1 = require("../../../base-integration/src/model");
const api_2 = require("../api");
const util_1 = require("util");
class SpectrumUserJob {
    constructor(config) {
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.name = 'Spectrum User Job - ' + this.kpaSite;
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCodes = JSON.parse(config["companyCodes"]["stringValue"]);
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditUser = config["isEditUser"]["stringValue"] == '1';
        this.defaultRole = config["defaultRole"]["stringValue"];
        this.welcomeEmail = config["welcomeEmail"]["stringValue"] === '1';
        this.resetPassword = config["resetPassword"]["stringValue"] === '1';
    }
    async execute(status) {
        (0, util_1.debuglog)('log:spectrum:user')("Execute SpectrumUserJob Start");
        //Fetch KPA Users
        let kpaUserAPI = new api_1.KPAUserAPI(this.kpaToken);
        let kpaExistUsers = await kpaUserAPI.getAllUser();
        status.totalExistingRecord = kpaExistUsers.length;
        (0, util_1.debuglog)('log:spectrum:user')(JSON.stringify(kpaExistUsers, null, 2));
        let kpaUsers = [];
        for (var companyCode of this.companyCodes) {
            //Fetch Spectrum Users
            let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, companyCode);
            //Get Active Users
            let users = await spectrumAPI.getUsers('A');
            status.totalSourceRecord = users.length;
            //Loop Spectrum Users
            for (let user of users) {
                var kpaUser = null;
                for (let i = 0; i < kpaExistUsers.length; i++) {
                    const kpaExistUser = kpaExistUsers[i];
                    const employeeCode = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                    if (kpaExistUser.employeeNumber === employeeCode) {
                        kpaUser = kpaExistUser;
                        kpaExistUsers.splice(i, 1);
                        break;
                    }
                }
                //Build KPA user Data and Check existing
                if (kpaUser == null) {
                    kpaUser = new model_1.KPAUserModel();
                }
                else {
                    if (!this.isEditUser) {
                        status.skippedRecord++;
                        continue;
                    }
                }
                //Create Users
                kpaUser.employeeNumber = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                kpaUser.firstName = user.firstName;
                kpaUser.lastName = user.lastName;
                kpaUser.username = `${companyCode.trim()}-${user.employeeCode.trim()}`;
                kpaUser.email = '';
                kpaUser.initialPassword = `KPAFlex2024!!`;
                kpaUser.role = this.defaultRole;
                kpaUser.title = user.title;
                kpaUser.welcomeEmail = this.welcomeEmail;
                kpaUser.resetPassword = this.resetPassword;
                kpaUser.terminationDate == null;
                //Add User To List
                kpaUsers.push(kpaUser);
                status.upsertRecord++;
            }
            // Update remaining kpaUsers as not active for this company code
            if (this.isEditUser && companyCode.trim()) {
                // Remaining existing users
                for (let i = 0; i < kpaExistUsers.length; i++) {
                    const kpaExistUser = kpaExistUsers[i];
                    // Check for employeeNumber starts with companyCode-
                    if (kpaExistUser.employeeNumber.startsWith(`${companyCode.trim()}-`) && kpaExistUser.terminationDate == null) {
                        kpaExistUser.terminationDate = new Date().toDateString();
                        (0, util_1.debuglog)('log:spectrum:user')(`Existing user need to Check ${kpaExistUser.terminationDate}`);
                        //Update User To List
                        kpaUsers.push(kpaExistUser);
                        status.upsertRecord++;
                        status.inactivatedRecord++;
                    }
                }
            }
        }
        //Send Data
        (0, util_1.debuglog)('log:spectrum:user')(String(kpaUsers.length));
        const success = await kpaUserAPI.saveUser(this.kpaSite, kpaUsers, this.isEditUser);
        if (!success) {
            throw new Error('Failed to save Users:' + this.config.kpaSite);
        }
        (0, util_1.debuglog)('log:spectrum:user')("Execute SpectrumUserJob Done");
    }
}
exports.SpectrumUserJob = SpectrumUserJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tdXNlci1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tdXNlci1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQStEO0FBRS9ELCtEQUFtRTtBQUNuRSxnQ0FBcUM7QUFDckMsK0JBQWdDO0FBRWhDLE1BQWEsZUFBZTtJQWF4QixZQUFZLE1BQVc7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLElBQUksR0FBRyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQztRQUM3RCxJQUFJLENBQUMsV0FBVyxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsWUFBWSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENB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LENBQUM7d0JBQzVCLE1BQU0sQ0FBQyxZQUFZLEVBQUUsQ0FBQzt3QkFDdEIsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUM7b0JBQy9CLENBQUM7Z0JBQ0wsQ0FBQztZQUNMLENBQUM7UUFFTCxDQUFDO1FBRUQsV0FBVztRQUNYLElBQUEsZUFBUSxFQUFDLG1CQUFtQixDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFBO1FBQ3RELE1BQU0sT0FBTyxHQUFHLE1BQU0sVUFBVSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUE7UUFDbEYsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ25FLENBQUM7UUFDRCxJQUFBLGVBQVEsRUFBQyxtQkFBbUIsQ0FBQyxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDbEUsQ0FBQztDQUVKO0FBbEhELDBDQWtIQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtQQVVzZXJBUEkgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvYXBpXCI7XG5pbXBvcnQgeyBJSm9iLCBKb2JTdGF0dXMgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvam9iXCI7XG5pbXBvcnQgeyBLUEFVc2VyTW9kZWwgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvbW9kZWxcIjtcbmltcG9ydCB7IFNwZWN0cnVtQVBJIH0gZnJvbSBcIi4uL2FwaVwiO1xuaW1wb3J0IHsgZGVidWdsb2cgfSBmcm9tICd1dGlsJztcblxuZXhwb3J0IGNsYXNzIFNwZWN0cnVtVXNlckpvYiBpbXBsZW1lbnRzIElKb2Ige1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBrcGFTaXRlOiBzdHJpbmc7XG4gICAga3BhVG9rZW46IHN0cmluZztcbiAgICBzZXJ2ZXJVcmw6IHN0cmluZztcbiAgICBjb21wYW55Q29kZXM6IHN0cmluZ1tdO1xuICAgIGF1dGhvcml6YXRpb25JZDogc3RyaW5nO1xuICAgIGlzRWRpdFVzZXI6IGJvb2xlYW47XG4gICAgY29uZmlnOiBhbnk7XG4gICAgZGVmYXVsdFJvbGU6IHN0cmluZztcbiAgICB3ZWxjb21lRW1haWw6IGJvb2xlYW47XG4gICAgcmVzZXRQYXNzd29yZDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogYW55KSB7XG4gICAgICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgICAgIHRoaXMua3BhU2l0ZSA9IGNvbmZpZ1tcImtwYVNpdGVcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5uYW1lID0gJ1NwZWN0cnVtIFVzZXIgSm9iIC0gJyArIHRoaXMua3BhU2l0ZTtcbiAgICAgICAgdGhpcy5rcGFUb2tlbiA9IGNvbmZpZ1tcImtwYVRva2VuXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMuc2VydmVyVXJsID0gY29uZmlnW1wic2VydmVyVXJsXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMuY29tcGFueUNvZGVzID0gSlNPTi5wYXJzZShjb25maWdbXCJjb21wYW55Q29kZXNcIl1bXCJzdHJpbmdWYWx1ZVwiXSk7XG4gICAgICAgIHRoaXMuYXV0aG9yaXphdGlvbklkID0gY29uZmlnW1wiYXV0aG9yaXphdGlvbklkXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMuaXNFZGl0VXNlciA9IGNvbmZpZ1tcImlzRWRpdFVzZXJcIl1bXCJzdHJpbmdWYWx1ZVwiXSA9PSAnMSc7XG4gICAgICAgIHRoaXMuZGVmYXVsdFJvbGUgPSBjb25maWdbXCJkZWZhdWx0Um9sZVwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLndlbGNvbWVFbWFpbCA9IGNvbmZpZ1tcIndlbGNvbWVFbWFpbFwiXVtcInN0cmluZ1ZhbHVlXCJdID09PSAnMSc7XG4gICAgICAgIHRoaXMucmVzZXRQYXNzd29yZCA9IGNvbmZpZ1tcInJlc2V0UGFzc3dvcmRcIl1bXCJzdHJpbmdWYWx1ZVwiXSA9PT0gJzEnO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGUoc3RhdHVzOiBKb2JTdGF0dXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgZGVidWdsb2coJ2xvZzpzcGVjdHJ1bTp1c2VyJykoXCJFeGVjdXRlIFNwZWN0cnVtVXNlckpvYiBTdGFydFwiKTtcbiAgICAgICAgLy9GZXRjaCBLUEEgVXNlcnNcbiAgICAgICAgbGV0IGtwYVVzZXJBUEkgPSBuZXcgS1BBVXNlckFQSSh0aGlzLmtwYVRva2VuKTtcbiAgICAgICAgbGV0IGtwYUV4aXN0VXNlcnMgPSBhd2FpdCBrcGFVc2VyQVBJLmdldEFsbFVzZXIoKTtcbiAgICAgICAgc3RhdHVzLnRvdGFsRXhpc3RpbmdSZWNvcmQgPSBrcGFFeGlzdFVzZXJzLmxlbmd0aDtcbiAgICAgICAgZGVidWdsb2coJ2xvZzpzcGVjdHJ1bTp1c2VyJykoSlNPTi5zdHJpbmdpZnkoa3BhRXhpc3RVc2VycywgbnVsbCwgMikpO1xuXG4gICAgICAgIGxldCBrcGFVc2VycyA6IEtQQVVzZXJNb2RlbFtdID0gW107XG4gICAgICAgIGZvciAodmFyIGNvbXBhbnlDb2RlIG9mIHRoaXMuY29tcGFueUNvZGVzKSB7XG4gICAgICAgICAgICAvL0ZldGNoIFNwZWN0cnVtIFVzZXJzXG4gICAgICAgICAgICBsZXQgc3BlY3RydW1BUEkgPSBuZXcgU3BlY3RydW1BUEkodGhpcy5zZXJ2ZXJVcmwsIHRoaXMuYXV0aG9yaXphdGlvbklkLCBjb21wYW55Q29kZSk7XG4gICAgICAgICAgICAvL0dldCBBY3RpdmUgVXNlcnNcbiAgICAgICAgICAgIGxldCB1c2VycyA9IGF3YWl0IHNwZWN0cnVtQVBJLmdldFVzZXJzKCdBJyk7XG4gICAgICAgICAgICBzdGF0dXMudG90YWxTb3VyY2VSZWNvcmQgPSB1c2Vycy5sZW5ndGhcblxuICAgICAgICAgICAgLy9Mb29wIFNwZWN0cnVtIFVzZXJzXG4gICAgICAgICAgICBmb3IobGV0IHVzZXIgb2YgdXNlcnMpIHtcbiAgICAgICAgICAgICAgICB2YXIga3BhVXNlciA6IEtQQVVzZXJNb2RlbCB8IG51bGwgPSBudWxsO1xuICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga3BhRXhpc3RVc2Vycy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBrcGFFeGlzdFVzZXIgPSBrcGFFeGlzdFVzZXJzW2ldO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlbXBsb3llZUNvZGUgPSBgJHtjb21wYW55Q29kZS50cmltKCl9LSR7dXNlci5lbXBsb3llZUNvZGUudHJpbSgpfWA7XG4gICAgICAgICAgICAgICAgICAgIGlmIChrcGFFeGlzdFVzZXIuZW1wbG95ZWVOdW1iZXIgPT09IGVtcGxveWVlQ29kZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhVXNlciA9IGtwYUV4aXN0VXNlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYUV4aXN0VXNlcnMuc3BsaWNlKGksMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIC8vQnVpbGQgS1BBIHVzZXIgRGF0YSBhbmQgQ2hlY2sgZXhpc3RpbmdcbiAgICAgICAgICAgICAgICBpZiAoa3BhVXNlciA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGtwYVVzZXIgPSBuZXcgS1BBVXNlck1vZGVsKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRWRpdFVzZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cy5za2lwcGVkUmVjb3JkKytcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgLy9DcmVhdGUgVXNlcnNcbiAgICAgICAgICAgICAgICBrcGFVc2VyLmVtcGxveWVlTnVtYmVyID0gYCR7Y29tcGFueUNvZGUudHJpbSgpfS0ke3VzZXIuZW1wbG95ZWVDb2RlLnRyaW0oKX1gO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIuZmlyc3ROYW1lID0gdXNlci5maXJzdE5hbWVcbiAgICAgICAgICAgICAgICBrcGFVc2VyLmxhc3ROYW1lID0gdXNlci5sYXN0TmFtZTtcbiAgICAgICAgICAgICAgICBrcGFVc2VyLnVzZXJuYW1lID0gYCR7Y29tcGFueUNvZGUudHJpbSgpfS0ke3VzZXIuZW1wbG95ZWVDb2RlLnRyaW0oKX1gO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIuZW1haWwgPSAnJztcbiAgICAgICAgICAgICAgICBrcGFVc2VyLmluaXRpYWxQYXNzd29yZCA9IGBLUEFGbGV4MjAyNCEhYDtcbiAgICAgICAgICAgICAgICBrcGFVc2VyLnJvbGUgPSB0aGlzLmRlZmF1bHRSb2xlO1xuICAgICAgICAgICAgICAgIGtwYVVzZXIudGl0bGUgPSB1c2VyLnRpdGxlXG4gICAgICAgICAgICAgICAga3BhVXNlci53ZWxjb21lRW1haWwgPSB0aGlzLndlbGNvbWVFbWFpbFxuICAgICAgICAgICAgICAgIGtwYVVzZXIucmVzZXRQYXNzd29yZCA9IHRoaXMucmVzZXRQYXNzd29yZFxuICAgICAgICAgICAgICAgIGtwYVVzZXIudGVybWluYXRpb25EYXRlID09IG51bGxcblxuICAgICAgICAgICAgICAgIC8vQWRkIFVzZXIgVG8gTGlzdFxuICAgICAgICAgICAgICAgIGtwYVVzZXJzLnB1c2goa3BhVXNlcik7XG4gICAgICAgICAgICAgICAgc3RhdHVzLnVwc2VydFJlY29yZCsrO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFVwZGF0ZSByZW1haW5pbmcga3BhVXNlcnMgYXMgbm90IGFjdGl2ZSBmb3IgdGhpcyBjb21wYW55IGNvZGVcbiAgICAgICAgICAgIGlmICh0aGlzLmlzRWRpdFVzZXIgJiYgY29tcGFueUNvZGUudHJpbSgpKSB7XG4gICAgICAgICAgICAgICAgLy8gUmVtYWluaW5nIGV4aXN0aW5nIHVzZXJzXG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrcGFFeGlzdFVzZXJzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtwYUV4aXN0VXNlciA9IGtwYUV4aXN0VXNlcnNbaV07XG4gICAgICAgICAgICAgICAgICAgIC8vIENoZWNrIGZvciBlbXBsb3llZU51bWJlciBzdGFydHMgd2l0aCBjb21wYW55Q29kZS1cbiAgICAgICAgICAgICAgICAgICAgaWYoa3BhRXhpc3RVc2VyLmVtcGxveWVlTnVtYmVyLnN0YXJ0c1dpdGgoYCR7Y29tcGFueUNvZGUudHJpbSgpfS1gKSAmJiBrcGFFeGlzdFVzZXIudGVybWluYXRpb25EYXRlID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYUV4aXN0VXNlci50ZXJtaW5hdGlvbkRhdGUgPSBuZXcgRGF0ZSgpLnRvRGF0ZVN0cmluZygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZGVidWdsb2coJ2xvZzpzcGVjdHJ1bTp1c2VyJykoYEV4aXN0aW5nIHVzZXIgbmVlZCB0byBDaGVjayAke2twYUV4aXN0VXNlci50ZXJtaW5hdGlvbkRhdGV9YClcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vVXBkYXRlIFVzZXIgVG8gTGlzdFxuICAgICAgICAgICAgICAgICAgICAgICAga3BhVXNlcnMucHVzaChrcGFFeGlzdFVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnVwc2VydFJlY29yZCsrO1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLmluYWN0aXZhdGVkUmVjb3JkKys7ICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gXG4gICAgICAgIH1cblxuICAgICAgICAvL1NlbmQgRGF0YVxuICAgICAgICBkZWJ1Z2xvZygnbG9nOnNwZWN0cnVtOnVzZXInKShTdHJpbmcoa3BhVXNlcnMubGVuZ3RoKSlcbiAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGtwYVVzZXJBUEkuc2F2ZVVzZXIodGhpcy5rcGFTaXRlLCBrcGFVc2VycywgdGhpcy5pc0VkaXRVc2VyKVxuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHNhdmUgVXNlcnM6JyArIHRoaXMuY29uZmlnLmtwYVNpdGUpO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdsb2c6c3BlY3RydW06dXNlcicpKFwiRXhlY3V0ZSBTcGVjdHJ1bVVzZXJKb2IgRG9uZVwiKTtcbiAgICB9XG5cbn1cbiJdfQ==