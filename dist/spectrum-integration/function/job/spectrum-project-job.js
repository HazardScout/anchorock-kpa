"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumProjectJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const api_2 = require("../api");
const model_1 = require("../../../base-integration/src/model");
const util_1 = require("util");
class SpectrumProjectJob {
    constructor(config) {
        this.name = 'Spectrum Project Job';
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCodes = JSON.parse(config["companyCodes"]["stringValue"]);
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditProject = config["isEditProject"]["stringValue"] == '1';
    }
    async execute(status) {
        (0, util_1.debuglog)('log:spectrum:project')("Execute SpectrumProjectJob Start");
        //Fetch KPA Projects
        let kpaProjectAPI = new api_1.KPAProjectAPI(this.kpaToken);
        // let kpaExistProjects = await kpaProjectAPI.getAllProject();
        let kpaExistProjects = [];
        status.totalExistingRecord = kpaExistProjects.length;
        //Loop Spectrum Projects
        let kpaProjects = [];
        for (var companyCode of this.companyCodes) {
            //Fetch Spectrum Projects
            let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, companyCode);
            let projects = await spectrumAPI.getProjects();
            status.totalSourceRecord = projects.length;
            for (let project of projects) {
                var kpaProject = null;
                for (let i = 0; i < kpaExistProjects.length; i++) {
                    const kpaExistProject = kpaExistProjects[i];
                    if (kpaExistProject.code === project.jobNumber) {
                        kpaProject = kpaExistProject;
                        kpaExistProjects.splice(i, 1);
                        break;
                    }
                }
                if (kpaProject == null) {
                    kpaProject = new model_1.KPAProjectModel();
                }
                else {
                    if (!this.isEditProject) {
                        status.skippedRecord++;
                        continue;
                    }
                }
                //Build KPA project Data and Check existing
                kpaProject.name = project.jobDescription;
                kpaProject.code = project.jobNumber;
                kpaProject.isActive = project.statusCode === "A";
                kpaProject.address = project.address;
                kpaProject.city = project.city;
                kpaProject.state = project.state;
                kpaProject.zip = project.zipCode;
                //Add Projects To List
                kpaProjects.push(kpaProject);
                status.upsertRecord++;
            }
        }
        //Send Data
        (0, util_1.debuglog)('log:spectrum:project')(String(kpaProjects.length));
        const success = await kpaProjectAPI.saveProject(this.kpaSite, kpaProjects);
        if (!success) {
            throw new Error('Failed to save Projects:' + this.config.kpaSite);
        }
        (0, util_1.debuglog)('log:spectrum:project')("Execute SpectrumProjectJob Done");
    }
}
exports.SpectrumProjectJob = SpectrumProjectJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tcHJvamVjdC1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tcHJvamVjdC1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMkRBQWtFO0FBQ2xFLGdDQUFxQztBQUNyQywrREFBc0U7QUFDdEUsK0JBQWdDO0FBRWhDLE1BQWEsa0JBQWtCO0lBVTNCLFlBQVksTUFBVztRQUNuQixJQUFJLENBQUMsSUFBSSxHQUFHLHNCQUFzQixDQUFDO1FBQ25DLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztRQUN0RSxJQUFJLENBQUMsZUFBZSxHQUFHLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2hFLElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQztJQUN2RSxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFpQjtRQUMzQixJQUFBLGVBQVEsRUFBQyxzQkFBc0IsQ0FBQyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7UUFDckUsb0JBQW9CO1FBQ3BCLElBQUksYUFBYSxHQUFHLElBQUks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LGlDQUFpQyxDQUFDLENBQUM7SUFDeEUsQ0FBQztDQUVKO0FBcEZELGdEQW9GQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElKb2IsIEpvYlN0YXR1cyB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9qb2JcIjtcbmltcG9ydCB7IEtQQVByb2plY3RBUEkgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvYXBpXCI7XG5pbXBvcnQgeyBTcGVjdHJ1bUFQSSB9IGZyb20gXCIuLi9hcGlcIjtcbmltcG9ydCB7IEtQQVByb2plY3RNb2RlbCB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9tb2RlbFwiO1xuaW1wb3J0IHsgZGVidWdsb2cgfSBmcm9tICd1dGlsJztcblxuZXhwb3J0IGNsYXNzIFNwZWN0cnVtUHJvamVjdEpvYiBpbXBsZW1lbnRzIElKb2Ige1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBrcGFTaXRlOiBzdHJpbmc7XG4gICAga3BhVG9rZW46IHN0cmluZztcbiAgICBzZXJ2ZXJVcmw6IHN0cmluZztcbiAgICBjb21wYW55Q29kZXM6IHN0cmluZ1tdO1xuICAgIGF1dGhvcml6YXRpb25JZDogc3RyaW5nO1xuICAgIGlzRWRpdFByb2plY3Q6IGJvb2xlYW47XG4gICAgY29uZmlnOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IGFueSkge1xuICAgICAgICB0aGlzLm5hbWUgPSAnU3BlY3RydW0gUHJvamVjdCBKb2InO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmtwYVNpdGUgPSBjb25maWdbXCJrcGFTaXRlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMua3BhVG9rZW4gPSBjb25maWdbXCJrcGFUb2tlblwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLnNlcnZlclVybCA9IGNvbmZpZ1tcInNlcnZlclVybFwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmNvbXBhbnlDb2RlcyA9IEpTT04ucGFyc2UoY29uZmlnW1wiY29tcGFueUNvZGVzXCJdW1wic3RyaW5nVmFsdWVcIl0pO1xuICAgICAgICB0aGlzLmF1dGhvcml6YXRpb25JZCA9IGNvbmZpZ1tcImF1dGhvcml6YXRpb25JZFwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmlzRWRpdFByb2plY3QgPSBjb25maWdbXCJpc0VkaXRQcm9qZWN0XCJdW1wic3RyaW5nVmFsdWVcIl0gPT0gJzEnO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGUoc3RhdHVzOiBKb2JTdGF0dXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgZGVidWdsb2coJ2xvZzpzcGVjdHJ1bTpwcm9qZWN0JykoXCJFeGVjdXRlIFNwZWN0cnVtUHJvamVjdEpvYiBTdGFydFwiKTtcbiAgICAgICAgLy9GZXRjaCBLUEEgUHJvamVjdHNcbiAgICAgICAgbGV0IGtwYVByb2plY3RBUEkgPSBuZXcgS1BBUHJvamVjdEFQSSh0aGlzLmtwYVRva2VuKTtcbiAgICAgICAgLy8gbGV0IGtwYUV4aXN0UHJvamVjdHMgPSBhd2FpdCBrcGFQcm9qZWN0QVBJLmdldEFsbFByb2plY3QoKTtcbiAgICAgICAgbGV0IGtwYUV4aXN0UHJvamVjdHMgOiBLUEFQcm9qZWN0TW9kZWxbXSA9IFtdO1xuICAgICAgICBzdGF0dXMudG90YWxFeGlzdGluZ1JlY29yZCA9IGtwYUV4aXN0UHJvamVjdHMubGVuZ3RoXG5cblxuICAgICAgICAvL0xvb3AgU3BlY3RydW0gUHJvamVjdHNcbiAgICAgICAgbGV0IGtwYVByb2plY3RzOiBLUEFQcm9qZWN0TW9kZWxbXSA9IFtdO1xuICAgICAgICBmb3IgKHZhciBjb21wYW55Q29kZSBvZiB0aGlzLmNvbXBhbnlDb2Rlcykge1xuICAgICAgICAgICAgLy9GZXRjaCBTcGVjdHJ1bSBQcm9qZWN0c1xuICAgICAgICAgICAgbGV0IHNwZWN0cnVtQVBJID0gbmV3IFNwZWN0cnVtQVBJKHRoaXMuc2VydmVyVXJsLCB0aGlzLmF1dGhvcml6YXRpb25JZCwgY29tcGFueUNvZGUpXG4gICAgICAgICAgICBsZXQgcHJvamVjdHMgPSBhd2FpdCBzcGVjdHJ1bUFQSS5nZXRQcm9qZWN0cygpO1xuICAgICAgICAgICAgc3RhdHVzLnRvdGFsU291cmNlUmVjb3JkID0gcHJvamVjdHMubGVuZ3RoXG5cbiAgICAgICAgICAgIGZvcihsZXQgcHJvamVjdCBvZiBwcm9qZWN0cykge1xuXG4gICAgICAgICAgICAgICAgdmFyIGtwYVByb2plY3QgOiBLUEFQcm9qZWN0TW9kZWwgfCBudWxsID0gbnVsbDtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtwYUV4aXN0UHJvamVjdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qga3BhRXhpc3RQcm9qZWN0ID0ga3BhRXhpc3RQcm9qZWN0c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGtwYUV4aXN0UHJvamVjdC5jb2RlID09PSBwcm9qZWN0LmpvYk51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdCA9IGtwYUV4aXN0UHJvamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYUV4aXN0UHJvamVjdHMuc3BsaWNlKGksMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChrcGFQcm9qZWN0ID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdCA9IG5ldyBLUEFQcm9qZWN0TW9kZWwoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBpZiAoIXRoaXMuaXNFZGl0UHJvamVjdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnNraXBwZWRSZWNvcmQrK1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAvL0J1aWxkIEtQQSBwcm9qZWN0IERhdGEgYW5kIENoZWNrIGV4aXN0aW5nXG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC5uYW1lID0gcHJvamVjdC5qb2JEZXNjcmlwdGlvbjtcbiAgICAgICAgICAgICAgICBrcGFQcm9qZWN0LmNvZGUgPSBwcm9qZWN0LmpvYk51bWJlcjtcbiAgICAgICAgICAgICAgICBrcGFQcm9qZWN0LmlzQWN0aXZlID0gcHJvamVjdC5zdGF0dXNDb2RlID09PSBcIkFcIlxuICAgICAgICAgICAgICAgIGtwYVByb2plY3QuYWRkcmVzcyA9IHByb2plY3QuYWRkcmVzcztcbiAgICAgICAgICAgICAgICBrcGFQcm9qZWN0LmNpdHkgPSBwcm9qZWN0LmNpdHk7XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC5zdGF0ZSA9IHByb2plY3Quc3RhdGU7XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC56aXAgPSBwcm9qZWN0LnppcENvZGU7XG5cbiAgICAgICAgICAgICAgICAvL0FkZCBQcm9qZWN0cyBUbyBMaXN0XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdHMucHVzaChrcGFQcm9qZWN0KTtcbiAgICAgICAgICAgICAgICBzdGF0dXMudXBzZXJ0UmVjb3JkKytcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vU2VuZCBEYXRhXG4gICAgICAgIGRlYnVnbG9nKCdsb2c6c3BlY3RydW06cHJvamVjdCcpKFN0cmluZyhrcGFQcm9qZWN0cy5sZW5ndGgpKVxuICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQga3BhUHJvamVjdEFQSS5zYXZlUHJvamVjdCh0aGlzLmtwYVNpdGUsIGtwYVByb2plY3RzKVxuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHNhdmUgUHJvamVjdHM6JyArIHRoaXMuY29uZmlnLmtwYVNpdGUpO1xuICAgICAgICB9XG4gICAgICAgIGRlYnVnbG9nKCdsb2c6c3BlY3RydW06cHJvamVjdCcpKFwiRXhlY3V0ZSBTcGVjdHJ1bVByb2plY3RKb2IgRG9uZVwiKTtcbiAgICB9XG5cbn1cbiJdfQ==