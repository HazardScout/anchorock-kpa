"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumProjectJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const api_2 = require("../api");
const model_1 = require("../../../base-integration/src/model");
class SpectrumProjectJob {
    constructor(config) {
        this.name = 'Spectrum Project Job';
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.serverUrl = config["serverUrl"]["stringValue"];
        this.companyCodes = JSON.parse(config["companyCodes"]["stringValue"]);
        this.authorizationId = config["authorizationId"]["stringValue"];
        this.isEditProject = config["isEditProject"]["stringValue"] == '1';
    }
    async execute(status) {
        console.log("Execute SpectrumProjectJob Start");
        try {
            //Fetch KPA Projects
            let kpaProjectAPI = new api_1.KPAProjectAPI(this.kpaToken);
            // let kpaExistProjects = await kpaProjectAPI.getAllProject();
            let kpaExistProjects = [];
            status.totalExistingRecord = kpaExistProjects.length;
            //Loop Spectrum Projects
            let kpaProjects = [];
            for (var companyCode of this.companyCodes) {
                //Fetch Spectrum Projects
                let spectrumAPI = new api_2.SpectrumAPI(this.serverUrl, this.authorizationId, companyCode);
                let projects = await spectrumAPI.getProjects();
                status.totalSourceRecord = projects.length;
                for (let project of projects) {
                    var kpaProject = null;
                    for (let i = 0; i < kpaExistProjects.length; i++) {
                        const kpaExistProject = kpaExistProjects[i];
                        if (kpaExistProject.code === project.jobNumber) {
                            kpaProject = kpaExistProject;
                            kpaExistProjects.splice(i, 1);
                            break;
                        }
                    }
                    if (kpaProject == null) {
                        kpaProject = new model_1.KPAProjectModel();
                    }
                    else {
                        if (!this.isEditProject) {
                            // console.log(`Skip Project because of Cannot Allow to edit ${project.jobName}`)
                            status.skippedRecord++;
                            continue;
                        }
                    }
                    //Build KPA project Data and Check existing
                    kpaProject.name = project.jobDescription;
                    kpaProject.code = project.jobNumber;
                    kpaProject.isActive = project.statusCode === "A";
                    kpaProject.address = project.address;
                    kpaProject.city = project.city;
                    kpaProject.state = project.state;
                    kpaProject.zip = project.zipCode;
                    //Add Projects To List
                    kpaProjects.push(kpaProject);
                    status.upsertRecord++;
                }
            }
            //Send Data
            console.log(kpaProjects.length);
            const success = await kpaProjectAPI.saveProject(this.kpaSite, kpaProjects);
            if (!success) {
                console.log('Failed to save Project');
            }
        }
        catch (e) {
            console.log(`Worker Stop with Error : ${e}`);
        }
        console.log("Execute SpectrumProjectJob Done");
    }
}
exports.SpectrumProjectJob = SpectrumProjectJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tcHJvamVjdC1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tcHJvamVjdC1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMkRBQWtFO0FBQ2xFLGdDQUFxQztBQUNyQywrREFBc0U7QUFFdEUsTUFBYSxrQkFBa0I7SUFVM0IsWUFBWSxNQUFXO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsc0JBQXNCLENBQUM7UUFDbkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDcEQsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxlQUFlLEdBQUcsTUFBTSxDQUFDLGlCQUFpQixDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQWlCO1FBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUM7WUFDRCxvQkFBb0I7WUFDcEIsSUFBSSxhQUFhLEdBQUcsSUFBSSxtQkFBYSxDQUFD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Q0FBQTtRQUNoRCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7Q0FFSjtBQXpGRCxnREF5RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJSm9iLCBKb2JTdGF0dXMgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvam9iXCI7XG5pbXBvcnQgeyBLUEFQcm9qZWN0QVBJIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2FwaVwiO1xuaW1wb3J0IHsgU3BlY3RydW1BUEkgfSBmcm9tIFwiLi4vYXBpXCI7XG5pbXBvcnQgeyBLUEFQcm9qZWN0TW9kZWwgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvbW9kZWxcIjtcblxuZXhwb3J0IGNsYXNzIFNwZWN0cnVtUHJvamVjdEpvYiBpbXBsZW1lbnRzIElKb2Ige1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBrcGFTaXRlOiBzdHJpbmc7XG4gICAga3BhVG9rZW46IHN0cmluZztcbiAgICBzZXJ2ZXJVcmw6IHN0cmluZztcbiAgICBjb21wYW55Q29kZXM6IHN0cmluZ1tdO1xuICAgIGF1dGhvcml6YXRpb25JZDogc3RyaW5nO1xuICAgIGlzRWRpdFByb2plY3Q6IGJvb2xlYW47XG4gICAgY29uZmlnOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IGFueSkge1xuICAgICAgICB0aGlzLm5hbWUgPSAnU3BlY3RydW0gUHJvamVjdCBKb2InO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmtwYVNpdGUgPSBjb25maWdbXCJrcGFTaXRlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMua3BhVG9rZW4gPSBjb25maWdbXCJrcGFUb2tlblwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLnNlcnZlclVybCA9IGNvbmZpZ1tcInNlcnZlclVybFwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmNvbXBhbnlDb2RlcyA9IEpTT04ucGFyc2UoY29uZmlnW1wiY29tcGFueUNvZGVzXCJdW1wic3RyaW5nVmFsdWVcIl0pO1xuICAgICAgICB0aGlzLmF1dGhvcml6YXRpb25JZCA9IGNvbmZpZ1tcImF1dGhvcml6YXRpb25JZFwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmlzRWRpdFByb2plY3QgPSBjb25maWdbXCJpc0VkaXRQcm9qZWN0XCJdW1wic3RyaW5nVmFsdWVcIl0gPT0gJzEnO1xuICAgIH1cblxuICAgIGFzeW5jIGV4ZWN1dGUoc3RhdHVzOiBKb2JTdGF0dXMpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc29sZS5sb2coXCJFeGVjdXRlIFNwZWN0cnVtUHJvamVjdEpvYiBTdGFydFwiKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vRmV0Y2ggS1BBIFByb2plY3RzXG4gICAgICAgICAgICBsZXQga3BhUHJvamVjdEFQSSA9IG5ldyBLUEFQcm9qZWN0QVBJKHRoaXMua3BhVG9rZW4pO1xuICAgICAgICAgICAgLy8gbGV0IGtwYUV4aXN0UHJvamVjdHMgPSBhd2FpdCBrcGFQcm9qZWN0QVBJLmdldEFsbFByb2plY3QoKTtcbiAgICAgICAgICAgIGxldCBrcGFFeGlzdFByb2plY3RzIDogS1BBUHJvamVjdE1vZGVsW10gPSBbXTtcbiAgICAgICAgICAgIHN0YXR1cy50b3RhbEV4aXN0aW5nUmVjb3JkID0ga3BhRXhpc3RQcm9qZWN0cy5sZW5ndGhcblxuXG4gICAgICAgICAgICAvL0xvb3AgU3BlY3RydW0gUHJvamVjdHNcbiAgICAgICAgICAgIGxldCBrcGFQcm9qZWN0czogS1BBUHJvamVjdE1vZGVsW10gPSBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGNvbXBhbnlDb2RlIG9mIHRoaXMuY29tcGFueUNvZGVzKSB7XG4gICAgICAgICAgICAgICAgLy9GZXRjaCBTcGVjdHJ1bSBQcm9qZWN0c1xuICAgICAgICAgICAgICAgIGxldCBzcGVjdHJ1bUFQSSA9IG5ldyBTcGVjdHJ1bUFQSSh0aGlzLnNlcnZlclVybCwgdGhpcy5hdXRob3JpemF0aW9uSWQsIGNvbXBhbnlDb2RlKVxuICAgICAgICAgICAgICAgIGxldCBwcm9qZWN0cyA9IGF3YWl0IHNwZWN0cnVtQVBJLmdldFByb2plY3RzKCk7XG4gICAgICAgICAgICAgICAgc3RhdHVzLnRvdGFsU291cmNlUmVjb3JkID0gcHJvamVjdHMubGVuZ3RoXG5cbiAgICAgICAgICAgICAgICBmb3IobGV0IHByb2plY3Qgb2YgcHJvamVjdHMpIHtcblxuICAgICAgICAgICAgICAgICAgICB2YXIga3BhUHJvamVjdCA6IEtQQVByb2plY3RNb2RlbCB8IG51bGwgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtwYUV4aXN0UHJvamVjdHMubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtwYUV4aXN0UHJvamVjdCA9IGtwYUV4aXN0UHJvamVjdHNbaV07XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa3BhRXhpc3RQcm9qZWN0LmNvZGUgPT09IHByb2plY3Quam9iTnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdCA9IGtwYUV4aXN0UHJvamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBrcGFFeGlzdFByb2plY3RzLnNwbGljZShpLDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgaWYgKGtwYVByb2plY3QgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdCA9IG5ldyBLUEFQcm9qZWN0TW9kZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkaXRQcm9qZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFNraXAgUHJvamVjdCBiZWNhdXNlIG9mIENhbm5vdCBBbGxvdyB0byBlZGl0ICR7cHJvamVjdC5qb2JOYW1lfWApXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnNraXBwZWRSZWNvcmQrK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAvL0J1aWxkIEtQQSBwcm9qZWN0IERhdGEgYW5kIENoZWNrIGV4aXN0aW5nXG4gICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QubmFtZSA9IHByb2plY3Quam9iRGVzY3JpcHRpb247XG4gICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QuY29kZSA9IHByb2plY3Quam9iTnVtYmVyO1xuICAgICAgICAgICAgICAgICAgICBrcGFQcm9qZWN0LmlzQWN0aXZlID0gcHJvamVjdC5zdGF0dXNDb2RlID09PSBcIkFcIlxuICAgICAgICAgICAgICAgICAgICBrcGFQcm9qZWN0LmFkZHJlc3MgPSBwcm9qZWN0LmFkZHJlc3M7XG4gICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QuY2l0eSA9IHByb2plY3QuY2l0eTtcbiAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdC5zdGF0ZSA9IHByb2plY3Quc3RhdGU7XG4gICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QuemlwID0gcHJvamVjdC56aXBDb2RlO1xuXG4gICAgICAgICAgICAgICAgICAgIC8vQWRkIFByb2plY3RzIFRvIExpc3RcbiAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdHMucHVzaChrcGFQcm9qZWN0KTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnVwc2VydFJlY29yZCsrXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvL1NlbmQgRGF0YVxuICAgICAgICAgICAgY29uc29sZS5sb2coa3BhUHJvamVjdHMubGVuZ3RoKVxuICAgICAgICAgICAgY29uc3Qgc3VjY2VzcyA9IGF3YWl0IGtwYVByb2plY3RBUEkuc2F2ZVByb2plY3QodGhpcy5rcGFTaXRlLCBrcGFQcm9qZWN0cylcbiAgICAgICAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gc2F2ZSBQcm9qZWN0JylcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgV29ya2VyIFN0b3Agd2l0aCBFcnJvciA6ICR7ZX1gKVxuICAgICAgICB9XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRXhlY3V0ZSBTcGVjdHJ1bVByb2plY3RKb2IgRG9uZVwiKTtcbiAgICB9XG5cbn0iXX0=