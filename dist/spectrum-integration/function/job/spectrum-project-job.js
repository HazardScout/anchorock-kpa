"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.SpectrumProjectJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const api_2 = require("../api");
const model_1 = require("../../../base-integration/src/model");
class SpectrumProjectJob {
    constructor(config) {
        this.name = 'Spectrum Project Job';
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.clientId = config["clientId"]["stringValue"];
        this.clientSecret = config["clientSecret"]["stringValue"];
        this.isEditProject = config["isEditProject"]["stringValue"] == '1';
    }
    async execute(status) {
        console.log("Execute SpectrumProjectJob Start");
        try {
            //Fetch KPA Projects
            let kpaProjectAPI = new api_1.KPAProjectAPI(this.kpaToken);
            // let kpaExistProjects = await kpaProjectAPI.getAllProject();
            let kpaExistProjects = [];
            status.totalExistingRecord = kpaExistProjects.length;
            //Fetch Spectrum Projects
            let spectrumAPI = new api_2.SpectrumAPI(this.clientId, this.clientSecret);
            let projects = await spectrumAPI.getProjects();
            status.totalSourceRecord = projects.length;
            //Loop Spectrum Projects
            let kpaProjects = [];
            for (let project of projects) {
                //Ignore Project without job number
                if (project.jobNumber === null || project.jobNumber === '') {
                    status.skippedRecord++;
                    continue;
                }
                var kpaProject = null;
                for (let i = 0; i < kpaExistProjects.length; i++) {
                    const kpaExistProject = kpaExistProjects[i];
                    if (kpaExistProject.name === project.jobDescription && kpaExistProject.code === project.jobNumber) {
                        kpaProject = kpaExistProject;
                        kpaExistProjects.splice(i, 1);
                        break;
                    }
                }
                if (kpaProject == null) {
                    kpaProject = new model_1.KPAProjectModel();
                }
                else {
                    if (!this.isEditProject) {
                        // console.log(`Skip Project because of Cannot Allow to edit ${project.jobName}`)
                        status.skippedRecord++;
                        continue;
                    }
                }
                //Build KPA project Data and Check existing
                kpaProject.name = project.jobDescription;
                kpaProject.code = project.jobNumber;
                kpaProject.isActive = project.statusCode === "Active";
                kpaProject.address = project.address;
                kpaProject.city = project.city;
                kpaProject.state = project.state;
                kpaProject.zip = project.zipCode;
                //Add Projects To List
                kpaProjects.push(kpaProject);
                status.upsertRecord++;
            }
            //Send Data
            console.log(kpaProjects.length);
            const success = await kpaProjectAPI.saveProject(this.kpaSite, kpaProjects);
            if (!success) {
                console.log('Failed to save Project');
            }
        }
        catch (e) {
            console.log(`Worker Stop with Error : ${e}`);
        }
        console.log("Execute SpectrumProjectJob Done");
    }
}
exports.SpectrumProjectJob = SpectrumProjectJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3BlY3RydW0tcHJvamVjdC1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcGVjdHJ1bS1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivc3BlY3RydW0tcHJvamVjdC1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsMkRBQWtFO0FBQ2xFLGdDQUFxQztBQUNyQywrREFBc0U7QUFFdEUsTUFBYSxrQkFBa0I7SUFTM0IsWUFBWSxNQUFXO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsc0JBQXNCLENBQUM7UUFDbkMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDbEQsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLGFBQWEsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUMsYUFBYSxDQUFDLElBQUksR0FBRyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTyxDQUFDLE1BQWlCO1FBQzNCLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0NBQWtDLENBQUMsQ0FBQztRQUNoRCxJQUFJLENBQUM7WUFDRCxvQkFBb0I7WUFDcEIsSUFBSSxhQUFhLEdBQUcsSUFBSSxtQkFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUNyRCw4REFBOEQ7WUFDOUQsSUFBSSxnQkFBZ0IsR0FBdUIsRUFBRSxDQUFDO1lBQzlDLE1BQU0sQ0FBQyxtQkFB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Q0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNoRCxDQUFDO1FBQ0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7Q0FFSjtBQXhGRCxnREF3RkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJSm9iLCBKb2JTdGF0dXMgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvam9iXCI7XG5pbXBvcnQgeyBLUEFQcm9qZWN0QVBJIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2FwaVwiO1xuaW1wb3J0IHsgU3BlY3RydW1BUEkgfSBmcm9tIFwiLi4vYXBpXCI7XG5pbXBvcnQgeyBLUEFQcm9qZWN0TW9kZWwgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvbW9kZWxcIjtcblxuZXhwb3J0IGNsYXNzIFNwZWN0cnVtUHJvamVjdEpvYiBpbXBsZW1lbnRzIElKb2Ige1xuICAgIG5hbWU6IHN0cmluZztcbiAgICBrcGFTaXRlOiBzdHJpbmc7XG4gICAga3BhVG9rZW46IHN0cmluZztcbiAgICBjbGllbnRJZDogc3RyaW5nO1xuICAgIGNsaWVudFNlY3JldDogc3RyaW5nO1xuICAgIGlzRWRpdFByb2plY3Q6IGJvb2xlYW47XG4gICAgY29uZmlnOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IGFueSkge1xuICAgICAgICB0aGlzLm5hbWUgPSAnU3BlY3RydW0gUHJvamVjdCBKb2InO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmtwYVNpdGUgPSBjb25maWdbXCJrcGFTaXRlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMua3BhVG9rZW4gPSBjb25maWdbXCJrcGFUb2tlblwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmNsaWVudElkID0gY29uZmlnW1wiY2xpZW50SWRcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5jbGllbnRTZWNyZXQgPSBjb25maWdbXCJjbGllbnRTZWNyZXRcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy5pc0VkaXRQcm9qZWN0ID0gY29uZmlnW1wiaXNFZGl0UHJvamVjdFwiXVtcInN0cmluZ1ZhbHVlXCJdID09ICcxJztcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlKHN0YXR1czogSm9iU3RhdHVzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiRXhlY3V0ZSBTcGVjdHJ1bVByb2plY3RKb2IgU3RhcnRcIik7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvL0ZldGNoIEtQQSBQcm9qZWN0c1xuICAgICAgICAgICAgbGV0IGtwYVByb2plY3RBUEkgPSBuZXcgS1BBUHJvamVjdEFQSSh0aGlzLmtwYVRva2VuKTtcbiAgICAgICAgICAgIC8vIGxldCBrcGFFeGlzdFByb2plY3RzID0gYXdhaXQga3BhUHJvamVjdEFQSS5nZXRBbGxQcm9qZWN0KCk7XG4gICAgICAgICAgICBsZXQga3BhRXhpc3RQcm9qZWN0cyA6IEtQQVByb2plY3RNb2RlbFtdID0gW107XG4gICAgICAgICAgICBzdGF0dXMudG90YWxFeGlzdGluZ1JlY29yZCA9IGtwYUV4aXN0UHJvamVjdHMubGVuZ3RoXG5cbiAgICAgICAgICAgIC8vRmV0Y2ggU3BlY3RydW0gUHJvamVjdHNcbiAgICAgICAgICAgIGxldCBzcGVjdHJ1bUFQSSA9IG5ldyBTcGVjdHJ1bUFQSSh0aGlzLmNsaWVudElkLCB0aGlzLmNsaWVudFNlY3JldClcbiAgICAgICAgICAgIGxldCBwcm9qZWN0cyA9IGF3YWl0IHNwZWN0cnVtQVBJLmdldFByb2plY3RzKCk7XG4gICAgICAgICAgICBzdGF0dXMudG90YWxTb3VyY2VSZWNvcmQgPSBwcm9qZWN0cy5sZW5ndGhcblxuICAgICAgICAgICAgLy9Mb29wIFNwZWN0cnVtIFByb2plY3RzXG4gICAgICAgICAgICBsZXQga3BhUHJvamVjdHM6IEtQQVByb2plY3RNb2RlbFtdID0gW107XG4gICAgICAgICAgICBmb3IobGV0IHByb2plY3Qgb2YgcHJvamVjdHMpIHtcbiAgICAgICAgICAgICAgICAvL0lnbm9yZSBQcm9qZWN0IHdpdGhvdXQgam9iIG51bWJlclxuICAgICAgICAgICAgICAgIGlmIChwcm9qZWN0LmpvYk51bWJlciA9PT0gbnVsbCB8fCBwcm9qZWN0LmpvYk51bWJlciA9PT0gJycpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnNraXBwZWRSZWNvcmQrK1xuICAgICAgICAgICAgICAgICAgICBjb250aW51ZVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHZhciBrcGFQcm9qZWN0IDogS1BBUHJvamVjdE1vZGVsIHwgbnVsbCA9IG51bGw7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrcGFFeGlzdFByb2plY3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGtwYUV4aXN0UHJvamVjdCA9IGtwYUV4aXN0UHJvamVjdHNbaV07XG4gICAgICAgICAgICAgICAgICAgIGlmIChrcGFFeGlzdFByb2plY3QubmFtZSA9PT0gcHJvamVjdC5qb2JEZXNjcmlwdGlvbiAmJiBrcGFFeGlzdFByb2plY3QuY29kZSA9PT0gcHJvamVjdC5qb2JOdW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QgPSBrcGFFeGlzdFByb2plY3Q7XG4gICAgICAgICAgICAgICAgICAgICAgICBrcGFFeGlzdFByb2plY3RzLnNwbGljZShpLDEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoa3BhUHJvamVjdCA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QgPSBuZXcgS1BBUHJvamVjdE1vZGVsKCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmlzRWRpdFByb2plY3QpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBTa2lwIFByb2plY3QgYmVjYXVzZSBvZiBDYW5ub3QgQWxsb3cgdG8gZWRpdCAke3Byb2plY3Quam9iTmFtZX1gKVxuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnNraXBwZWRSZWNvcmQrK1xuICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgLy9CdWlsZCBLUEEgcHJvamVjdCBEYXRhIGFuZCBDaGVjayBleGlzdGluZ1xuICAgICAgICAgICAgICAgIGtwYVByb2plY3QubmFtZSA9IHByb2plY3Quam9iRGVzY3JpcHRpb247XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC5jb2RlID0gcHJvamVjdC5qb2JOdW1iZXI7XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC5pc0FjdGl2ZSA9IHByb2plY3Quc3RhdHVzQ29kZSA9PT0gXCJBY3RpdmVcIlxuICAgICAgICAgICAgICAgIGtwYVByb2plY3QuYWRkcmVzcyA9IHByb2plY3QuYWRkcmVzcztcbiAgICAgICAgICAgICAgICBrcGFQcm9qZWN0LmNpdHkgPSBwcm9qZWN0LmNpdHk7XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC5zdGF0ZSA9IHByb2plY3Quc3RhdGU7XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdC56aXAgPSBwcm9qZWN0LnppcENvZGU7XG5cbiAgICAgICAgICAgICAgICAvL0FkZCBQcm9qZWN0cyBUbyBMaXN0XG4gICAgICAgICAgICAgICAga3BhUHJvamVjdHMucHVzaChrcGFQcm9qZWN0KTtcbiAgICAgICAgICAgICAgICBzdGF0dXMudXBzZXJ0UmVjb3JkKytcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vU2VuZCBEYXRhXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhrcGFQcm9qZWN0cy5sZW5ndGgpXG4gICAgICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQga3BhUHJvamVjdEFQSS5zYXZlUHJvamVjdCh0aGlzLmtwYVNpdGUsIGtwYVByb2plY3RzKVxuICAgICAgICAgICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBzYXZlIFByb2plY3QnKVxuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBXb3JrZXIgU3RvcCB3aXRoIEVycm9yIDogJHtlfWApXG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coXCJFeGVjdXRlIFNwZWN0cnVtUHJvamVjdEpvYiBEb25lXCIpO1xuICAgIH1cblxufSJdfQ==