"use strict";
var __classPrivateFieldGet = (this && this.__classPrivateFieldGet) || function (receiver, state, kind, f) {
    if (kind === "a" && !f) throw new TypeError("Private accessor was defined without a getter");
    if (typeof state === "function" ? receiver !== state || !f : !state.has(receiver)) throw new TypeError("Cannot read private member from an object whose class did not declare it");
    return kind === "m" ? f : kind === "a" ? f.call(receiver) : f ? f.value : state.get(receiver);
};
var _KPAUserAPI_instances, _KPAUserAPI_sendDataToKPA;
Object.defineProperty(exports, "__esModule", { value: true });
exports.KPAUserAPI = void 0;
const axios_1 = require("axios");
const model_1 = require("../model");
const utilities_1 = require("../utilities");
const util_1 = require("util");
class KPAUserAPI {
    constructor(token) {
        _KPAUserAPI_instances.add(this);
        this.token = token;
        this.apiInstance = axios_1.default.create({ baseURL: `https://api.${process.env.SITE_DOMAIN}/v1` });
    }
    async getAllUser() {
        let result = [];
        const { data } = await this.apiInstance.post('users.list', { token: this.token });
        for (var userData of data.users) {
            let user = Object.assign(new model_1.KPAUserModel(), userData);
            result.push(user);
        }
        return result;
    }
    async saveUser(site, models, isEditUSer) {
        var cleanRecords = [];
        var invalidRecords = [];
        for (var model of models) {
            //Ignore user without employee number
            if (model.employeeNumber === null || model.employeeNumber === '') {
                invalidRecords.push(model);
                continue;
            }
            var isDuplicate = false;
            for (let i = 0; i < cleanRecords.length; i++) {
                var clearRecord = cleanRecords[i];
                if (clearRecord.username === model.username || clearRecord.employeeNumber === model.employeeNumber || (clearRecord.email !== '' && clearRecord.email === model.email)) {
                    isDuplicate = true;
                    invalidRecords.push(model);
                    invalidRecords.push(clearRecord);
                    cleanRecords.splice(i, 1);
                    break;
                }
            }
            if (!isDuplicate) {
                for (var invalidRecord of invalidRecords) {
                    if (invalidRecord.username === model.username || invalidRecord.employeeNumber === model.employeeNumber || invalidRecord.email === model.email) {
                        isDuplicate = true;
                        invalidRecords.push(model);
                        break;
                    }
                }
            }
            if (!isDuplicate) {
                cleanRecords.push(model);
            }
        }
        if (cleanRecords.length > 0) {
            await __classPrivateFieldGet(this, _KPAUserAPI_instances, "m", _KPAUserAPI_sendDataToKPA).call(this, site, cleanRecords, isEditUSer);
        }
        if (invalidRecords.length > 0) {
            await __classPrivateFieldGet(this, _KPAUserAPI_instances, "m", _KPAUserAPI_sendDataToKPA).call(this, site, invalidRecords, isEditUSer);
        }
        return true;
    }
}
exports.KPAUserAPI = KPAUserAPI;
_KPAUserAPI_instances = new WeakSet(), _KPAUserAPI_sendDataToKPA = async function _KPAUserAPI_sendDataToKPA(site, models, isEditUSer) {
    var _a;
    let headers = '';
    if (isEditUSer) {
        headers = 'Site,RecordType,Name,EmployeeNumber,FirstName,LastName,Username,InitialPassword,Role,Title,Email,TerminationDate,ForcePasswordSelection,SendWelcomeEmail,UpdatePolicy';
    }
    else {
        headers = 'Site,RecordType,Name,EmployeeNumber,FirstName,LastName,Username,InitialPassword,Role,Title,Email,TerminationDate,ForcePasswordSelection,SendWelcomeEmail';
    }
    var jobTitles = [];
    for (var model of models) {
        if (model.title != null && model.title !== '' && jobTitles.indexOf(model.title.trim()) == -1) {
            jobTitles.push(model.title.trim());
        }
    }
    var content = `${headers}`;
    for (var jobTitle of jobTitles) {
        var dataUser = `${site},JobTitle`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(jobTitle)}`;
        content = `${content}\n${dataUser}`;
    }
    for (var model of models) {
        var dataUser = `${site},Employee,`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.employeeNumber)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.firstName)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.lastName)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.username)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.initialPassword)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.role)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.title)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker(model.email)}`;
        dataUser = `${dataUser},${utilities_1.Helper.csvContentChecker((_a = model.terminationDate) !== null && _a !== void 0 ? _a : '')}`;
        dataUser = `${dataUser},${model.resetPassword ? 'Y' : 'N'}`;
        dataUser = `${dataUser},${model.welcomeEmail ? 'Y' : 'N'}`;
        if (isEditUSer) {
            dataUser = `${dataUser},Always`;
        }
        content = `${content}\n${dataUser}`;
    }
    const fileData = Buffer.from(content, 'binary').toString('base64');
    const { data } = await this.apiInstance.post('dataload.create', {
        token: this.token,
        file: `data:text/csv;base64,${fileData}`,
        name: 'employees.csv',
        failureEmails: [],
        successEmails: []
    });
    (0, util_1.debuglog)('log:worker:dataload-response')('employees', data);
    if (!data.ok) {
        throw new Error(`${data.error}:${data.description}`);
    }
    return data.ok;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia3BhLXVzZXItYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvYXBpL2twYS11c2VyLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxpQ0FBcUM7QUFDckMsb0NBQXdDO0FBQ3hDLDRDQUFzQztBQUN0QywrQkFBZ0M7QUFFaEMsTUFBYSxVQUFVO0lBSW5CLFlBQVksS0FBYTs7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLFdBQVcsR0FBRyxlQUFLLENBQUMsTUFBTSxDQUFDLEVBQUMsT0FBTyxFQUFFLGVBQWUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEtBQUssRUFBQyxDQUFDLENBQUE7SUFDM0YsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVO1FBQ1osSUFBSSxNQUFNLEdBQW9CLEVBQUUsQ0FBQztRQUNqQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsTUFBTSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsRUFBQyxLQUFLLEVBQUMsSUFBSSxDQUFDLEtBQUssRUFBQyxDQUFDLENBQUM7UUFDL0UsS0FBSyxJQUFJLFFBQVEsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDOUIsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLG9CQUFZLEVBQUUsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN2RCxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLENBQUM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFZLEVBQUUsTUFBc0IsRUFBRSxVQUFtQjtRQUNwRSxJQUFJLFlBQVksR0FBb0IsRUFBRSxDQUFBO1FBQ3RDLElBQUksY0FBYyxHQUFvQixFQUFFLENBQUE7UUFFeEMs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d0JBQXdCLFFBQVEsRUFBRTtRQUN4QyxJQUFJLEVBQUUsZUFBZTtRQUNyQixhQUFhLEVBQUUsRUFBRTtRQUNqQixhQUFhLEVBQUUsRUFBRTtLQUNwQixDQUFDLENBQUM7SUFFSCxJQUFBLGVBQVEsRUFBQyw4QkFBOEIsQ0FBQyxDQUFDLFdBQVcsRUFBRSxJQUFJLENBQUMsQ0FBQTtJQUMzRCxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVELE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztBQUNuQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zLCB7IEF4aW9zIH0gZnJvbSBcImF4aW9zXCI7XG5pbXBvcnQgeyBLUEFVc2VyTW9kZWwgfSBmcm9tIFwiLi4vbW9kZWxcIjtcbmltcG9ydCB7IEhlbHBlciB9IGZyb20gXCIuLi91dGlsaXRpZXNcIjtcbmltcG9ydCB7IGRlYnVnbG9nIH0gZnJvbSAndXRpbCc7XG5cbmV4cG9ydCBjbGFzcyBLUEFVc2VyQVBJIHtcbiAgICB0b2tlbjogc3RyaW5nO1xuICAgIGFwaUluc3RhbmNlOiBBeGlvcztcblxuICAgIGNvbnN0cnVjdG9yKHRva2VuOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy50b2tlbiA9IHRva2VuO1xuICAgICAgICB0aGlzLmFwaUluc3RhbmNlID0gYXhpb3MuY3JlYXRlKHtiYXNlVVJMOiBgaHR0cHM6Ly9hcGkuJHtwcm9jZXNzLmVudi5TSVRFX0RPTUFJTn0vdjFgfSlcbiAgICB9XG5cbiAgICBhc3luYyBnZXRBbGxVc2VyKCk6UHJvbWlzZTxLUEFVc2VyTW9kZWxbXT4ge1xuICAgICAgICBsZXQgcmVzdWx0IDogS1BBVXNlck1vZGVsW10gPSBbXTtcbiAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwaUluc3RhbmNlLnBvc3QoJ3VzZXJzLmxpc3QnLCB7dG9rZW46dGhpcy50b2tlbn0pO1xuICAgICAgICBmb3IgKHZhciB1c2VyRGF0YSBvZiBkYXRhLnVzZXJzKSB7XG4gICAgICAgICAgICBsZXQgdXNlciA9IE9iamVjdC5hc3NpZ24obmV3IEtQQVVzZXJNb2RlbCgpLCB1c2VyRGF0YSk7XG4gICAgICAgICAgICByZXN1bHQucHVzaCh1c2VyKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGFzeW5jIHNhdmVVc2VyKHNpdGU6IHN0cmluZywgbW9kZWxzOiBLUEFVc2VyTW9kZWxbXSwgaXNFZGl0VVNlcjogYm9vbGVhbikgOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICAgICAgdmFyIGNsZWFuUmVjb3JkcyA6IEtQQVVzZXJNb2RlbFtdID0gW11cbiAgICAgICAgdmFyIGludmFsaWRSZWNvcmRzIDogS1BBVXNlck1vZGVsW10gPSBbXVxuXG4gICAgICAgIGZvciAodmFyIG1vZGVsIG9mIG1vZGVscykge1xuXG4gICAgICAgICAgICAvL0lnbm9yZSB1c2VyIHdpdGhvdXQgZW1wbG95ZWUgbnVtYmVyXG4gICAgICAgICAgICBpZiAobW9kZWwuZW1wbG95ZWVOdW1iZXIgPT09IG51bGwgfHwgbW9kZWwuZW1wbG95ZWVOdW1iZXIgPT09ICcnKSB7XG4gICAgICAgICAgICAgICAgaW52YWxpZFJlY29yZHMucHVzaChtb2RlbClcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIGlzRHVwbGljYXRlID0gZmFsc2U7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNsZWFuUmVjb3Jkcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBjbGVhclJlY29yZCA6IEtQQVVzZXJNb2RlbCA9IGNsZWFuUmVjb3Jkc1tpXTtcbiAgICAgICAgICAgICAgICBpZiAoY2xlYXJSZWNvcmQudXNlcm5hbWUgPT09IG1vZGVsLnVzZXJuYW1lIHx8IGNsZWFyUmVjb3JkLmVtcGxveWVlTnVtYmVyID09PSBtb2RlbC5lbXBsb3llZU51bWJlciB8fCAoY2xlYXJSZWNvcmQuZW1haWwgIT09ICcnICYmIGNsZWFyUmVjb3JkLmVtYWlsID09PSBtb2RlbC5lbWFpbCkpIHtcbiAgICAgICAgICAgICAgICAgICAgaXNEdXBsaWNhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBpbnZhbGlkUmVjb3Jkcy5wdXNoKG1vZGVsKVxuICAgICAgICAgICAgICAgICAgICBpbnZhbGlkUmVjb3Jkcy5wdXNoKGNsZWFyUmVjb3JkKVxuICAgICAgICAgICAgICAgICAgICBjbGVhblJlY29yZHMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghaXNEdXBsaWNhdGUpIHtcbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpbnZhbGlkUmVjb3JkIG9mIGludmFsaWRSZWNvcmRzKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChpbnZhbGlkUmVjb3JkLnVzZXJuYW1lID09PSBtb2RlbC51c2VybmFtZSB8fCBpbnZhbGlkUmVjb3JkLmVtcGxveWVlTnVtYmVyID09PSBtb2RlbC5lbXBsb3llZU51bWJlciB8fCBpbnZhbGlkUmVjb3JkLmVtYWlsID09PSBtb2RlbC5lbWFpbCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaXNEdXBsaWNhdGUgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgaW52YWxpZFJlY29yZHMucHVzaChtb2RlbClcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoIWlzRHVwbGljYXRlKSB7XG4gICAgICAgICAgICAgICAgY2xlYW5SZWNvcmRzLnB1c2gobW9kZWwpXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2xlYW5SZWNvcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuI3NlbmREYXRhVG9LUEEoc2l0ZSwgY2xlYW5SZWNvcmRzLCBpc0VkaXRVU2VyKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGludmFsaWRSZWNvcmRzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuI3NlbmREYXRhVG9LUEEoc2l0ZSwgaW52YWxpZFJlY29yZHMsIGlzRWRpdFVTZXIpXG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBhc3luYyAjc2VuZERhdGFUb0tQQShzaXRlOiBzdHJpbmcsIG1vZGVsczogS1BBVXNlck1vZGVsW10sIGlzRWRpdFVTZXI6IGJvb2xlYW4pIDogUHJvbWlzZTxib29sZWFuPiB7XG5cbiAgICAgICAgbGV0IGhlYWRlcnMgPSAnJztcbiAgICAgICAgaWYgKGlzRWRpdFVTZXIpIHtcbiAgICAgICAgICAgIGhlYWRlcnMgPSAnU2l0ZSxSZWNvcmRUeXBlLE5hbWUsRW1wbG95ZWVOdW1iZXIsRmlyc3ROYW1lLExhc3ROYW1lLFVzZXJuYW1lLEluaXRpYWxQYXNzd29yZCxSb2xlLFRpdGxlLEVtYWlsLFRlcm1pbmF0aW9uRGF0ZSxGb3JjZVBhc3N3b3JkU2VsZWN0aW9uLFNlbmRXZWxjb21lRW1haWwsVXBkYXRlUG9saWN5JztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGhlYWRlcnMgPSAnU2l0ZSxSZWNvcmRUeXBlLE5hbWUsRW1wbG95ZWVOdW1iZXIsRmlyc3ROYW1lLExhc3ROYW1lLFVzZXJuYW1lLEluaXRpYWxQYXNzd29yZCxSb2xlLFRpdGxlLEVtYWlsLFRlcm1pbmF0aW9uRGF0ZSxGb3JjZVBhc3N3b3JkU2VsZWN0aW9uLFNlbmRXZWxjb21lRW1haWwnO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGpvYlRpdGxlcyA9IFtdO1xuICAgICAgICBmb3IodmFyIG1vZGVsIG9mIG1vZGVscykge1xuICAgICAgICAgICAgaWYgKG1vZGVsLnRpdGxlICE9IG51bGwgJiYgbW9kZWwudGl0bGUgIT09ICcnICYmIGpvYlRpdGxlcy5pbmRleE9mKG1vZGVsLnRpdGxlLnRyaW0oKSkgPT0gLTEpIHtcbiAgICAgICAgICAgICAgICBqb2JUaXRsZXMucHVzaChtb2RlbC50aXRsZS50cmltKCkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNvbnRlbnQgPSBgJHtoZWFkZXJzfWA7XG5cbiAgICAgICAgZm9yKHZhciBqb2JUaXRsZSBvZiBqb2JUaXRsZXMpIHtcblxuICAgICAgICAgICAgdmFyIGRhdGFVc2VyID0gYCR7c2l0ZX0sSm9iVGl0bGVgXG4gICAgICAgICAgICBkYXRhVXNlciA9IGAke2RhdGFVc2VyfSwke0hlbHBlci5jc3ZDb250ZW50Q2hlY2tlcihqb2JUaXRsZSl9YFxuICAgICAgICAgICAgY29udGVudCA9IGAke2NvbnRlbnR9XFxuJHtkYXRhVXNlcn1gXG4gICAgICAgIH1cblxuICAgICAgICBmb3IodmFyIG1vZGVsIG9mIG1vZGVscykge1xuXG4gICAgICAgICAgICB2YXIgZGF0YVVzZXIgPSBgJHtzaXRlfSxFbXBsb3llZSxgXG4gICAgICAgICAgICBkYXRhVXNlciA9IGAke2RhdGFVc2VyfSwke0hlbHBlci5jc3ZDb250ZW50Q2hlY2tlcihtb2RlbC5lbXBsb3llZU51bWJlcil9YFxuICAgICAgICAgICAgZGF0YVVzZXIgPSBgJHtkYXRhVXNlcn0sJHtIZWxwZXIuY3N2Q29udGVudENoZWNrZXIobW9kZWwuZmlyc3ROYW1lKX1gXG4gICAgICAgICAgICBkYXRhVXNlciA9IGAke2RhdGFVc2VyfSwke0hlbHBlci5jc3ZDb250ZW50Q2hlY2tlcihtb2RlbC5sYXN0TmFtZSl9YFxuICAgICAgICAgICAgZGF0YVVzZXIgPSBgJHtkYXRhVXNlcn0sJHtIZWxwZXIuY3N2Q29udGVudENoZWNrZXIobW9kZWwudXNlcm5hbWUpfWBcbiAgICAgICAgICAgIGRhdGFVc2VyID0gYCR7ZGF0YVVzZXJ9LCR7SGVscGVyLmNzdkNvbnRlbnRDaGVja2VyKG1vZGVsLmluaXRpYWxQYXNzd29yZCl9YFxuICAgICAgICAgICAgZGF0YVVzZXIgPSBgJHtkYXRhVXNlcn0sJHtIZWxwZXIuY3N2Q29udGVudENoZWNrZXIobW9kZWwucm9sZSl9YFxuICAgICAgICAgICAgZGF0YVVzZXIgPSBgJHtkYXRhVXNlcn0sJHtIZWxwZXIuY3N2Q29udGVudENoZWNrZXIobW9kZWwudGl0bGUpfWBcbiAgICAgICAgICAgIGRhdGFVc2VyID0gYCR7ZGF0YVVzZXJ9LCR7SGVscGVyLmNzdkNvbnRlbnRDaGVja2VyKG1vZGVsLmVtYWlsKX1gXG4gICAgICAgICAgICBkYXRhVXNlciA9IGAke2RhdGFVc2VyfSwke0hlbHBlci5jc3ZDb250ZW50Q2hlY2tlcihtb2RlbC50ZXJtaW5hdGlvbkRhdGUgPz8gJycpfWBcbiAgICAgICAgICAgIGRhdGFVc2VyID0gYCR7ZGF0YVVzZXJ9LCR7bW9kZWwucmVzZXRQYXNzd29yZCA/ICdZJzogJ04nfWBcbiAgICAgICAgICAgIGRhdGFVc2VyID0gYCR7ZGF0YVVzZXJ9LCR7bW9kZWwud2VsY29tZUVtYWlsID8gJ1knOiAnTid9YFxuXG4gICAgICAgICAgICBpZiAoaXNFZGl0VVNlcikge1xuICAgICAgICAgICAgICAgIGRhdGFVc2VyID0gYCR7ZGF0YVVzZXJ9LEFsd2F5c2BcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29udGVudCA9IGAke2NvbnRlbnR9XFxuJHtkYXRhVXNlcn1gXG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBmaWxlRGF0YSA9IEJ1ZmZlci5mcm9tKGNvbnRlbnQsICdiaW5hcnknKS50b1N0cmluZygnYmFzZTY0Jyk7XG5cbiAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwaUluc3RhbmNlLnBvc3QoJ2RhdGFsb2FkLmNyZWF0ZScsIHtcbiAgICAgICAgICAgIHRva2VuOnRoaXMudG9rZW4sXG4gICAgICAgICAgICBmaWxlOiBgZGF0YTp0ZXh0L2NzdjtiYXNlNjQsJHtmaWxlRGF0YX1gLFxuICAgICAgICAgICAgbmFtZTogJ2VtcGxveWVlcy5jc3YnLFxuICAgICAgICAgICAgZmFpbHVyZUVtYWlsczogW10sXG4gICAgICAgICAgICBzdWNjZXNzRW1haWxzOiBbXVxuICAgICAgICB9KTtcblxuICAgICAgICBkZWJ1Z2xvZygnbG9nOndvcmtlcjpkYXRhbG9hZC1yZXNwb25zZScpKCdlbXBsb3llZXMnLCBkYXRhKVxuICAgICAgICBpZiAoIWRhdGEub2spIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgJHtkYXRhLmVycm9yfToke2RhdGEuZGVzY3JpcHRpb259YCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZGF0YS5vaztcbiAgICB9XG5cbn0iXX0=