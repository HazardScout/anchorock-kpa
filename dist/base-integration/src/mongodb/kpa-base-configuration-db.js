"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.KPABaseConfigurationDB = void 0;
const mongodb_1 = require("mongodb");
class KPABaseConfigurationDB {
    constructor() {
        this.mongoDbUrl = process.env.KPA_INTEGRATIONS_DB || 'no-database-found';
    }
    async getConfiguration(filter = {}) {
        let result = [];
        const mongoClient = await mongodb_1.MongoClient.connect(this.mongoDbUrl);
        const mongoDb = mongoClient.db();
        let mongoDbCollection = mongoDb.collection(this.collectionName);
        const findResult = await mongoDbCollection.find(filter).toArray();
        for (var data of findResult) {
            result.push(this.convertData(data));
        }
        await mongoClient.close();
        return result;
    }
    async getConfigurationByKpaToken(kpaToken) {
        let result = [];
        const mongoClient = await mongodb_1.MongoClient.connect(this.mongoDbUrl);
        const mongoDb = mongoClient.db();
        let mongoDbCollection = mongoDb.collection(this.collectionName);
        const findResult = await mongoDbCollection.find({ kpa_token: kpaToken }).toArray();
        for (var data of findResult) {
            result.push(this.convertData(data));
        }
        await mongoClient.close();
        if (result.length == 0) {
            return null;
        }
        return result[0];
    }
    async save(model) {
        const mongoClient = await mongodb_1.MongoClient.connect(this.mongoDbUrl);
        const mongoDb = mongoClient.db();
        let mongoDbCollection = mongoDb.collection(this.collectionName);
        const doc = model === null || model === void 0 ? void 0 : model.syncChanges();
        if (!doc) {
            throw new Error('no document to save');
        }
        const filter = { kpa_token: doc.kpa_token };
        const count = await mongoDbCollection.count(filter);
        if (count) {
            await mongoDbCollection.updateOne(filter, {
                $set: doc
            });
        }
        else {
            await mongoDbCollection.insertOne(doc);
        }
        await mongoClient.close();
        return model;
    }
}
exports.KPABaseConfigurationDB = KPABaseConfigurationDB;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoia3BhLWJhc2UtY29uZmlndXJhdGlvbi1kYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL21vbmdvZGIva3BhLWJhc2UtY29uZmlndXJhdGlvbi1kYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxxQ0FBZ0Q7QUFHaEQsTUFBc0Isc0JBQXNCO0lBSXhDO1FBQ0ksSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLG1CQUFtQixDQUFDO0lBQzdFLENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsU0FBYSxFQUFFO1FBQ2xDLElBQUksTUFBTSxHQUFRLEVBQUUsQ0FBQTtRQUNwQixNQUFNLFdBQVcsR0FBRyxNQUFNLHFCQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvRCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsRUFBRSxFQUFFLENBQUM7UUFFakMsSUFBSSxpQkFBaUIsR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUNoRSxNQUFNLFVBQVUsR0FBRyxNQUFNLGlCQUFpQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNsRSxLQUFJLElBQUksSUFBSSxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7UUFFRCxNQUFNLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUUxQixPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRUQsS0FBSyxDQUFDLDBCQUEwQixDQUFDLFFBQWdCO1FBQzdDLElBQUksTUFBTSxHQUFRLEVBQUUsQ0FBQTtRQUNwQixNQUFNLFdBQVcsR0FBRyxNQUFNLHFCQUFXLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvRCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsRUFBRSxDQUFDLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBRWhFLElBQUksaUJBQWlCLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDaEUsTUFBTSxVQUFVLEdBQUcsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsRUFBQyxTQUFTLEVBQUUsUUFBUSxFQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNqRixLQUFJLElBQUksSUFBSSxJQUFJLFVBQVUsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFBO1FBQ3ZDLENBQUM7UUFFRCxNQUFNLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUUxQixJQUFJLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDckIsT0FBTyxJQUFJLENBQUE7UUFDZixDQUFDO1FBRUQsT0FBTyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDcEIsQ0FBQztJQUVELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBZ0M7UUFDdkMsTUFBTSxXQUFXLEdBQUcsTUFBTSxxQkFBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDL0QsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFLENBQUMsQ0FBQTtRQUMvRCxJQUFJLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sR0FBRyxHQUFHLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxXQUFXLEVBQUUsQ0FBQztRQUNqQyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDUCxNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDM0MsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUM1QyxNQUFNLEtBQUssR0FBRyxNQUFNLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUVwRCxJQUFJLEtBQUssRUFBRSxDQUFDO1lBQ1IsTUFBTSxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFO2dCQUN0QyxJQUFJLEVBQUUsR0FBRzthQUNaLENBQUMsQ0FBQztRQUNQLENBQUM7YUFBTSxDQUFDO1lBQ0osTUFBTSxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0MsQ0FBQztRQUVELE1BQU0sV0FBVyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzFCLE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FHSjtBQXRFRCx3REFzRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEb2N1bWVudCwgTW9uZ29DbGllbnQgfSBmcm9tIFwibW9uZ29kYlwiO1xuaW1wb3J0IHsgS1BBQmFzZUNvbmZpZ3VyYXRpb25Nb2RlbCB9IGZyb20gXCIuLi9tb2RlbFwiO1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgS1BBQmFzZUNvbmZpZ3VyYXRpb25EQjxUPiB7XG4gICAgbW9uZ29EYlVybDogc3RyaW5nO1xuICAgIGFic3RyYWN0IGNvbGxlY3Rpb25OYW1lOiBzdHJpbmc7XG5cbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5tb25nb0RiVXJsID0gcHJvY2Vzcy5lbnYuS1BBX0lOVEVHUkFUSU9OU19EQiB8fCAnbm8tZGF0YWJhc2UtZm91bmQnO1xuICAgIH1cblxuICAgIGFzeW5jIGdldENvbmZpZ3VyYXRpb24oZmlsdGVyOmFueSA9IHt9KSA6IFByb21pc2U8VFtdPiB7XG4gICAgICAgIGxldCByZXN1bHQ6IFRbXSA9IFtdXG4gICAgICAgIGNvbnN0IG1vbmdvQ2xpZW50ID0gYXdhaXQgTW9uZ29DbGllbnQuY29ubmVjdCh0aGlzLm1vbmdvRGJVcmwpO1xuICAgICAgICBjb25zdCBtb25nb0RiID0gbW9uZ29DbGllbnQuZGIoKTtcblxuICAgICAgICBsZXQgbW9uZ29EYkNvbGxlY3Rpb24gPSBtb25nb0RiLmNvbGxlY3Rpb24odGhpcy5jb2xsZWN0aW9uTmFtZSk7XG4gICAgICAgIGNvbnN0IGZpbmRSZXN1bHQgPSBhd2FpdCBtb25nb0RiQ29sbGVjdGlvbi5maW5kKGZpbHRlcikudG9BcnJheSgpO1xuICAgICAgICBmb3IodmFyIGRhdGEgb2YgZmluZFJlc3VsdCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2godGhpcy5jb252ZXJ0RGF0YShkYXRhKSlcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IG1vbmdvQ2xpZW50LmNsb3NlKCk7XG5cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRDb25maWd1cmF0aW9uQnlLcGFUb2tlbihrcGFUb2tlbjogU3RyaW5nKSA6IFByb21pc2U8VCB8IG51bGw+IHtcbiAgICAgICAgbGV0IHJlc3VsdDogVFtdID0gW11cbiAgICAgICAgY29uc3QgbW9uZ29DbGllbnQgPSBhd2FpdCBNb25nb0NsaWVudC5jb25uZWN0KHRoaXMubW9uZ29EYlVybCk7XG4gICAgICAgIGNvbnN0IG1vbmdvRGIgPSBtb25nb0NsaWVudC5kYihgJHtwcm9jZXNzLmVudi5NT05HT0RCX0RCTkFNRX1gKTtcblxuICAgICAgICBsZXQgbW9uZ29EYkNvbGxlY3Rpb24gPSBtb25nb0RiLmNvbGxlY3Rpb24odGhpcy5jb2xsZWN0aW9uTmFtZSk7XG4gICAgICAgIGNvbnN0IGZpbmRSZXN1bHQgPSBhd2FpdCBtb25nb0RiQ29sbGVjdGlvbi5maW5kKHtrcGFfdG9rZW46IGtwYVRva2VufSkudG9BcnJheSgpO1xuICAgICAgICBmb3IodmFyIGRhdGEgb2YgZmluZFJlc3VsdCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2godGhpcy5jb252ZXJ0RGF0YShkYXRhKSlcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IG1vbmdvQ2xpZW50LmNsb3NlKCk7XG5cbiAgICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG51bGxcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHRbMF1cbiAgICB9XG5cbiAgICBhc3luYyBzYXZlKG1vZGVsOiBLUEFCYXNlQ29uZmlndXJhdGlvbk1vZGVsKSA6IFByb21pc2U8S1BBQmFzZUNvbmZpZ3VyYXRpb25Nb2RlbD4ge1xuICAgICAgICBjb25zdCBtb25nb0NsaWVudCA9IGF3YWl0IE1vbmdvQ2xpZW50LmNvbm5lY3QodGhpcy5tb25nb0RiVXJsKTtcbiAgICAgICAgY29uc3QgbW9uZ29EYiA9IG1vbmdvQ2xpZW50LmRiKGAke3Byb2Nlc3MuZW52Lk1PTkdPREJfREJOQU1FfWApXG4gICAgICAgIGxldCBtb25nb0RiQ29sbGVjdGlvbiA9IG1vbmdvRGIuY29sbGVjdGlvbih0aGlzLmNvbGxlY3Rpb25OYW1lKTtcblxuICAgICAgICBjb25zdCBkb2MgPSBtb2RlbD8uc3luY0NoYW5nZXMoKTtcbiAgICAgICAgaWYgKCFkb2MpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignbm8gZG9jdW1lbnQgdG8gc2F2ZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZmlsdGVyID0geyBrcGFfdG9rZW46IGRvYy5rcGFfdG9rZW4gfTtcbiAgICAgICAgY29uc3QgY291bnQgPSBhd2FpdCBtb25nb0RiQ29sbGVjdGlvbi5jb3VudChmaWx0ZXIpO1xuXG4gICAgICAgIGlmIChjb3VudCkge1xuICAgICAgICAgICAgYXdhaXQgbW9uZ29EYkNvbGxlY3Rpb24udXBkYXRlT25lKGZpbHRlciwge1xuICAgICAgICAgICAgICAgICRzZXQ6IGRvY1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhd2FpdCBtb25nb0RiQ29sbGVjdGlvbi5pbnNlcnRPbmUoZG9jKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IG1vbmdvQ2xpZW50LmNsb3NlKCk7XG4gICAgICAgIHJldHVybiBtb2RlbDtcbiAgICB9XG5cbiAgICBhYnN0cmFjdCBjb252ZXJ0RGF0YShkYXRhOiBEb2N1bWVudCkgOiBUO1xufVxuIl19
