"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.rivetWorkerLambdaHandler = void 0;
const mongodb_1 = require("./mongodb");
const aws_sdk_1 = require("aws-sdk");
// Handler
const rivetWorkerLambdaHandler = async (event, context) => {
    var _a, _b;
    console.log('## ENVIRONMENT VARIABLES: ' + serialize(process.env));
    console.log('## EVENT: ' + serialize(event));
    //Fetch Configuration
    const configDB = new mongodb_1.KPARivetConfigurationDB();
    let configs = await configDB.getConfiguration();
    const sqsInstance = new aws_sdk_1.SQS({
        accessKeyId: process.env.AWS_ACCESS_KEY,
        secretAccessKey: process.env.AWS_SECRET_KEY,
        region: process.env.AWS_REGION
    });
    for (var config of configs) {
        if (!config.active) {
            continue;
        }
        console.log(`Execute Rivet Customer: ${config.kpaSite} Start`);
        if (config.isSyncUser) {
            const sqsUserPayload = {
                DelaySeconds: 0,
                MessageBody: `User Integration - ${config.kpaSite}`,
                QueueUrl: (_a = process.env.AWS_SQS_RIVET_USER_URL) !== null && _a !== void 0 ? _a : '',
                MessageAttributes: {
                    'clientId': {
                        StringValue: config.clientId,
                        DataType: 'String'
                    },
                    'token': {
                        StringValue: config.token,
                        DataType: 'String'
                    },
                    'isEditUser': {
                        StringValue: config.isEditUser ? '1' : '0',
                        DataType: 'String'
                    },
                    'kpaSite': {
                        StringValue: config.kpaSite,
                        DataType: 'String'
                    },
                    'kpaToken': {
                        StringValue: config.kpaToken,
                        DataType: 'String'
                    },
                    'defaultRole': {
                        StringValue: config.defaultRole,
                        DataType: 'String'
                    },
                    'welcomeEmail': {
                        StringValue: config.isWelcomeEmail ? '1' : '0',
                        DataType: 'String'
                    },
                    'resetPassword': {
                        StringValue: config.isForceResetPassword ? '1' : '0',
                        DataType: 'String'
                    }
                },
            };
            const userPromise = await new Promise((resolve, reject) => {
                sqsInstance.sendMessage(sqsUserPayload, (err, data) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
            console.log(userPromise);
        }
        if (config.isSyncProject) {
            const sqsProjectPayload = {
                DelaySeconds: 0,
                MessageBody: `Project Integration - ${config.kpaSite}`,
                QueueUrl: (_b = process.env.AWS_SQS_RIVET_PROJECT_URL) !== null && _b !== void 0 ? _b : '',
                MessageAttributes: {
                    'clientId': {
                        StringValue: config.clientId,
                        DataType: 'String'
                    },
                    'token': {
                        StringValue: config.token,
                        DataType: 'String'
                    },
                    'isEditProject': {
                        StringValue: config.isEditProject ? '1' : '0',
                        DataType: 'String'
                    },
                    'kpaSite': {
                        StringValue: config.kpaSite,
                        DataType: 'String'
                    },
                    'kpaToken': {
                        StringValue: config.kpaToken,
                        DataType: 'String'
                    }
                },
            };
            const projectPromise = await new Promise((resolve, reject) => {
                sqsInstance.sendMessage(sqsProjectPayload, (err, data) => {
                    if (err) {
                        reject(err);
                    }
                    else {
                        resolve(data);
                    }
                });
            });
            console.log(projectPromise);
        }
        console.log(`Execute Rivet Customer Done`);
    }
    const response = {
        "statusCode": 200,
        "source": "Rivet Worker Integration",
        "body": {},
    };
    console.log(`Execute Rivet Done`);
    return response;
};
exports.rivetWorkerLambdaHandler = rivetWorkerLambdaHandler;
var serialize = function (object) {
    return JSON.stringify(object, null, 2);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicml2ZXQtd29ya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vcml2ZXQtaW50ZWdyYXRpb24vZnVuY3Rpb24vcml2ZXQtd29ya2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLHVDQUFvRDtBQUNwRCxxQ0FBd0M7QUFFeEMsVUFBVTtBQUNILE1BQU0sd0JBQXdCLEdBQWEsS0FBSyxFQUFFLEtBQVUsRUFBRSxPQUFnQixFQUFFLEVBQUU7O0lBQ3JGLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLEdBQUcsU0FBUyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFBO0lBQ2xFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO0lBRTVDLHFCQUFxQjtJQUNyQixNQUFNLFFBQVEsR0FBRyxJQUFJLGlDQUF1QixFQUFFLENBQUM7SUFDL0MsSUFBSSxPQUFPLEdBQUcsTUFBTSxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUVoRCxNQUFNLFdBQVcsR0FBRyxJQUFJLGFBQUcsQ0FBQztRQUN4QixXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFjO1FBQ3ZDLGVBQWUsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWM7UUFDM0MsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVTtLQUNqQyxDQUFDLENBQUM7SUFFSCxLQUFJLElBQUksTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDakIsU0FBUztRQUNiLENBQUM7UUFDRCxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixNQUFNLENBQUMsT0FBTyxRQUFRLENBQUMsQ0FBQztRQUUvRCxJQUFJLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUNwQixNQUFNLGNBQWMsR0FBMkI7Z0JBQzNDLFlB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Q1IsV0FBVyxFQUFFLE1BQU0sQ0FBQyxRQUFRO3dCQUM1QixRQUFRLEVBQUUsUUFBUTtxQkFDckI7aUJBQ0o7YUFDSixDQUFBO1lBRUQsTUFBTSxjQUFjLEdBQUcsTUFBTSxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtnQkFDekQsV0FBVyxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLEdBQWEsRUFBRSxJQUEyQixFQUFFLEVBQUU7b0JBQ3RGLElBQUksR0FBRyxFQUFFLENBQUM7d0JBQ04sTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO29CQUNmLENBQUM7eUJBQU0sQ0FBQzt3QkFDSixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7b0JBQ2pCLENBQUM7Z0JBQ0wsQ0FBQyxDQUFDLENBQUE7WUFDTixDQUFDLENBQUMsQ0FBQTtZQUVGLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUE7UUFDL0IsQ0FBQztRQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQsTUFBTSxRQUFRLEdBQUc7UUFDYixZQUFZLEVBQUUsR0FBRztRQUNqQixRQUFRLEVBQUUsMEJBQTBCO1FBQ3BDLE1BQU0sRUFBRSxFQUFFO0tBQ2IsQ0FBQTtJQUVELE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUNsQyxPQUFPLFFBQVEsQ0FBQTtBQUNuQixDQUFDLENBQUE7QUE5SFksUUFBQSx3QkFBd0IsNEJBOEhwQztBQUVELElBQUksU0FBUyxHQUFHLFVBQVMsTUFBVztJQUNsQyxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtBQUN4QyxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb250ZXh0LCBIYW5kbGVyIH0gZnJvbSBcImF3cy1sYW1iZGFcIjtcbmltcG9ydCB7IEtQQVJpdmV0Q29uZmlndXJhdGlvbkRCIH0gZnJvbSBcIi4vbW9uZ29kYlwiO1xuaW1wb3J0IHsgQVdTRXJyb3IsIFNRUyB9IGZyb20gXCJhd3Mtc2RrXCI7XG5cbi8vIEhhbmRsZXJcbmV4cG9ydCBjb25zdCByaXZldFdvcmtlckxhbWJkYUhhbmRsZXIgOiBIYW5kbGVyID0gYXN5bmMgKGV2ZW50OiBhbnksIGNvbnRleHQ6IENvbnRleHQpID0+IHtcbiAgICBjb25zb2xlLmxvZygnIyMgRU5WSVJPTk1FTlQgVkFSSUFCTEVTOiAnICsgc2VyaWFsaXplKHByb2Nlc3MuZW52KSlcbiAgICBjb25zb2xlLmxvZygnIyMgRVZFTlQ6ICcgKyBzZXJpYWxpemUoZXZlbnQpKVxuXG4gICAgLy9GZXRjaCBDb25maWd1cmF0aW9uXG4gICAgY29uc3QgY29uZmlnREIgPSBuZXcgS1BBUml2ZXRDb25maWd1cmF0aW9uREIoKTtcbiAgICBsZXQgY29uZmlncyA9IGF3YWl0IGNvbmZpZ0RCLmdldENvbmZpZ3VyYXRpb24oKTtcblxuICAgIGNvbnN0IHNxc0luc3RhbmNlID0gbmV3IFNRUyh7XG4gICAgICAgIGFjY2Vzc0tleUlkOiBwcm9jZXNzLmVudi5BV1NfQUNDRVNTX0tFWSxcbiAgICAgICAgc2VjcmV0QWNjZXNzS2V5OiBwcm9jZXNzLmVudi5BV1NfU0VDUkVUX0tFWSxcbiAgICAgICAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OXG4gICAgfSk7XG5cbiAgICBmb3IodmFyIGNvbmZpZyBvZiBjb25maWdzKSB7XG4gICAgICAgIGlmICghY29uZmlnLmFjdGl2ZSkge1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc29sZS5sb2coYEV4ZWN1dGUgUml2ZXQgQ3VzdG9tZXI6ICR7Y29uZmlnLmtwYVNpdGV9IFN0YXJ0YCk7XG5cbiAgICAgICAgaWYgKGNvbmZpZy5pc1N5bmNVc2VyKSB7XG4gICAgICAgICAgICBjb25zdCBzcXNVc2VyUGF5bG9hZCA6IFNRUy5TZW5kTWVzc2FnZVJlcXVlc3Q9IHtcbiAgICAgICAgICAgICAgICBEZWxheVNlY29uZHM6IDAsXG4gICAgICAgICAgICAgICAgTWVzc2FnZUJvZHk6IGBVc2VyIEludGVncmF0aW9uIC0gJHtjb25maWcua3BhU2l0ZX1gLFxuICAgICAgICAgICAgICAgIFF1ZXVlVXJsOiBwcm9jZXNzLmVudi5BV1NfU1FTX1JJVkVUX1VTRVJfVVJMID8/ICcnLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VBdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgICAgICAgICAgICdjbGllbnRJZCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuY2xpZW50SWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ3Rva2VuJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy50b2tlbixcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAnaXNFZGl0VXNlcic6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuaXNFZGl0VXNlciA/ICcxJyA6ICcwJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAna3BhU2l0ZSc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcua3BhU2l0ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAna3BhVG9rZW4nOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmtwYVRva2VuLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICdkZWZhdWx0Um9sZSc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuZGVmYXVsdFJvbGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ3dlbGNvbWVFbWFpbCc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcuaXNXZWxjb21lRW1haWwgPyAnMScgOiAnMCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ3Jlc2V0UGFzc3dvcmQnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmlzRm9yY2VSZXNldFBhc3N3b3JkID8gJzEnIDogJzAnLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCB1c2VyUHJvbWlzZSA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBzcXNJbnN0YW5jZS5zZW5kTWVzc2FnZShzcXNVc2VyUGF5bG9hZCwgKGVycjogQVdTRXJyb3IsIGRhdGE6IFNRUy5TZW5kTWVzc2FnZVJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShkYXRhKVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICBjb25zb2xlLmxvZyh1c2VyUHJvbWlzZSlcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25maWcuaXNTeW5jUHJvamVjdCkge1xuICAgICAgICAgICAgY29uc3Qgc3FzUHJvamVjdFBheWxvYWQgOiBTUVMuU2VuZE1lc3NhZ2VSZXF1ZXN0PSB7XG4gICAgICAgICAgICAgICAgRGVsYXlTZWNvbmRzOiAwLFxuICAgICAgICAgICAgICAgIE1lc3NhZ2VCb2R5OiBgUHJvamVjdCBJbnRlZ3JhdGlvbiAtICR7Y29uZmlnLmtwYVNpdGV9YCxcbiAgICAgICAgICAgICAgICBRdWV1ZVVybDogcHJvY2Vzcy5lbnYuQVdTX1NRU19SSVZFVF9QUk9KRUNUX1VSTCA/PyAnJyxcbiAgICAgICAgICAgICAgICBNZXNzYWdlQXR0cmlidXRlczoge1xuICAgICAgICAgICAgICAgICAgICAnY2xpZW50SWQnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmNsaWVudElkLFxuICAgICAgICAgICAgICAgICAgICAgICAgRGF0YVR5cGU6ICdTdHJpbmcnXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICd0b2tlbic6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIFN0cmluZ1ZhbHVlOiBjb25maWcudG9rZW4sXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2lzRWRpdFByb2plY3QnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmlzRWRpdFByb2plY3QgPyAnMScgOiAnMCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2twYVNpdGUnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBTdHJpbmdWYWx1ZTogY29uZmlnLmtwYVNpdGUsXG4gICAgICAgICAgICAgICAgICAgICAgICBEYXRhVHlwZTogJ1N0cmluZydcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgJ2twYVRva2VuJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgU3RyaW5nVmFsdWU6IGNvbmZpZy5rcGFUb2tlbixcbiAgICAgICAgICAgICAgICAgICAgICAgIERhdGFUeXBlOiAnU3RyaW5nJ1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcHJvamVjdFByb21pc2UgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgc3FzSW5zdGFuY2Uuc2VuZE1lc3NhZ2Uoc3FzUHJvamVjdFBheWxvYWQsIChlcnI6IEFXU0Vycm9yLCBkYXRhOiBTUVMuU2VuZE1lc3NhZ2VSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycilcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhwcm9qZWN0UHJvbWlzZSlcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnNvbGUubG9nKGBFeGVjdXRlIFJpdmV0IEN1c3RvbWVyIERvbmVgKTtcbiAgICB9XG4gIFxuICAgIGNvbnN0IHJlc3BvbnNlID0ge1xuICAgICAgICBcInN0YXR1c0NvZGVcIjogMjAwLFxuICAgICAgICBcInNvdXJjZVwiOiBcIlJpdmV0IFdvcmtlciBJbnRlZ3JhdGlvblwiLFxuICAgICAgICBcImJvZHlcIjoge30sXG4gICAgfVxuICBcbiAgICBjb25zb2xlLmxvZyhgRXhlY3V0ZSBSaXZldCBEb25lYCk7XG4gICAgcmV0dXJuIHJlc3BvbnNlXG59XG5cbnZhciBzZXJpYWxpemUgPSBmdW5jdGlvbihvYmplY3Q6IGFueSkge1xuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkob2JqZWN0LCBudWxsLCAyKVxufVxuIl19