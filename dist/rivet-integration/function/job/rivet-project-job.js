"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RivetProjectJob = void 0;
const api_1 = require("../../../base-integration/src/api");
const api_2 = require("../api");
const model_1 = require("../../../base-integration/src/model");
const util_1 = require("util");
class RivetProjectJob {
    constructor(config) {
        this.config = config;
        this.kpaSite = config["kpaSite"]["stringValue"];
        this.name = 'Rivet Project Job - ' + this.kpaSite;
        this.kpaToken = config["kpaToken"]["stringValue"];
        this.clientId = config["clientId"]["stringValue"];
        this.token = config["token"]["stringValue"];
        this.isEditProject = config["isEditProject"]["stringValue"] == '1';
    }
    async execute(status) {
        (0, util_1.debuglog)('log:rivet:project')("Execute RivetProjectJob Start");
        let kpaProjectAPI = new api_1.KPAProjectAPI(this.kpaToken);
        // let kpaExistProjects = await kpaProjectAPI.getAllProject();
        let kpaExistProjects = [];
        status.totalExistingRecord = kpaExistProjects.length;
        (0, util_1.debuglog)('log:rivet:project')(JSON.stringify(kpaExistProjects, null, 2));
        let rivetAPI = new api_2.RivetAPI(this.clientId, this.token);
        let projects = await rivetAPI.getProjects();
        status.totalSourceRecord = projects.length;
        let kpaProjects = [];
        for (let project of projects) {
            if (project.jobName.startsWith('*') === true) {
                status.skippedRecord++;
                continue;
            }
            var kpaProject = null;
            for (let i = 0; i < kpaExistProjects.length; i++) {
                const kpaExistProject = kpaExistProjects[i];
                if (kpaExistProject.name === project.jobName && kpaExistProject.code === project.jobNumber) {
                    kpaProject = kpaExistProject;
                    kpaExistProjects.splice(i, 1);
                    break;
                }
            }
            if (kpaProject == null) {
                kpaProject = new model_1.KPAProjectModel();
            }
            else {
                if (!this.isEditProject) {
                    status.skippedRecord++;
                    continue;
                }
            }
            if (project.jobName.includes("\"")) {
                project.jobName = project.jobName.replace("\"", "'");
            }
            //Build KPA project Data and Check existing
            kpaProject.name = project.jobName;
            kpaProject.code = project.jobNumber;
            kpaProject.isActive = project.jobStatus === 'In-Progress';
            kpaProject.address = project.address;
            kpaProject.city = project.city;
            kpaProject.state = project.state;
            kpaProject.zip = project.zip;
            kpaProjects.push(kpaProject);
            status.upsertRecord++;
        }
        //Send Data
        (0, util_1.debuglog)('log:rivet:project')(String(kpaProjects.length));
        const success = await kpaProjectAPI.saveProject(this.kpaSite, kpaProjects);
        if (!success) {
            throw new Error('Failed to save Projects:' + this.config.kpaSite);
        }
        (0, util_1.debuglog)('log:rivet:project')("Execute RivetProjectJob Done");
    }
}
exports.RivetProjectJob = RivetProjectJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicml2ZXQtcHJvamVjdC1qb2IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9yaXZldC1pbnRlZ3JhdGlvbi9mdW5jdGlvbi9qb2Ivcml2ZXQtcHJvamVjdC1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsMkRBQWtFO0FBQ2xFLGdDQUFrQztBQUNsQywrREFBc0U7QUFHdEUsK0JBQWdDO0FBQ2hDLE1BQWEsZUFBZTtJQVN4QixZQUFZLE1BQVc7UUFDbkIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFFckIsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDaEQsSUFBSSxDQUFDLElBQUksR0FBRyxzQkFBc0IsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQ2xELElBQUksQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxJQUFJLEdBQUcsQ0FBQztJQUN2RSxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFnQjtRQUMxQixJQUFBLGVBQVEsRUFBQyxtQkFBbUIsQ0FBQyxDQUFDLCtCQUErQixDQUFDLENBQUM7UUFDL0QsSUFBSSxhQUFhLEdBQUcsSUFBSSxtQkFBYSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyRCw4REFBOEQ7UUFDOUQsSUFBSSxnQkFBZ0IsR0FBdUIsRUFBRSxDQUFDO1FBQzlDLE1BQU0sQ0FB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VyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUM7UUFDM0UsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RFLENBQUM7UUFDRCxJQUFBLGVBQVEsRUFBQyxtQkFBbUIsQ0FBQyxDQUFDLDhCQUE4QixDQUFDLENBQUM7SUFDbEUsQ0FBQztDQUVKO0FBcEZELDBDQW9GQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEtQQVByb2plY3RBUEkgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvYXBpXCI7XG5pbXBvcnQgeyBSaXZldEFQSSB9IGZyb20gXCIuLi9hcGlcIjtcbmltcG9ydCB7IEtQQVByb2plY3RNb2RlbCB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9tb2RlbFwiO1xuaW1wb3J0IHsgSUpvYiB9IGZyb20gXCIuLi8uLi8uLi9iYXNlLWludGVncmF0aW9uL3NyYy9qb2Ivam9iLWludGVyZmFjZVwiO1xuaW1wb3J0IHsgSm9iU3RhdHVzIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2pvYlwiO1xuaW1wb3J0IHsgZGVidWdsb2cgfSBmcm9tICd1dGlsJztcbmV4cG9ydCBjbGFzcyBSaXZldFByb2plY3RKb2IgaW1wbGVtZW50cyBJSm9iIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAga3BhU2l0ZTogc3RyaW5nO1xuICAgIGtwYVRva2VuOiBzdHJpbmc7XG4gICAgY2xpZW50SWQ6IHN0cmluZztcbiAgICB0b2tlbjogc3RyaW5nO1xuICAgIGlzRWRpdFByb2plY3Q6IGJvb2xlYW47XG4gICAgY29uZmlnOiBhbnk7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IGFueSkge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxuICAgICAgICB0aGlzLmtwYVNpdGUgPSBjb25maWdbXCJrcGFTaXRlXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMubmFtZSA9ICdSaXZldCBQcm9qZWN0IEpvYiAtICcgKyB0aGlzLmtwYVNpdGU7XG4gICAgICAgIHRoaXMua3BhVG9rZW4gPSBjb25maWdbXCJrcGFUb2tlblwiXVtcInN0cmluZ1ZhbHVlXCJdO1xuICAgICAgICB0aGlzLmNsaWVudElkID0gY29uZmlnW1wiY2xpZW50SWRcIl1bXCJzdHJpbmdWYWx1ZVwiXTtcbiAgICAgICAgdGhpcy50b2tlbiA9IGNvbmZpZ1tcInRva2VuXCJdW1wic3RyaW5nVmFsdWVcIl07XG4gICAgICAgIHRoaXMuaXNFZGl0UHJvamVjdCA9IGNvbmZpZ1tcImlzRWRpdFByb2plY3RcIl1bXCJzdHJpbmdWYWx1ZVwiXSA9PSAnMSc7XG4gICAgfVxuXG4gICAgYXN5bmMgZXhlY3V0ZShzdGF0dXM6Sm9iU3RhdHVzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGRlYnVnbG9nKCdsb2c6cml2ZXQ6cHJvamVjdCcpKFwiRXhlY3V0ZSBSaXZldFByb2plY3RKb2IgU3RhcnRcIik7XG4gICAgICAgIGxldCBrcGFQcm9qZWN0QVBJID0gbmV3IEtQQVByb2plY3RBUEkodGhpcy5rcGFUb2tlbik7XG4gICAgICAgIC8vIGxldCBrcGFFeGlzdFByb2plY3RzID0gYXdhaXQga3BhUHJvamVjdEFQSS5nZXRBbGxQcm9qZWN0KCk7XG4gICAgICAgIGxldCBrcGFFeGlzdFByb2plY3RzIDogS1BBUHJvamVjdE1vZGVsW10gPSBbXTtcbiAgICAgICAgc3RhdHVzLnRvdGFsRXhpc3RpbmdSZWNvcmQgPSBrcGFFeGlzdFByb2plY3RzLmxlbmd0aFxuICAgICAgICBkZWJ1Z2xvZygnbG9nOnJpdmV0OnByb2plY3QnKShKU09OLnN0cmluZ2lmeShrcGFFeGlzdFByb2plY3RzLCBudWxsLCAyKSk7XG5cbiAgICAgICAgbGV0IHJpdmV0QVBJID0gbmV3IFJpdmV0QVBJKHRoaXMuY2xpZW50SWQsIHRoaXMudG9rZW4pO1xuICAgICAgICBsZXQgcHJvamVjdHMgPSBhd2FpdCByaXZldEFQSS5nZXRQcm9qZWN0cygpO1xuICAgICAgICBzdGF0dXMudG90YWxTb3VyY2VSZWNvcmQgPSBwcm9qZWN0cy5sZW5ndGhcblxuICAgICAgICBsZXQga3BhUHJvamVjdHM6IEtQQVByb2plY3RNb2RlbFtdID0gW107XG4gICAgICAgIGZvcihsZXQgcHJvamVjdCBvZiBwcm9qZWN0cykge1xuICAgICAgICAgICAgaWYgKHByb2plY3Quam9iTmFtZS5zdGFydHNXaXRoKCcqJykgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgY29udGludWVcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIGtwYVByb2plY3QgOiBLUEFQcm9qZWN0TW9kZWwgfCBudWxsID0gbnVsbDtcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwga3BhRXhpc3RQcm9qZWN0cy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGNvbnN0IGtwYUV4aXN0UHJvamVjdCA9IGtwYUV4aXN0UHJvamVjdHNbaV07XG4gICAgICAgICAgICAgICAgaWYgKGtwYUV4aXN0UHJvamVjdC5uYW1lID09PSBwcm9qZWN0LmpvYk5hbWUgJiYga3BhRXhpc3RQcm9qZWN0LmNvZGUgPT09IHByb2plY3Quam9iTnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QgPSBrcGFFeGlzdFByb2plY3Q7XG4gICAgICAgICAgICAgICAgICAgIGtwYUV4aXN0UHJvamVjdHMuc3BsaWNlKGksMSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGtwYVByb2plY3QgPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgIGtwYVByb2plY3QgPSBuZXcgS1BBUHJvamVjdE1vZGVsKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5pc0VkaXRQcm9qZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgIHN0YXR1cy5za2lwcGVkUmVjb3JkKytcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAocHJvamVjdC5qb2JOYW1lLmluY2x1ZGVzKFwiXFxcIlwiKSkge1xuICAgICAgICAgICAgICAgIHByb2plY3Quam9iTmFtZSA9IHByb2plY3Quam9iTmFtZS5yZXBsYWNlKFwiXFxcIlwiLCBcIidcIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vQnVpbGQgS1BBIHByb2plY3QgRGF0YSBhbmQgQ2hlY2sgZXhpc3RpbmdcbiAgICAgICAgICAgIGtwYVByb2plY3QubmFtZSA9IHByb2plY3Quam9iTmFtZTtcbiAgICAgICAgICAgIGtwYVByb2plY3QuY29kZSA9IHByb2plY3Quam9iTnVtYmVyO1xuICAgICAgICAgICAga3BhUHJvamVjdC5pc0FjdGl2ZSA9IHByb2plY3Quam9iU3RhdHVzID09PSAnSW4tUHJvZ3Jlc3MnXG4gICAgICAgICAgICBrcGFQcm9qZWN0LmFkZHJlc3MgPSBwcm9qZWN0LmFkZHJlc3M7XG4gICAgICAgICAgICBrcGFQcm9qZWN0LmNpdHkgPSBwcm9qZWN0LmNpdHk7XG4gICAgICAgICAgICBrcGFQcm9qZWN0LnN0YXRlID0gcHJvamVjdC5zdGF0ZTtcbiAgICAgICAgICAgIGtwYVByb2plY3QuemlwID0gcHJvamVjdC56aXA7XG5cbiAgICAgICAgICAgIGtwYVByb2plY3RzLnB1c2goa3BhUHJvamVjdCk7XG4gICAgICAgICAgICBzdGF0dXMudXBzZXJ0UmVjb3JkKytcbiAgICAgICAgfVxuXG4gICAgICAgIC8vU2VuZCBEYXRhXG4gICAgICAgIGRlYnVnbG9nKCdsb2c6cml2ZXQ6cHJvamVjdCcpKFN0cmluZyhrcGFQcm9qZWN0cy5sZW5ndGgpKVxuICAgICAgICBjb25zdCBzdWNjZXNzID0gYXdhaXQga3BhUHJvamVjdEFQSS5zYXZlUHJvamVjdCh0aGlzLmtwYVNpdGUsIGtwYVByb2plY3RzKTtcbiAgICAgICAgaWYgKCFzdWNjZXNzKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBzYXZlIFByb2plY3RzOicgKyB0aGlzLmNvbmZpZy5rcGFTaXRlKTtcbiAgICAgICAgfVxuICAgICAgICBkZWJ1Z2xvZygnbG9nOnJpdmV0OnByb2plY3QnKShcIkV4ZWN1dGUgUml2ZXRQcm9qZWN0Sm9iIERvbmVcIik7XG4gICAgfVxuXG59XG4iXX0=