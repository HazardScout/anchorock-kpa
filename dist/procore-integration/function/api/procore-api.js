"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProcoreAPI = void 0;
const axios_1 = require("axios");
const model_1 = require("../model");
class ProcoreAPI {
    constructor(auth, resaveToken) {
        this.auth = auth;
        this.resaveToken = resaveToken;
        this.authInstance = axios_1.default.create({
            baseURL: 'https://login.procore.com/oauth/token/'
        });
        this.authInstance.defaults.headers.post['Accept'] = 'application/json';
        this.authInstance.defaults.headers.post['Content-Type'] = 'application/json';
        this.apiInstance = axios_1.default.create({
            baseURL: 'https://api.procore.com/rest/v1.0/'
        });
        this.apiInstance.defaults.headers.common['Authorization'] = `Bearer ${auth.accessToken}`;
        this.apiInstance.defaults.headers.post['Accept'] = 'application/json';
        this.apiInstance.defaults.headers.post['Content-Type'] = 'application/json';
    }
    async refreshToken() {
        var _a;
        try {
            const { data } = await this.authInstance.post('', {
                grant_type: 'refresh_token',
                refresh_token: this.auth.refreshToken,
                client_id: this.auth.clientId,
                client_secret: this.auth.clientSecret
            });
            const accessToken = data['access_token'];
            const refreshToken = data['refresh_token'];
            return new model_1.procoreContext(accessToken, refreshToken);
        }
        catch (e) {
            throw new Error(JSON.stringify(((_a = e.response) === null || _a === void 0 ? void 0 : _a.data) || e));
        }
    }
    async getCompanies() {
        var _a;
        const result = [];
        try {
            const { data } = await this.apiInstance
                .get('/companies');
            for (var companyData of data) {
                let company = Object.assign(new model_1.ProcoreCompanyModel(), companyData);
                result.push(company);
            }
        }
        catch (e) {
            //For some reason, Cannot acess status on error Response
            const errorResponse = JSON.parse(JSON.stringify(e));
            if (errorResponse['status'] == 401) {
                this.auth = await this.refreshToken();
                await this.resaveToken(this.auth);
                this.apiInstance.defaults.headers.common['Authorization'] = `Bearer ${this.auth.accessToken}`;
                return await this.getCompanies();
            }
            else {
                throw new Error(JSON.stringify(((_a = e.response) === null || _a === void 0 ? void 0 : _a.data) || e));
            }
        }
        return result;
    }
    async getProjects(companyId) {
        var _a;
        const result = [];
        try {
            const { data } = await this.apiInstance
                .get('/projects', { params: { company_id: companyId, 'filters[by_status]': 'All' }, headers: { 'Procore-Company-Id': `${companyId}` } });
            for (var projectData of data) {
                let project = Object.assign(new model_1.ProcoreProjectModel(), projectData);
                result.push(project);
            }
        }
        catch (e) {
            //For some reason, Cannot acess status on error Response
            const errorResponse = JSON.parse(JSON.stringify(e));
            if (errorResponse['status'] == 401) {
                this.auth = await this.refreshToken();
                await this.resaveToken(this.auth);
                this.apiInstance.defaults.headers.common['Authorization'] = `Bearer ${this.auth.accessToken}`;
                return await this.getProjects(companyId);
            }
            else {
                throw new Error(JSON.stringify(((_a = e.response) === null || _a === void 0 ? void 0 : _a.data) || e));
            }
        }
        return result;
    }
    async getUsers(companyId) {
        var _a;
        const result = [];
        try {
            const { data } = await this.apiInstance
                .get('/users', { params: { company_id: companyId }, headers: { 'Procore-Company-Id': `${companyId}` } });
            for (var userData of data) {
                let user = Object.assign(new model_1.ProcoreUserModel(), userData);
                result.push(user);
            }
        }
        catch (e) {
            //For some reason, Cannot acess status on error Response
            const errorResponse = JSON.parse(JSON.stringify(e));
            if (errorResponse['status'] == 401) {
                this.auth = await this.refreshToken();
                ;
                await this.resaveToken(this.auth);
                this.apiInstance.defaults.headers.common['Authorization'] = `Bearer ${this.auth.accessToken}`;
                return await this.getUsers(companyId);
            }
            else {
                throw new Error(JSON.stringify(((_a = e.response) === null || _a === void 0 ? void 0 : _a.data) || e));
            }
        }
        return result;
    }
}
exports.ProcoreAPI = ProcoreAPI;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY29yZS1hcGkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9jb3JlLWludGVncmF0aW9uL2Z1bmN0aW9uL2FwaS9wcm9jb3JlLWFwaS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxpQ0FBcUM7QUFDckMsb0NBQXNHO0FBRXRHLE1BQWEsVUFBVTtJQU1uQixZQUFZLElBQW9CLEVBQUUsV0FBb0Q7UUFDbEYsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFFL0IsSUFBSSxDQUFDLFlBQVksR0FBRyxlQUFLLENBQUMsTUFBTSxDQUFDO1lBQzdCLE9BQU8sRUFBRSx3Q0FBd0M7U0FDcEQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxrQkFBa0IsQ0FBQztRQUN2RSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDO1FBRTdFLElBQUksQ0FBQyxXQUFXLEdBQUcsZUFBSyxDQUFDLE1BQU0sQ0FBQztZQUM1QixPQUFPLEVBQUUsb0NBQW9DO1NBQ2hELENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLEdBQUcsVUFBVSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDekYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxrQkFBa0IsQ0FBQztRQUN0RSxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxHQUFHLGtCQUFrQixDQUFDO0lBQ2hG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QVMsQ0FBQyxDQUFBLE1BQUEsQ0FBQyxDQUFDLFFBQVEsMENBQUUsSUFBSSxLQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0QsQ0FBQztRQUNMLENBQUM7UUFDRCxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0NBRUo7QUExSEQsZ0NBMEhDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGF4aW9zLCB7IEF4aW9zIH0gZnJvbSBcImF4aW9zXCI7XG5pbXBvcnQgeyBwcm9jb3JlQ29udGV4dCwgUHJvY29yZUNvbXBhbnlNb2RlbCwgUHJvY29yZVByb2plY3RNb2RlbCwgUHJvY29yZVVzZXJNb2RlbCB9IGZyb20gXCIuLi9tb2RlbFwiO1xuXG5leHBvcnQgY2xhc3MgUHJvY29yZUFQSSB7XG4gICAgYXV0aDogcHJvY29yZUNvbnRleHQ7XG4gICAgYXV0aEluc3RhbmNlOiBBeGlvcztcbiAgICBhcGlJbnN0YW5jZTogQXhpb3M7XG4gICAgcmVzYXZlVG9rZW46IChhdXRoOiBwcm9jb3JlQ29udGV4dCkgPT4gUHJvbWlzZTx2b2lkPjtcblxuICAgIGNvbnN0cnVjdG9yKGF1dGg6IHByb2NvcmVDb250ZXh0LCByZXNhdmVUb2tlbjogKGF1dGg6IHByb2NvcmVDb250ZXh0KSA9PiBQcm9taXNlPHZvaWQ+KSB7XG4gICAgICAgIHRoaXMuYXV0aCA9IGF1dGg7XG4gICAgICAgIHRoaXMucmVzYXZlVG9rZW4gPSByZXNhdmVUb2tlbjtcblxuICAgICAgICB0aGlzLmF1dGhJbnN0YW5jZSA9IGF4aW9zLmNyZWF0ZSh7XG4gICAgICAgICAgICBiYXNlVVJMOiAnaHR0cHM6Ly9sb2dpbi5wcm9jb3JlLmNvbS9vYXV0aC90b2tlbi8nXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuYXV0aEluc3RhbmNlLmRlZmF1bHRzLmhlYWRlcnMucG9zdFsnQWNjZXB0J10gPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgICAgIHRoaXMuYXV0aEluc3RhbmNlLmRlZmF1bHRzLmhlYWRlcnMucG9zdFsnQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24vanNvbic7XG5cbiAgICAgICAgdGhpcy5hcGlJbnN0YW5jZSA9IGF4aW9zLmNyZWF0ZSh7XG4gICAgICAgICAgICBiYXNlVVJMOiAnaHR0cHM6Ly9hcGkucHJvY29yZS5jb20vcmVzdC92MS4wLydcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5hcGlJbnN0YW5jZS5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vblsnQXV0aG9yaXphdGlvbiddID0gYEJlYXJlciAke2F1dGguYWNjZXNzVG9rZW59YDtcbiAgICAgICAgdGhpcy5hcGlJbnN0YW5jZS5kZWZhdWx0cy5oZWFkZXJzLnBvc3RbJ0FjY2VwdCddID0gJ2FwcGxpY2F0aW9uL2pzb24nO1xuICAgICAgICB0aGlzLmFwaUluc3RhbmNlLmRlZmF1bHRzLmhlYWRlcnMucG9zdFsnQ29udGVudC1UeXBlJ10gPSAnYXBwbGljYXRpb24vanNvbic7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVmcmVzaFRva2VuKCk6IFByb21pc2U8cHJvY29yZUNvbnRleHQ+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hdXRoSW5zdGFuY2UucG9zdCgnJywge1xuICAgICAgICAgICAgICAgIGdyYW50X3R5cGU6ICdyZWZyZXNoX3Rva2VuJywgXG4gICAgICAgICAgICAgICAgcmVmcmVzaF90b2tlbjogdGhpcy5hdXRoLnJlZnJlc2hUb2tlbiwgXG4gICAgICAgICAgICAgICAgY2xpZW50X2lkOiB0aGlzLmF1dGguY2xpZW50SWQsIFxuICAgICAgICAgICAgICAgIGNsaWVudF9zZWNyZXQ6IHRoaXMuYXV0aC5jbGllbnRTZWNyZXRcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb25zdCBhY2Nlc3NUb2tlbiA9IGRhdGFbJ2FjY2Vzc190b2tlbiddO1xuICAgICAgICAgICAgY29uc3QgcmVmcmVzaFRva2VuID0gZGF0YVsncmVmcmVzaF90b2tlbiddO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBwcm9jb3JlQ29udGV4dChhY2Nlc3NUb2tlbiwgcmVmcmVzaFRva2VuKTtcbiAgICAgICAgfSBjYXRjaChlOmFueSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGUucmVzcG9uc2U/LmRhdGEgfHwgZSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0Q29tcGFuaWVzKCkgIDogUHJvbWlzZTxQcm9jb3JlQ29tcGFueU1vZGVsW10+e1xuICAgICAgICBjb25zdCByZXN1bHQ6IFByb2NvcmVDb21wYW55TW9kZWxbXSA9IFtdO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgeyBkYXRhIH0gPSBhd2FpdCB0aGlzLmFwaUluc3RhbmNlXG4gICAgICAgICAgICAuZ2V0KCcvY29tcGFuaWVzJylcbiAgICAgICAgICAgIGZvciAodmFyIGNvbXBhbnlEYXRhIG9mIGRhdGEpIHtcbiAgICAgICAgICAgICAgICBsZXQgY29tcGFueSA9IE9iamVjdC5hc3NpZ24obmV3IFByb2NvcmVDb21wYW55TW9kZWwoKSwgY29tcGFueURhdGEpO1xuICAgICAgICAgICAgICAgIHJlc3VsdC5wdXNoKGNvbXBhbnkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoKGU6YW55KSB7XG4gICAgICAgICAgICAvL0ZvciBzb21lIHJlYXNvbiwgQ2Fubm90IGFjZXNzIHN0YXR1cyBvbiBlcnJvciBSZXNwb25zZVxuICAgICAgICAgICAgY29uc3QgZXJyb3JSZXNwb25zZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZSkpO1xuICAgICAgICAgICAgaWYgKGVycm9yUmVzcG9uc2VbJ3N0YXR1cyddID09IDQwMSkge1xuXG4gICAgICAgICAgICAgICAgdGhpcy5hdXRoID0gYXdhaXQgdGhpcy5yZWZyZXNoVG9rZW4oKTtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnJlc2F2ZVRva2VuKHRoaXMuYXV0aClcblxuICAgICAgICAgICAgICAgIHRoaXMuYXBpSW5zdGFuY2UuZGVmYXVsdHMuaGVhZGVycy5jb21tb25bJ0F1dGhvcml6YXRpb24nXSA9IGBCZWFyZXIgJHt0aGlzLmF1dGguYWNjZXNzVG9rZW59YDtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRDb21wYW5pZXMoKVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoSlNPTi5zdHJpbmdpZnkoZS5yZXNwb25zZT8uZGF0YSB8fCBlKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRQcm9qZWN0cyhjb21wYW55SWQ6IG51bWJlcikgOiBQcm9taXNlPFByb2NvcmVQcm9qZWN0TW9kZWxbXT4ge1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdDogUHJvY29yZVByb2plY3RNb2RlbFtdID0gW107XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB7IGRhdGEgfSA9IGF3YWl0IHRoaXMuYXBpSW5zdGFuY2VcbiAgICAgICAgICAgIC5nZXQoJy9wcm9qZWN0cycsIHsgcGFyYW1zOiB7IGNvbXBhbnlfaWQ6IGNvbXBhbnlJZCwgJ2ZpbHRlcnNbYnlfc3RhdHVzXSc6ICdBbGwnIH0gLCBoZWFkZXJzOiB7ICdQcm9jb3JlLUNvbXBhbnktSWQnOiBgJHtjb21wYW55SWR9YH19KVxuICAgICAgICAgICAgZm9yICh2YXIgcHJvamVjdERhdGEgb2YgZGF0YSkge1xuICAgICAgICAgICAgICAgIGxldCBwcm9qZWN0ID0gT2JqZWN0LmFzc2lnbihuZXcgUHJvY29yZVByb2plY3RNb2RlbCgpLCBwcm9qZWN0RGF0YSk7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2gocHJvamVjdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2goZTphbnkpIHtcbiAgICAgICAgICAgIC8vRm9yIHNvbWUgcmVhc29uLCBDYW5ub3QgYWNlc3Mgc3RhdHVzIG9uIGVycm9yIFJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlKSk7XG4gICAgICAgICAgICBpZiAoZXJyb3JSZXNwb25zZVsnc3RhdHVzJ10gPT0gNDAxKSB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmF1dGggPSBhd2FpdCB0aGlzLnJlZnJlc2hUb2tlbigpO1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMucmVzYXZlVG9rZW4odGhpcy5hdXRoKVxuXG4gICAgICAgICAgICAgICAgdGhpcy5hcGlJbnN0YW5jZS5kZWZhdWx0cy5oZWFkZXJzLmNvbW1vblsnQXV0aG9yaXphdGlvbiddID0gYEJlYXJlciAke3RoaXMuYXV0aC5hY2Nlc3NUb2tlbn1gO1xuICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmdldFByb2plY3RzKGNvbXBhbnlJZClcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKEpTT04uc3RyaW5naWZ5KGUucmVzcG9uc2U/LmRhdGEgfHwgZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0VXNlcnMoY29tcGFueUlkOiBudW1iZXIpIDogUHJvbWlzZTxQcm9jb3JlVXNlck1vZGVsW10+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBQcm9jb3JlVXNlck1vZGVsW10gPSBbXTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gYXdhaXQgdGhpcy5hcGlJbnN0YW5jZVxuICAgICAgICAgICAgLmdldCgnL3VzZXJzJywgeyBwYXJhbXM6IHsgY29tcGFueV9pZDogY29tcGFueUlkIH0gLCBoZWFkZXJzOiB7ICdQcm9jb3JlLUNvbXBhbnktSWQnOiBgJHtjb21wYW55SWR9YH19KVxuICAgICAgICAgICAgZm9yICh2YXIgdXNlckRhdGEgb2YgZGF0YSkge1xuICAgICAgICAgICAgICAgIGxldCB1c2VyID0gT2JqZWN0LmFzc2lnbihuZXcgUHJvY29yZVVzZXJNb2RlbCgpLCB1c2VyRGF0YSk7XG4gICAgICAgICAgICAgICAgcmVzdWx0LnB1c2godXNlcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2goZTphbnkpIHtcbiAgICAgICAgICAgIC8vRm9yIHNvbWUgcmVhc29uLCBDYW5ub3QgYWNlc3Mgc3RhdHVzIG9uIGVycm9yIFJlc3BvbnNlXG4gICAgICAgICAgICBjb25zdCBlcnJvclJlc3BvbnNlID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShlKSk7XG4gICAgICAgICAgICBpZiAoZXJyb3JSZXNwb25zZVsnc3RhdHVzJ10gPT0gNDAxKSB7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmF1dGggPSBhd2FpdCB0aGlzLnJlZnJlc2hUb2tlbigpOztcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLnJlc2F2ZVRva2VuKHRoaXMuYXV0aClcblxuICAgICAgICAgICAgICAgIHRoaXMuYXBpSW5zdGFuY2UuZGVmYXVsdHMuaGVhZGVycy5jb21tb25bJ0F1dGhvcml6YXRpb24nXSA9IGBCZWFyZXIgJHt0aGlzLmF1dGguYWNjZXNzVG9rZW59YDtcbiAgICAgICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRVc2Vycyhjb21wYW55SWQpXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihKU09OLnN0cmluZ2lmeShlLnJlc3BvbnNlPy5kYXRhIHx8IGUpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxufVxuIl19