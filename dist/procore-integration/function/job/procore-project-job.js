"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProcoreProjectJob = void 0;
const model_1 = require("../../../base-integration/src/model");
const api_1 = require("../api");
const model_2 = require("../model");
const mongodb_1 = require("../mongodb");
const api_2 = require("../../../base-integration/src/api");
class ProcoreProjectJob {
    constructor(config) {
        this.name = "Procore Project Job - " + config.kpaSite;
        this.config = config;
    }
    async execute(status) {
        //Fetch KPA Projects
        let kpaProjectAPI = new api_2.KPAProjectAPI(this.config.kpaToken);
        // let kpaExistProjects = await kpaProjectAPI.getAllProject();
        let kpaExistProjects = [];
        status.totalExistingRecord = kpaExistProjects.length;
        let auth = new model_2.procoreContext(this.config.procoreToken, this.config.procoreRefreshToken);
        let procoreAPI = new api_1.ProcoreAPI(auth, async (newAuth) => {
            this.config.procoreToken = newAuth.accessToken;
            this.config.procoreRefreshToken = newAuth.refreshToken;
            let db = new mongodb_1.KPAProcoreConfigurationDB();
            await db.updateProcoreToken(this.config);
        });
        let companies = await procoreAPI.getCompanies();
        status.totalSourceRecord = 0;
        for (let company of companies) {
            for (let procoreCompanyId of this.config.procoreCompanyIds) {
                if (procoreCompanyId === company.id) {
                    let projects = await procoreAPI.getProjects(company.id);
                    status.totalSourceRecord += projects.length;
                    let kpaProjects = [];
                    for (let project of projects) {
                        //Build KPA project Data and Check existing
                        var kpaProject = null;
                        for (let i = 0; i < kpaExistProjects.length; i++) {
                            const kpaExistProject = kpaExistProjects[i];
                            if (kpaExistProject.code === project.project_number) {
                                kpaProject = kpaExistProject;
                                kpaExistProjects.splice(i, 1);
                                break;
                            }
                        }
                        if (kpaProject == null) {
                            kpaProject = new model_1.KPAProjectModel();
                        }
                        else {
                            if (!this.config.isEditProject) {
                                // console.log(`Skip Project because of Cannot Allow to edit ${project.jobName}`)
                                status.skippedRecord++;
                                continue;
                            }
                        }
                        kpaProject.name = project.name;
                        kpaProject.code = project.project_number;
                        kpaProject.isActive = project.active;
                        kpaProject.address = project.address;
                        kpaProject.city = project.city;
                        kpaProject.state = project.state_code;
                        kpaProject.zip = project.zip;
                        kpaProjects.push(kpaProject);
                        status.upsertRecord++;
                    }
                    //Send Data
                    const success = await kpaProjectAPI.saveProject(this.config.kpaSite, kpaProjects);
                    if (!success) {
                        throw new Error('Failed to save Projects:' + this.config.kpaSite);
                    }
                }
            }
        }
    }
}
exports.ProcoreProjectJob = ProcoreProjectJob;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY29yZS1wcm9qZWN0LWpvYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2NvcmUtaW50ZWdyYXRpb24vZnVuY3Rpb24vam9iL3Byb2NvcmUtcHJvamVjdC1qb2IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsK0RBQXNFO0FBQ3RFLGdDQUFvQztBQUNwQyxvQ0FBd0U7QUFDeEUsd0NBQXVEO0FBQ3ZELDJEQUFrRTtBQUdsRSxNQUFhLGlCQUFpQjtJQUkxQixZQUFZLE1BQW9DO1FBQzVDLElBQUksQ0FBQyxJQUFJLEdBQUcsd0JBQXdCLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQztRQUN0RCxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUN6QixDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFpQjtRQUMzQixvQkFBb0I7UUFDcEIsSUFBSSxhQUFhLEdBQUcsSUFBSSxtQkFBYSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUQsOERBQThEO1FBQzlELElBQUksZ0JBQWdCLEdBQXVCLEVBQUUsQ0FBQztRQUM5QyxNQUFNLENBQUMsbUJBQW1CLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFBO1FBRXBELElBQUksSUFBSSxHQUFHLElBQUksc0JBQWMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDekYsSUFBSSxVQUFVLEdBQUcsSUFBSSxnQkFBVSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLEVBQUU7WUFDcEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEdBQUcsT0FBTyxDQUFDLFdBQVcsQ0FBQztZQUMvQyxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7WUFFdkQsSUFBSSxFQUFFLEdBQUcsSUFBSSxtQ0FBeUIsRUFBRSxDQUFDO1lBQ3pDLE1BQU0sRUFBRSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3QyxDQUFDLENBQUMsQ0FBQTtRQUNGLElBQUksU0FBUyxHQUFHLE1BQU0sVUFBVSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxpQkFBaUIsR0FBRyxDQUFDLENBQUE7UUFDNUIsS0FBSSxJQUFJLE9BQU8sSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUMzQixLQUFJLElBQUksZ0JBQWdCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO2dCQUN4RCxJQUFJLGdCQUFnQixLQUFLLE9BQU8sQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDbEMsSUFBSSxRQUFRLEdBQUcsTUFBTSxVQUFVLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztvQkFDeEQsTUFBTSxDQUFDLGlCQUFpQixJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUE7b0JBRTNDLElBQUksV0FBVyxHQUFzQixFQUFFLENBQUM7b0JBQ3hDLEtBQUksSUFBSSxPQUFPLElBQUksUUFBUSxFQUFFLENBQUM7d0JBQzFCLDJDQUEyQzt3QkFDM0MsSUFBSSxVQUFVLEdBQTRCLElBQUksQ0FBQzt3QkFDL0MsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDOzRCQUMvQyxNQUFNLGVBQWUsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQzs0QkFDNUMsSUFBSSxlQUFlLENBQUMsSUFBSSxLQUFLLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQ0FDbEQsVUFBVSxHQUFHLGVBQWUsQ0FBQztnQ0FDN0IsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsQ0FBQztnQ0FDN0IsTUFBTTs0QkFDVixDQUFDO3dCQUNMLENBQUM7d0JBRUQsSUFBSSxVQUFVLElBQUksSUFBSSxFQUFFLENBQUM7NEJBQ3JCLFVBQVUsR0FBRyxJQUFJLHVCQUFlLEVBQUUsQ0FBQzt3QkFDdkMsQ0FBQzs2QkFBTSxDQUFDOzRCQUNKLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDO2dDQUM3QixpRkFBaUY7Z0NBQ2pGLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQTtnQ0FDdEIsU0FBUzs0QkFDYixDQUFDO3dCQUNMLENBQUM7d0JBRUQsVUFBVSxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO3dCQUMvQixVQUFVLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUM7d0JBQ3pDLFVBQVUsQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQTt3QkFDcEMsVUFBVSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO3dCQUNyQyxVQUFVLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUM7d0JBQy9CLFVBQVUsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQzt3QkFDdEMsVUFBVSxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO3dCQUU3QixXQUFXLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO3dCQUM3QixNQUFNLENBQUMsWUFBWSxFQUFFLENBQUE7b0JBQ3pCLENBQUM7b0JBRUQsV0FBVztvQkFDWCxNQUFNLE9BQU8sR0FBRyxNQUFNLGFBQWEsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsV0FBVyxDQUFDLENBQUE7b0JBQ2pGLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQzt3QkFDWCxNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7b0JBQ3RFLENBQUM7Z0JBQ0wsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQztDQUVKO0FBN0VELDhDQTZFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IElKb2IgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvam9iXCI7XG5pbXBvcnQgeyBLUEFQcm9qZWN0TW9kZWwgfSBmcm9tIFwiLi4vLi4vLi4vYmFzZS1pbnRlZ3JhdGlvbi9zcmMvbW9kZWxcIjtcbmltcG9ydCB7IFByb2NvcmVBUEkgfSBmcm9tIFwiLi4vYXBpXCI7XG5pbXBvcnQgeyBLUEFQcm9jb3JlQ29uZmlndXJhdGlvbk1vZGVsLCBwcm9jb3JlQ29udGV4dCB9IGZyb20gXCIuLi9tb2RlbFwiO1xuaW1wb3J0IHsgS1BBUHJvY29yZUNvbmZpZ3VyYXRpb25EQiB9IGZyb20gXCIuLi9tb25nb2RiXCI7XG5pbXBvcnQgeyBLUEFQcm9qZWN0QVBJIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2FwaVwiO1xuaW1wb3J0IHsgSm9iU3RhdHVzIH0gZnJvbSBcIi4uLy4uLy4uL2Jhc2UtaW50ZWdyYXRpb24vc3JjL2pvYlwiO1xuXG5leHBvcnQgY2xhc3MgUHJvY29yZVByb2plY3RKb2IgaW1wbGVtZW50cyBJSm9iICB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGNvbmZpZzogS1BBUHJvY29yZUNvbmZpZ3VyYXRpb25Nb2RlbDtcblxuICAgIGNvbnN0cnVjdG9yKGNvbmZpZzogS1BBUHJvY29yZUNvbmZpZ3VyYXRpb25Nb2RlbCkge1xuICAgICAgICB0aGlzLm5hbWUgPSBcIlByb2NvcmUgUHJvamVjdCBKb2IgLSBcIiArIGNvbmZpZy5rcGFTaXRlO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB9XG5cbiAgICBhc3luYyBleGVjdXRlKHN0YXR1czogSm9iU3RhdHVzKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIC8vRmV0Y2ggS1BBIFByb2plY3RzXG4gICAgICAgIGxldCBrcGFQcm9qZWN0QVBJID0gbmV3IEtQQVByb2plY3RBUEkodGhpcy5jb25maWcua3BhVG9rZW4pO1xuICAgICAgICAvLyBsZXQga3BhRXhpc3RQcm9qZWN0cyA9IGF3YWl0IGtwYVByb2plY3RBUEkuZ2V0QWxsUHJvamVjdCgpO1xuICAgICAgICBsZXQga3BhRXhpc3RQcm9qZWN0cyA6IEtQQVByb2plY3RNb2RlbFtdID0gW107XG4gICAgICAgIHN0YXR1cy50b3RhbEV4aXN0aW5nUmVjb3JkID0ga3BhRXhpc3RQcm9qZWN0cy5sZW5ndGhcblxuICAgICAgICBsZXQgYXV0aCA9IG5ldyBwcm9jb3JlQ29udGV4dCh0aGlzLmNvbmZpZy5wcm9jb3JlVG9rZW4sIHRoaXMuY29uZmlnLnByb2NvcmVSZWZyZXNoVG9rZW4pO1xuICAgICAgICBsZXQgcHJvY29yZUFQSSA9IG5ldyBQcm9jb3JlQVBJKGF1dGgsIGFzeW5jIChuZXdBdXRoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5wcm9jb3JlVG9rZW4gPSBuZXdBdXRoLmFjY2Vzc1Rva2VuO1xuICAgICAgICAgICAgdGhpcy5jb25maWcucHJvY29yZVJlZnJlc2hUb2tlbiA9IG5ld0F1dGgucmVmcmVzaFRva2VuO1xuXG4gICAgICAgICAgICBsZXQgZGIgPSBuZXcgS1BBUHJvY29yZUNvbmZpZ3VyYXRpb25EQigpO1xuICAgICAgICAgICAgYXdhaXQgZGIudXBkYXRlUHJvY29yZVRva2VuKHRoaXMuY29uZmlnKTtcbiAgICAgICAgfSlcbiAgICAgICAgbGV0IGNvbXBhbmllcyA9IGF3YWl0IHByb2NvcmVBUEkuZ2V0Q29tcGFuaWVzKCk7XG4gICAgICAgIHN0YXR1cy50b3RhbFNvdXJjZVJlY29yZCA9IDBcbiAgICAgICAgZm9yKGxldCBjb21wYW55IG9mIGNvbXBhbmllcykge1xuICAgICAgICAgICAgZm9yKGxldCBwcm9jb3JlQ29tcGFueUlkIG9mIHRoaXMuY29uZmlnLnByb2NvcmVDb21wYW55SWRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKHByb2NvcmVDb21wYW55SWQgPT09IGNvbXBhbnkuaWQpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IHByb2plY3RzID0gYXdhaXQgcHJvY29yZUFQSS5nZXRQcm9qZWN0cyhjb21wYW55LmlkKTtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzLnRvdGFsU291cmNlUmVjb3JkICs9IHByb2plY3RzLmxlbmd0aFxuXG4gICAgICAgICAgICAgICAgICAgIGxldCBrcGFQcm9qZWN0czogS1BBUHJvamVjdE1vZGVsW10gPSBbXTtcbiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBwcm9qZWN0IG9mIHByb2plY3RzKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL0J1aWxkIEtQQSBwcm9qZWN0IERhdGEgYW5kIENoZWNrIGV4aXN0aW5nXG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIga3BhUHJvamVjdCA6IEtQQVByb2plY3RNb2RlbCB8IG51bGwgPSBudWxsO1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBrcGFFeGlzdFByb2plY3RzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qga3BhRXhpc3RQcm9qZWN0ID0ga3BhRXhpc3RQcm9qZWN0c1tpXTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoa3BhRXhpc3RQcm9qZWN0LmNvZGUgPT09IHByb2plY3QucHJvamVjdF9udW1iZXIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdCA9IGtwYUV4aXN0UHJvamVjdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga3BhRXhpc3RQcm9qZWN0cy5zcGxpY2UoaSwxKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoa3BhUHJvamVjdCA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdCA9IG5ldyBLUEFQcm9qZWN0TW9kZWwoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5pc0VkaXRQcm9qZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGBTa2lwIFByb2plY3QgYmVjYXVzZSBvZiBDYW5ub3QgQWxsb3cgdG8gZWRpdCAke3Byb2plY3Quam9iTmFtZX1gKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMuc2tpcHBlZFJlY29yZCsrXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdC5uYW1lID0gcHJvamVjdC5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdC5jb2RlID0gcHJvamVjdC5wcm9qZWN0X251bWJlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QuaXNBY3RpdmUgPSBwcm9qZWN0LmFjdGl2ZVxuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdC5hZGRyZXNzID0gcHJvamVjdC5hZGRyZXNzO1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdC5jaXR5ID0gcHJvamVjdC5jaXR5O1xuICAgICAgICAgICAgICAgICAgICAgICAga3BhUHJvamVjdC5zdGF0ZSA9IHByb2plY3Quc3RhdGVfY29kZTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3QuemlwID0gcHJvamVjdC56aXA7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGtwYVByb2plY3RzLnB1c2goa3BhUHJvamVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMudXBzZXJ0UmVjb3JkKytcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIC8vU2VuZCBEYXRhXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1Y2Nlc3MgPSBhd2FpdCBrcGFQcm9qZWN0QVBJLnNhdmVQcm9qZWN0KHRoaXMuY29uZmlnLmtwYVNpdGUsIGtwYVByb2plY3RzKVxuICAgICAgICAgICAgICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIHNhdmUgUHJvamVjdHM6JyArIHRoaXMuY29uZmlnLmtwYVNpdGUpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG59XG4iXX0=